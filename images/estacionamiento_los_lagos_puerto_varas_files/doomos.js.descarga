////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// jQuery
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

var $ = jQuery.noConflict();

$(document).ready(function($) {
//(adsbygoogle = window.adsbygoogle || []).push({});

//remove
//sessionStorage.removeItem('userId');
//sessionStorage.setItem('userId', '321321');
//remove

//alert($(window).width() + " X " + $(window).height());

    var __JSON = "/json/";
    var __PAIS = "Chile";

    var location_path = window.location.pathname; // /a/b.html
    var location_href = window.location.href; // http://www.a.com/a/b.html



    var regiones_ac = [["2","Región de Antofagasta"],["15","Región de Arica y Parinacota"],["3","Región de Atacama"],["11","Región de Aysén del General Carlos Ibáñez del Campo"],["4","Región de Coquimbo"],["9","Región de la Araucanía"],["10","Región de Los Lagos"],["14","Región de Los Ríos"],["12","Región de Magallanes y la Antártica Chilena"],["1","Región de Tarapacá"],["5","Región de Valparaíso"],["8","Región del Bío-Bío"],["6","Región del Libertador General Bernardo O Higgins"],["7","Región del Maule"],["13","Región Metropolitana"]];
    var comunas_ac = [["44","5","Algarrobo"],["109","13","Alhue"],["302","3","Alto del Carmen"],["277","10","Ancud"],["22","4","Andacollo"],["216","9","Angól"],["7","2","Antofagasta"],["303","8","Antuco"],["198","8","Arauco"],["1","15","Arica"],["285","11","Aysén"],["180","8","Bulnes"],["103","13","Buín"],["56","5","Cabildo"],["208","8","Cabrero"],["10","2","Calama"],["265","10","Calbuco"],["14","3","Caldera"],["99","13","Calera de Tango"],["67","5","Calle Larga"],["295","15","Camarones"],["296","1","Camina"],["31","4","Canela"],["235","9","Carahue"],["46","5","Cartagena"],["40","5","Casablanca"],["270","10","Castro"],["63","5","Catemu"],["166","7","Cauquenes"],["201","8","Cañete"],["333","13","Cerrillos"],["324","13","Cerro Navia"],["280","10","Chaitén"],["167","7","Chanco"],["11","3","Chañaral"],["132","6","Chepica"],["344","8","Chiguayante"],["287","11","Chile Chico"],["168","8","Chillán"],["342","8","Chillán Viejo"],["125","6","Chimbarongo"],["271","10","Chonchi"],["286","11","Cisnes"],["175","8","Cobquecura"],["262","10","Cochamo"],["289","11","Cochrane"],["110","6","Codegua"],["186","8","Coelemu"],["170","8","Coihueco"],["114","6","Coinco"],["161","7","Colbún"],["297","1","Colchane"],["76","13","Colina"],["220","9","Collipulli"],["113","6","Coltauco"],["29","4","Combarbala"],["188","8","Concepción"],["75","13","Conchalí"],["340","5","Concón"],["157","7","Constitución"],["202","8","Contulmo"],["13","3","Copiapó"],["21","4","Coquimbo"],["194","8","Coronel"],["244","14","Corrál"],["284","11","Coyhaique"],["230","9","Cunco"],["276","10","Curacao de Veléz"],["225","9","Curacautín"],["83","13","Curacaví"],["197","8","Curanilahue"],["305","9","Curarrehue"],["1000","5","Curauma"],["155","7","Curepto"],["140","7","Curicó"],["279","10","Dalcahue"],["12","3","Diego de Almagro"],["112","6","Doñihue"],["338","13","El Bosque"],["185","8","El Carmen"],["89","13","El Monte"],["45","5","El Quisco"],["47","5","El Tabo"],["158","7","Empedrado"],["221","9","Ercilla"],["328","13","Estación Central"],["193","8","Florida"],["229","9","Freire"],["17","3","Freirina"],["268","10","Fresia"],["269","10","Frutillar"],["281","10","Futaleufú"],["248","14","Futrono"],["232","9","Galvarino"],["293","15","General Lagos"],["238","9","Gorbea"],["107","6","Graneros"],["309","11","Guaitecas"],["51","5","Hijuelas"],["308","10","Hualaihué"],["144","7","Hualañé"],["192","8","Hualqui"],["3","1","Huara"],["18","3","Huasco"],["334","13","Huechuraba"],["30","4","Illapel"],["330","13","Independencia"],["2","1","Iquíque"],["87","13","Isla de Maipo"],["41","5","Isla de Pascua"],["321","5","Juan Fernández"],["50","5","La Calera"],["96","13","La Cisterna"],["49","5","La Cruz"],["139","6","La Estrella"],["93","13","La Florida"],["97","13","La Granja"],["20","4","La Higuera"],["59","5","La Ligua"],["327","13","La Pintana"],["92","13","La Reina"],["19","4","La Serena"],["251","14","La Unión"],["254","14","Lago Ranco"],["312","11","Lago Verde"],["316","12","Laguna Blanca"],["210","8","Laja"],["78","13","Lampa"],["249","14","Lanco"],["116","6","Las Cabras"],["71","13","Las Condes"],["231","9","Lautaro"],["199","8","Lebu"],["145","7","Licantén"],["53","5","Limache"],["159","7","Linares"],["136","6","Litueche"],["267","10","Llanquihue"],["65","5","Llay Llay"],["332","13","Lo Barnechea"],["337","13","Lo Espejo"],["325","13","Lo Prado"],["129","6","Lolol"],["240","9","Loncoche"],["162","7","Longaví"],["226","9","Lonquimay"],["66","5","Los Andes"],["247","14","Los Lagos"],["264","10","Los Muermos"],["218","9","Los Sauces"],["33","4","Los Vilos"],["200","8","Los Álamos"],["204","8","Los Ángeles"],["195","8","Lota"],["223","9","Lumaco"],["106","6","Machalí"],["323","13","Macul"],["246","14","Mafil"],["94","13","Maipú"],["122","6","Malloa"],["134","6","Marchigue"],["245","14","Mariquina"],["298","2","María Elena"],["90","13","María Pinto"],["154","7","Maule"],["263","10","Maullín"],["8","2","Mejillones"],["304","9","Melipeuco"],["88","13","Melipilla"],["147","7","Molina"],["26","4","Monte Patria"],["214","8","Mulchen"],["212","8","Nacimiento"],["126","6","Nancagua"],["319","12","Navarino"],["138","6","Navidad"],["213","8","Negrete"],["174","8","Ninhue"],["52","5","Nogales"],["234","9","Nueva Imperial"],["120","6","Olivar"],["300","2","Ollagüe"],["54","5","Olmué"],["255","10","Osorno"],["25","4","Ovalle"],["310","11","O´Higgins"],["339","13","Padre Hurtado"],["345","9","Padre las Casas"],["24","4","Paihuano"],["252","14","Paillaco"],["104","13","Paine"],["282","10","Palena"],["130","6","Palmilla"],["250","14","Panguipulli"],["62","5","Panquehue"],["57","5","Papudo"],["133","6","Paredones"],["164","7","Parrál"],["336","13","Pedro Aguirre Cerda"],["152","7","Pelarco"],["320","7","Pelluhue"],["184","8","Pemuco"],["153","7","Pencahue"],["191","8","Penco"],["131","6","Peralillo"],["233","9","Perquenco"],["55","5","Petorca"],["115","6","Peumo"],["85","13","Peñaflor"],["322","13","Peñalolén"],["4","1","Pica"],["118","6","Pichidegua"],["137","6","Pichilemu"],["169","8","Pinto"],["101","13","Pirque"],["237","9","Pitrufquen"],["127","6","Placilla"],["171","8","Portezuelo"],["292","12","Porvenir"],["5","1","Pozo Almonte"],["317","12","Primavera"],["72","13","Providencia"],["36","5","Puchuncaví"],["242","9","Pucón"],["82","13","Pudahuel"],["100","13","Puente Alto"],["261","10","Puerto Montt"],["291","12","Puerto Natales"],["258","10","Puerto Octay"],["236","9","Puerto Saavedra"],["266","10","Puerto Varas"],["135","6","Pumanque"],["27","4","Punitaqui"],["290","12","Punta Arenas"],["274","10","Puqueldón"],["260","10","Purranque"],["217","9","Purén"],["61","5","Putaendo"],["294","15","Putre"],["256","10","Puyehue"],["272","10","Queilen"],["273","10","Quellón"],["278","10","Quemchi"],["215","8","Quilaco"],["79","13","Quilicura"],["206","8","Quillenco"],["48","5","Quillota"],["182","8","Quillón"],["38","5","Quilpué"],["275","10","Quinchao"],["123","6","Quinta de Tilcoco"],["81","13","Quinta Normal"],["35","5","Quintero"],["172","8","Quirihue"],["105","6","Rancagua"],["187","8","Ranquíl"],["143","7","Rauco"],["329","13","Recoleta"],["219","9","Reinaco"],["77","13","Renca"],["121","6","Rengo"],["119","6","Requinoa"],["165","7","Retiro"],["68","5","Rinconada"],["253","14","Rio Bueno"],["28","4","Rio Hurtado"],["141","7","Romerál"],["149","7","Río Claro"],["288","11","Río Ibáñez"],["259","10","Río Negro"],["314","12","Río Verde"],["148","7","Sagrada Familia"],["32","4","Salamanca"],["42","5","San Antonio"],["98","13","San Bernardo"],["176","8","San Carlos"],["151","7","San Clemente"],["69","5","San Esteban"],["178","8","San Fabián"],["60","5","San Felipe"],["124","6","San Fernando"],["111","6","San Francisco de Mostazal"],["315","12","San Gregorio"],["177","8","San Gregorio de Ñiquén"],["181","8","San Ignacio"],["156","7","San Javier"],["335","13","San Joaquín"],["102","13","San José de Maipo"],["307","10","San Juan de la Costa"],["95","13","San Miguel"],["179","8","San Nicolás"],["257","10","San Pablo"],["108","13","San Pedro"],["301","2","San Pedro de Atacama"],["343","8","San Pedro de la Paz"],["341","7","San Rafael"],["326","13","San Ramón"],["211","8","San Rosendo"],["117","6","San Vicente"],["205","8","Santa Bárbara"],["128","6","Santa Cruz"],["196","8","Santa Juana"],["64","5","Santa María"],["70","13","Santiago Centro"],["73","13","Santiago Oeste"],["84","13","Santiago Sur"],["43","5","Santo Domingo"],["299","2","Sierra Gorda"],["86","13","Talagante"],["150","7","Talca"],["189","8","Talcahuano"],["9","2","Taltal"],["227","9","Temuco"],["142","7","Teno"],["306","9","Teodoro Schmidt"],["15","3","Tierra Amarilla"],["80","13","Til-Til"],["318","12","Timaukel"],["203","8","Tirúa"],["6","2","Tocopilla"],["239","9","Toltén"],["190","8","Tomé"],["313","12","Torres del Paine"],["311","11","Tortél"],["222","9","Traiguen"],["173","8","Trehuaco"],["209","8","Tucapel"],["243","14","Valdivia"],["16","3","Vallenar"],["34","5","Valparaíso"],["146","7","Vichuquén"],["224","9","Victoria"],["23","4","Vicuña"],["228","9","Vilcún"],["163","7","Villa Alegre"],["39","5","Villa Alemana"],["241","9","Villarica"],["331","13","Vitacura"],["37","5","Viña del Mar"],["160","7","Yerbas Buenas"],["207","8","Yumbel"],["183","8","Yungay"],["58","5","Zapallar"],["91","13","Ñuñoa"]];

    var contact_serialize = "";

    function hidde_all_locale(form, select){
        $("#"+form+" #"+select).val("-1");
        $("#"+form+" #"+select+" option").each(function(){
            if($(this).attr("value") != "-1"){
                $(this).hide();
            }
        });
    }

    function show_locale_parent(form, select, parent){
        hidde_all_locale(form,select);
        $("#"+form+" #"+select+" option").each(function(){
            if($(this).attr("value") != "-1" && $(this).attr("data-parent") == parent){
                $(this).show();
            }
        });
    }
	
	function ckeck_modals(){
		if($('.modal.in, .modal.show').length > 0){
			return true;
		}else{
			return false;
		}
	}

    $(document).on('click','#sv-360', function(e){
        
        $("#tour-360-popup").find(".modal-body").html('<iframe src="'+$(this).attr("sv-data")+'" frameborder="0" style="border:0;width: 100%; height: 450px;" allowfullscreen=""></iframe>');
        $("#tour-360-popup").modal('show');
        
        return false;
    });
    
    $('#tour-360-popup').on("hidden.bs.modal", function () {            
        $("#tour-360-popup").find(".modal-body").html('');
    });
    

    if($(".rel-tours").exists()){
        
        $.getJSON(__JSON+"?action=rel-tours", function(response) {
            
            if(response["status"] == 200){
                $(".rel-tours").css("margin-top", "20px");
                $(".rel-tours").html(response["html"]);
            }
            
        });
        
    }

    
    /*if($("#doomosModal").exists()){ //proy_rel_popup $('#myModal').is(':visible');
        

        if($(window).width() > 970){
            $('#doomosModal').modal('show');
        }

        $("#doomosModal .close").click(function(e){
            $.getJSON(__JSON+"?action=doomosModalClose");
        });


        $("#form_news_search #location").autocomplete({
                        minLength: 3,
                        source: __JSON+"?action=autocomplete_city",
                        search  : function(){$("#form_news_search #loading_locale_news").css('display',"block"); },
                        open    : function(){$("#form_news_search #loading_locale_news").css('display',"none"); $('.ui-autocomplete').css('z-index', 9999); },
                        select: function(e,ui){
                            $(this).attr("data-value",ui["item"]["code"]);
                        }

        });


        $("#form_news_search").submit(function(e){

            $this = $(this);
            serialize = $this.serialize()+"&locale="+$("#form_news_search #location").attr("data-value");

            $this.css("display","none");
            $("#news-loading-search").css("display","block");
            $("#news-success-search").css("display","none");

            $.getJSON(__JSON+"?action=newsSearchPopup&"+serialize, function(r) {

                if(r["status"] == 200){
                    $("#news-loading-search").css("display","none");
                    $("#news-success-search").css("display","block");

                    setTimeout(function() {
                            $('#doomosModal').modal('hide');
                        }, 1500);

                }else{

                    $this.css("display","block");
                    $("#news-loading-search").css("display","none");
                    $("#news-success-search").css("display","none");

                    alert("No se ha podido ingresar su suscripcion, por favor revise el formulario");
                }

            });



            return false;
        });

    }*/

    if($("#cpcn-search-contact").exists() || $("#cpcn-dmnd-contact").exists()){

        function cpcn_validate($this){

            action = $this.attr("action");

            $this.find("#send-ok").css("display","none");
            $this.find("#send-fail").css("display","none");
            $this.find("#loading-form").css("display","block");
            $this.find("#button-send").css("display","none");
            $this.find("#send-fail-txt").css("display","none");
            $this.find("#send-fail-txt").html('');

            $.post( action, $this.serialize()+"&rand="+Math.random(), function(response, status) {

                if(response["status"] == 200){

                    $this.find("#form-content").css("display","none");
                    $this.find("#send-ok").css("display","block");
                    $this.find("#send-fail").css("display","none");
                    $this.find("#loading-form").css("display","none");
                    $this.find("#button-send").css("display","none");
                    $this.find("#send-fail-txt").css("display","none");

                }else{

                    $this.find("#form-content").css("display","block");
                    $this.find("#send-ok").css("display","none");
                    $this.find("#send-fail").css("display","block");
                    $this.find("#loading-form").css("display","none");
                    $this.find("#button-send").css("display","block");

                    if(typeof response["error"] != 'undefined'){
                        if(response["error"] != ""){
                            $this.find("#send-fail-txt").html(response["error"]);
                            $this.find("#send-fail-txt").css("display","block");
                        }
                    }

                    switch($this.find("#rcptchNmbr").val()){
                        case "3":  grecaptcha.reset(recaptcha3);
                            break;
                        case "4":  grecaptcha.reset(recaptcha4);
                            break;

                    }


                }

            }, "json");


        }

        $("#cpcn-search-contact").submit(function(e){

            $this = $(this);
            
            cpcn_validate($this);
            //console.log(formser);

            return false;
        });

        $("#cpcn-dmnd-contact").submit(function(e){

            $this = $(this);
            
            cpcn_validate($this);
            //console.log(formser);

            return false;
        });


    }

    if($(".dest-ads").exists()){

        $.post( __JSON+"?action=dest-ads", $("#form-filter-search").serialize()+"&rand="+Math.random(), function(response, status) {

            if(response["status"] == 200){
                $(".dest-ads").html(response["html"]);
            }

        }, "json");

    }

    if($("#form-contrata-new-plan").exists()){

        $('#plan').change(function () {

            var os = $(this).find("option:selected");

            dtc = os.attr("dtc");

            $(".new-plan-name").html(os.attr("name"));
            $(".new-plan-price").html(os.attr("price-format"));
            $(".new-plan-iva").html(os.attr("iva-format"));
            $(".new-plan-price-total").html(os.attr("price-total-format"));
            //$(".new-plan-month").html(os.attr("data-mes"));
            
            $("#price-total").val(os.attr("price-total"));

            if(dtc == "1"){
                $("#form-contrata-new-plan #submit").css("display","none");
                $("#form-contrata-new-plan #submit-info").css("display","block");
                $("#form-contrata-new-plan #info-price").css("display","none");
                $("#form-contrata-new-plan #facturacion-form").css("display","none");
            }else{
                $("#form-contrata-new-plan #submit").css("display","block");
                $("#form-contrata-new-plan #submit-info").css("display","none");
                $("#form-contrata-new-plan #info-price").css("display","block");
                $("#form-contrata-new-plan #facturacion-form").css("display","block");
            }


        });


    }


    if($("#form-contact-gsvt").exists()){

        //console.log("success");

        $("#form-contact-gsvt").submit(function(e){

            $this = $(this);
            ser = $this.serialize();

            $("#form-contact-gsvt #loading").css("display","block");
            $("#form-contact-gsvt #buton-send").css("display","none");
            $("#form-contact-gsvt #send-fail").css("display","none");
            $("#form-contact-gsvt #send-ok").css("display","none");

            $.post( __JSON+"?action=contact-sv", ser+"&rand="+Math.random(), function(response, status) {

                if(response["status"] == 200){
                    
                    $("#form-contact-gsvt #form-contact-content").css("display","none");
                    $("#form-contact-gsvt #loading").css("display","none");
                    $("#form-contact-gsvt #buton-send").css("display","none");
                    $("#form-contact-gsvt #send-ok").css("display","block");
                    
                }else{
                    
                    $("#form-contact-gsvt #form-contact-content").css("display","block");
                    $("#form-contact-gsvt #loading").css("display","none");
                    $("#form-contact-gsvt #buton-send").css("display","block");
                    $("#form-contact-gsvt #send-fail").css("display","block");
                    $("#form-contact-gsvt #send-ok").css("display","none");

                    grecaptcha.reset();
                    
                }

                    

            }, "json");

            return false;
        });

    }


    if($(".credito-simular").exists()){
        $(".credito-simular").click(function(e){
            $("#modal-simulador").modal('show');
            return false;
        });
        
    }
	
	if($('.info-tooltip').exists()){
		$('.info-tooltip').tooltip({
			template: '<div class="tooltip" role="tooltip" style="width:250px;"><div class="arrow"></div><div class="tooltip-inner"></div></div>'
		});
	}


    if($('#modal_map_sv').exists()){

        $(".tour-home").click(function(e){
            $('#modal_map_sv').modal('show');

            return false;
        });
        
    }

    $(".openstreet").click(function(e){
            var modelid = '#'+$(this).attr('modelid');
            $(modelid).modal('show');
            return false;
    });


    if($("#contact_emp_rel_locale").exists()){


        $("#contact_emp_rel_locale #region").change(function(e){
            show_locale_parent("contact_emp_rel_locale", "comuna", $(this).val());
        });

        $("#contact_emp_rel_locale #comuna").change(function(e){
            if($("#contact_emp_rel_locale #txtsub").val() == "1"){
                $("#contact_emp_rel_locale #message").val("Buenos días. \nEstoy buscando una propiedad para pago con subsidio en "+$("#contact_emp_rel_locale #comuna option:selected").text()+" "+$("#contact_emp_rel_locale #region option:selected").text());
            }
        });

        var errores_emp_rel = [];
        $("#contact_emp_rel_locale").submit(function(e){

            $("#contact_emp_rel_locale #form_content").css("display","none");
            $("#contact_emp_rel_locale #form-contact-emp-rel").css("display","none");
            $("#contact_emp_rel_locale #loading-form").css("display","block");
            $("#contact_emp_rel_locale #send-ok").css("display","none");
            //$("#emp_loc_popup #send-fail").css("display","none");

            if(errores_emp_rel.length > 0){
                for(i=0;i<errores_emp_rel.length;i++){
                    $("#contact_emp_rel_locale #"+errores_emp_rel[i]).parent().removeClass("has-error");
                }
            }

            $.getJSON(__JSON+"?action=contact-emp-rel-locale&"+$(this).serialize(), function(response) {

                if(response["status"] == 200){
                    $("#contact_emp_rel_locale #form_content").css("display","none");
                    $("#contact_emp_rel_locale #form_content2").css("display","none");
                    $("#contact_emp_rel_locale #send-ok").css("display","block");

					ga('send', 'pageview', "/contactoexitpopup");
					ga('send', 'pageview', "/contactosTotales");

                    setTimeout(function() {
                            $("#emp_loc_popup").modal('hide');
                        }, 1500);
                        

                }else{

                        if(typeof response["error"] != 'undefined'){
                            if(response["error"].length > 0){
                                for(i=0;i<response["error"].length;i++){
                                    $("#contact_emp_rel_locale #"+response["error"][i]).parent().addClass("has-error");
                                    errores_emp_rel.push(response["error"][i]);
                                }
                            }else{
                                if(response["msg"] != ""){
                                    alert(response["msg"]);
                                }else{
                                    alert("Ha ocurrido un error, intente nuevamente");
                                }
                            }
                        }else{
                            alert("Ha ocurrido un error, intente nuevamente");
                        }

                        $("#contact_emp_rel_locale #form_content").css("display","block");
                        $("#contact_emp_rel_locale #loading-form").css("display","none");
                        $("#contact_emp_rel_locale #form-contact-emp-rel").css("display","block");


                }

            });


            return false;
        });

    }

    if($("#contact_emp_rel_ep").exists()){

        var errores_emp_rel = [];
        $("#contact_emp_rel_ep").submit(function(e){

            $("#contact_emp_rel_ep #form-contact-emp-rel").css("display","none");
            $("#contact_emp_rel_ep #loading-form").css("display","block");
            $("#contact_emp_rel_ep #send-ok").css("display","none");
            //$("#emp_loc_popup #send-fail").css("display","none");

            if(errores_emp_rel.length > 0){
                for(i=0;i<errores_emp_rel.length;i++){
                    $("#"+errores_emp_rel[i]).parent().removeClass("has-error");
                }
            }

            $.getJSON(__JSON+"?action=contact-emp-rel&"+$(this).serialize(), function(response) {

                if(response["status"] == 200){
                    $("#contact_emp_rel_ep #form_content").css("display","none");
                    $("#contact_emp_rel_ep #form_content2").css("display","none");
                    $("#contact_emp_rel_ep #send-ok").css("display","block");
                    $("#contact_emp_rel_ep #loading-form").css("display","none");
                        
                }else{

                        if(typeof response["error"] != 'undefined'){
                            if(response["error"].length > 0){
                                for(i=0;i<response["error"].length;i++){
                                    $("#"+response["error"][i]).parent().addClass("has-error");
                                    errores_emp_rel.push(response["error"][i]);
                                }
                            }else{
                                if(response["msg"] != ""){
                                    alert(response["msg"]);
                                }else{
                                    alert("Ha ocurrido un error, intente nuevamente");
                                }
                            }
                        }else{
                            alert("Ha ocurrido un error, intente nuevamente");
                        }

                        $("#contact_emp_rel_ep #form-contact-emp-rel").css("display","block");
                        $("#contact_emp_rel_ep #loading-form").css("display","none");


                }

            });

            return false;

        });

    }


    if($(".notifys").exists()){

        $(".notifys > .notifys-list").each(function(){
            
            $this = $(this);

            $('.' + $this.attr("position")).notify({
              message: { html: $this.html() },
              type: $this.attr("type"),
              fadeOut: {
                enabled: true, delay: 15000
              }
            }).show();

                    
        });

    }


     function reset_wsp_cntct(){
        
        $(".chose-contact").css('display','block');
        $(".wsp-info").css('display','none');
        
        $(".chose-contact").attr("data-wsp","-1");
        $(".chose-contact").attr("wsp-type","-1");
        $(".chose-contact").attr("wsp-ad","-1");
        
        $("#form-wsp-contact").find("#data-wsp").val("-1");
        $("#form-wsp-contact").find("#wsp-type").val("-1");
        $("#form-wsp-contact").find("#wsp-ad").val("-1");
        
        $(".wsp-info").find("#send-ok").css("display","none");
        $(".wsp-info").find("#send-fail").css("display","none");
        $(".wsp-info").find("#wsp-loading-form").css("display","none");
        $(".wsp-info").find("#form-content").css("display","block");
        $(".wsp-info").find("#title").css("display","block");
        
        $(".wsp-info").find("#wsp-result").css("display","none");
        $(".wsp-info").find("#wsp-result").html("");
        
        $("#main-title").css("display","block");
        $("#wsp-title").css("display","none");
        
        $('#form-wsp-contact').trigger("reset");
        
        grecaptcha.reset(recaptcha5);
        
    }
    
    function popup_contact($this){
        
        pp = $this.attr("data-value").split("-");
        d = $this.attr("data-d");
        e = $this.attr("data-e");

        $("#contact-property-search").css("display","none");
        $("#contact-property-search #send-ok").css("display","none");
        $("#contact-property-search #send-fail").css("display","none");
        $("#contact-property-search #contact-data-div").css("display","none");
        $("#contact-property-search #contact-data").html("");
        $("#contact-property-search #dni-emp-property").css("display","none");
        $("#contact-property-search #property").val(pp[1]);
        $("#contact-property-search #form-contact-reply-submit").css("display","block");
        $("#contact-property-search #loading-form").css("display","none");
        $("#contact-property-search #name").parent().removeClass("has-error");
        $("#contact-property-search #email").parent().removeClass("has-error");
        $("#contact-property-search #phone").parent().removeClass("has-error");
        $("#contact-property-search #message").parent().removeClass("has-error");

        
        $("#contact-project-search").css("display","none");
        $("#contact-project-search #send-ok").css("display","none");
        $("#contact-project-search #send-fail").css("display","none");
        $("#contact-project-search #contact-data-div").css("display","none");
        $("#contact-project-search #contact-data").html("");
        $("#contact-project-search #dni-emp-project").css("display","none");
        $("#contact-project-search #ac-project").css("display","none");
        $("#contact-project-search #project").val(pp[0]);
        $("#contact-project-search #ac").val(0);
        $("#contact-project-search #model").val(pp[1]);
        $("#contact-project-search #loading_model").css("display", "none");
        $("#contact-project-search #model").html("");
        $("#contact-project-search #form-contact-reply-submit-project").css("display", "block");
        $("#contact-project-search #loading-form").css("display", "none");


        if(pp[0] != "0"){

            $('#contact-project-search').trigger("reset");
            $("#contact-project-search").css("display","block");

            if(e == "753"){

                $("#contact-project-search #comuna").html("<option value='-1'>Seleccione comuna</option>");

                $("#contact-project-search #ac-project").css("display","block");
                $("#contact-project-search #ac").val("1");

                if(!reg_add){
                    options_reg = "<option value='-1'>Seleccione región</option>";
                    $.each(regiones_ac, function(i,v){
                        options_reg = options_reg+"<option value='"+v[0]+"'>"+v[1]+"</option>";
                    });
                    $("#contact-project-search #region").html(options_reg);
                    reg_add = true
                }

            }

            $("#contact-project-search #loading_model").css("display", "block");


            if(d == 1){
                $("#contact-project-search #dni-emp-project").css("display","block");
            }

            $("#contact-project-search #form-content").css("display","block");
            $("#contact-property-search #property").val("-1");

            grecaptcha.reset(recaptcha1);


        }else{
            $('#contact-property-search').trigger("reset");
            $("#contact-property-search").css("display","block");
            if(d == 1){
                $("#contact-property-search #dni-emp-property").css("display","block");
            }
            $("#contact-property-search #form-content").css("display","block");
            $("#contact-project-search #project").val("-1");

            grecaptcha.reset(recaptcha2);

        }

        $("#contacto_busqueda").modal("show");
        
    }

    function popup_contact_pro_dest($this){
        
        pp = $this.attr("data-value").split("-");
        d = $this.attr("data-d");
        e = $this.attr("data-e");

        $("#contact-property-search").css("display","none");
        $("#contact-property-search #send-ok").css("display","none");
        $("#contact-property-search #send-fail").css("display","none");
        $("#contact-property-search #contact-data-div").css("display","none");
        $("#contact-property-search #contact-data").html("");
        $("#contact-property-search #dni-emp-property").css("display","none");
        $("#contact-property-search #property").val(pp[1]);
        $("#contact-property-search #form-contact-reply-submit").css("display","block");
        $("#contact-property-search #loading-form").css("display","none");
        $("#contact-property-search #name").parent().removeClass("has-error");
        $("#contact-property-search #email").parent().removeClass("has-error");
        $("#contact-property-search #phone").parent().removeClass("has-error");
        $("#contact-property-search #message").parent().removeClass("has-error");

        
        $("#contact-project-search").css("display","none");
        $("#contact-project-search #send-ok").css("display","none");
        $("#contact-project-search #send-fail").css("display","none");
        $("#contact-project-search #contact-data-div").css("display","none");
        $("#contact-project-search #contact-data").html("");
        $("#contact-project-search #dni-emp-project").css("display","none");
        $("#contact-project-search #ac-project").css("display","none");
        $("#contact-project-search #project").val(pp[0]);
        $("#contact-project-search #ac").val(0);
        /* $("#contact-project-search #model").val(pp[1]); */
        $("#contact-project-search #loading_model").css("display", "none");
        /* $("#contact-project-search #model").html(""); */
        $("#contact-project-search #form-contact-reply-submit-project").css("display", "block");
        $("#contact-project-search #loading-form").css("display", "none");


        if(pp[0] != "0"){

            $('#contact-project-search').trigger("reset");
            $("#contact-project-search").css("display","block");

            if(e == "753"){

                $("#contact-project-search #comuna").html("<option value='-1'>Seleccione comuna</option>");

                $("#contact-project-search #ac-project").css("display","block");
                $("#contact-project-search #ac").val("1");

                if(!reg_add){
                    options_reg = "<option value='-1'>Seleccione región</option>";
                    $.each(regiones_ac, function(i,v){
                        options_reg = options_reg+"<option value='"+v[0]+"'>"+v[1]+"</option>";
                    });
                    $("#contact-project-search #region").html(options_reg);
                    reg_add = true
                }

            }

            $("#contact-project-search #loading_model").css("display", "block");


            if(d == 1){
                $("#contact-project-search #dni-emp-project").css("display","block");
            }

            $("#contact-project-search #form-content").css("display","block");
            $("#contact-property-search #property").val("-1");

            grecaptcha.reset(recaptcha1);


        }else{
            $('#contact-property-search').trigger("reset");
            $("#contact-property-search").css("display","block");
            if(d == 1){
                $("#contact-property-search #dni-emp-property").css("display","block");
            }
            $("#contact-property-search #form-content").css("display","block");
            $("#contact-project-search #project").val("-1");

            /* grecaptcha.reset(recaptcha2); */

        }

        $("#contacto_pro_destacado").modal("show");
        
    }




    var reg_add = false;
    var $this_contact;
    $(document).on('click','.contact-search', function(e){
        
        $this_contact = $(this);
        
        if(typeof $this_contact.attr('data-wsp') != 'undefined'){
            reset_wsp_cntct();
            $(".chose-contact").attr("data-wsp",$this_contact.attr("data-wsp"));
            $(".chose-contact").attr("wsp-type",$this_contact.attr("wsp-type"));
            $(".chose-contact").attr("wsp-ad",$this_contact.attr("data-value"));
            $("#wsp-cntct").modal("show");
        }else{
            popup_contact($this_contact);
        }

        return false;
    });

    $(document).on('click','.contact-pro-dest', function(e){
        
        $this_contact = $(this);
        popup_contact_pro_dest($this_contact);
        
        /* if(typeof $this_contact.attr('data-wsp') != 'undefined'){
            reset_wsp_cntct();
            $(".chose-contact").attr("data-wsp",$this_contact.attr("data-wsp"));
            $(".chose-contact").attr("wsp-type",$this_contact.attr("wsp-type"));
            $(".chose-contact").attr("wsp-ad",$this_contact.attr("data-value"));
            $("#wsp-cntct").modal("show");
        }else{
            popup_contact($this_contact);
        } */

        /* return false; */
    });

    $(document).on('click', '.contact-chose', function(e){
        
        if($(this).attr("data-value") == "wsp"){
            
            $("#main-title").css("display","none");
            $("#wsp-title").css("display","block");
            $("#form-wsp-contact").find("#data-wsp").val($(".chose-contact").attr("data-wsp"));
            $("#form-wsp-contact").find("#wsp-type").val($(".chose-contact").attr("wsp-type"));
            $("#form-wsp-contact").find("#wsp-ad").val($(".chose-contact").attr("wsp-ad"));
            
            $(".chose-contact").css('display','none');
            $(".wsp-info").css('display','block');
            
        }else{
            $("#wsp-cntct").modal("hide");
            reset_wsp_cntct();
            popup_contact($this_contact);
        }
        
        return false;       
    });

    $(document).on('click', '#wsp-contact-detail', function(e){
        
        $("#wsp-cntct-detail").modal("show");
        
        return false;
    });

    $("#form-wsp-contact").submit(function(e){
        
        $this = $(this);
        
        $(".wsp-info").find("#send-ok").css("display","none");
        $(".wsp-info").find("#send-fail").css("display","none");
        $(".wsp-info").find("#wsp-loading-form").css("display","block");
        $(".wsp-info").find("#form-content").css("display","none");
        
        $.post( __JSON+"?action=wsp-cntct", $this.serialize()+"&rand="+Math.random(), function(response, status) {

                if(response["status"] == 200){
                    //$("#wsp-cntct").modal("hide");
                    
                    
                    if(response["html"] != ""){
                        $(".wsp-info").find("#wsp-loading-form").css("display","none");
                        $(".wsp-info").find("#title").css("display","none");
                        
                        $(".wsp-info").find("#wsp-result").css("display","block");
                        $(".wsp-info").find("#wsp-result").html(response["html"]);
                    }else{
                        $("#wsp-cntct").modal("hide");
                        $(".wsp-info").find("#wsp-loading-form").css("display","none");
                        reset_wsp_cntct();
                    }
                    
                    
                    window.open(response["redirect"], '_blank');
                    
                    
                }else{
                    
                    $(".wsp-info").find("#send-ok").css("display","none");
                    $(".wsp-info").find("#send-fail").css("display","block");
                    $(".wsp-info").find("#wsp-loading-form").css("display","none");
                    $(".wsp-info").find("#form-content").css("display","block");
                    
                    grecaptcha.reset(recaptcha5);

                }

            }, "json");
        
        return false;
    });


                $("#contact-project-search #region").change(function(e){
                    
                    options_comuna = "<option value='-1'>Seleccione comuna</option>";
                    
                    for(i=0;i<comunas_ac.length;i++){
                        if(comunas_ac[i][1] == $(this).val()){
                            options_comuna = options_comuna+"<option value='"+comunas_ac[i][2]+"'>"+comunas_ac[i][2]+"</option>";
                        }
                    }
                    $("#contact-project-search #comuna").html(options_comuna);

                });
    

    if($("#proyectos-relacionados-busqueda").exists()){

        var $pr_rel = $("#proyectos-relacionados-busqueda");

        if($pr_rel.css("display") == "block"){

            var p = $pr_rel.position();
            var m = parseInt($pr_rel.css('margin-top'));
            var w = $pr_rel.width();
            var y = $(document).scrollTop();

            var calc = parseInt(p.top)+m;

            if(y >= calc){
                $("#proyectos-relacionados-busqueda").next('#spc').css('height',$("#proyectos-relacionados-busqueda").css('height'));
                 $("#proyectos-relacionados-busqueda").css({position: 'fixed',top: '0', width: w+"px"});
            }

            $(document).scroll(function() {
                y = $(document).scrollTop();
                calc = parseInt(p.top)+m;
                if(y >= calc){
                    $("#proyectos-relacionados-busqueda").next('#spc').css('height',$("#proyectos-relacionados-busqueda").css('height'));
                    $("#proyectos-relacionados-busqueda").css({position: 'fixed',top: '0', width: w+"px"});
                }else{
                    $("#proyectos-relacionados-busqueda").next('#spc').css('height','0px');
                    $("#proyectos-relacionados-busqueda").css({position: 'static'});
                }
            });

        }

    }

    var inputs_error_project = [];
    $("#contact-project-search").submit(function(e){

        $this = $(this);

        $("#contact-project-search #send-fail").css("display","none");
        $("#contact-project-search #form-contact-reply-submit-project").css("display","none");
        $("#contact-project-search #loading-form").css("display","block");

        if(inputs_error_project.length > 0){
            for(i=0;i<inputs_error_project.length;i++){
                $("#contact-project-search #"+inputs_error_project[i]).parent().removeClass("has-error");
            }
        }

        inputs_error_project = [];


        $.getJSON(__JSON+"?action=contact-project&"+$this.serialize(), function(response) { 

            if(response["status"] == 200){

                $("#contact-project-search #send-ok").css("display","block");
                $("#contact-project-search #form-content").css("display","none");

				ga('send', 'pageview', "/contactoproyectobusqueda");
				ga('send', 'pageview', "/contactosTotales");

            }else{

                if(typeof response["errores"] != 'undefined'){
                    if(response["errores"].length > 0){
                        for(i=0;i<response["errores"].length;i++){
                            $("#contact-project-search #"+response["errores"][i]).parent().addClass("has-error");
                            inputs_error_project.push(response["errores"][i]);
                        }
                    }
                }

                $("#contact-project-search #send-fail").css("display","block");
                $("#contact-project-search #form-contact-reply-submit-project").css("display","block");
                $("#contact-project-search #loading-form").css("display","none");

                
                grecaptcha.reset(recaptcha1);

            }

        });

        return false;
    });

    var inputs_error = [];
    $("#contact-property-search").submit(function(e){

        $this = $(this);

        $("#contact-property-search #send-fail").css("display","none");
        $("#contact-property-search #form-contact-reply-submit").css("display","none");
        $("#contact-property-search #loading-form").css("display","block");
		
		if($("#contact-property-search #send-fail").exists()){
			$("#contact-property-search #send-fail").css("display","none");
			$("#contact-property-search #send-fail").html("");
		}

        if(inputs_error.length > 0){
            for(i=0;i<inputs_error.length;i++){
                $("#contact-property-search #"+inputs_error[i]).parent().removeClass("has-error");
            }
        }

        $.getJSON(__JSON+"?action=contact-property&"+$this.serialize(), function(response) { 

            if(response["status"] == 200){

                $("#contact-property-search #send-ok").css("display","block");
                $("#contact-property-search #form-content").css("display","none");

				ga('send', 'pageview', "/contactopropiedadbusqueda");
				ga('send', 'pageview', "/contactosTotales");

            }else{

                if(typeof response["errores"] != 'undefined'){
                    if(response["errores"].length > 0){
                        for(i=0;i<response["errores"].length;i++){
                            $("#contact-property-search #"+response["errores"][i]).parent().addClass("has-error");
                            inputs_error.push(response["errores"][i]);
                        }
                    }
                }
				
				if(typeof response["errores-txt"] != 'undefined' && $("#contact-property-search #send-fail").exists()){
					if(response["errores-txt"] != ""){
						$("#contact-property-search #send-fail").html(response["errores-txt"]);
						$("#contact-property-search #send-fail").css("display","block");
					}
				}

                $("#contact-property-search #send-fail").css("display","block");
                $("#contact-property-search #form-contact-reply-submit").css("display","block");
                $("#contact-property-search #loading-form").css("display","none");
				

                grecaptcha.reset(recaptcha2);

            }



        });

        return false;
    });





    if($("#nav-search-detail").exists()){

        var $se_detail = $("#nav-search-detail");

        if($se_detail.css("display") == "block"){

            var ps = $se_detail.position();
            var ms = parseInt($se_detail.css('margin-top'));
            var ys = $(document).scrollTop();
            var calcs = parseInt(ps.top)+ms;
            if(ys >= calcs){
                $("#nav-search-detail").next('#spcm').css('height',$("#nav-search-detail").css('height'));
                $("#nav-search-detail").css({'position': 'fixed', 'top': '0px', 'z-index': '9999', 'width': '100%'});
            }

            $(document).scroll(function() {
                ys = $(document).scrollTop();
                calcs = parseInt(ps.top)+ms;
                if(ys >= calcs){
                    $("#nav-search-detail").next('#spcm').css('height',$("#nav-search-detail").css('height'));
                    $("#nav-search-detail").css({'position': 'fixed', 'top': '0px', 'z-index': '9999', 'width': '100%'});
                }else{
                    $("#nav-search-detail").next('#spcm').css('height','0px');
                    $("#nav-search-detail").css({position: 'static'});
                }
            });

        }

    }

    if($("#nav-search-detail-d").exists()){

        var $se_detaild = $("#nav-search-detail-d");

        if($se_detaild.css("display") == "block"){

            var psd = $se_detaild.position();
            var msd = parseInt($se_detaild.css('margin-top'));
            var ysd = $(document).scrollTop();
            var calcsd = parseInt(psd.top)+msd;
            if(ysd >= calcsd){
                $("#nav-search-detail-d").next('#spc').css('height',$("#nav-search-detail-d").css('height'));
                $("#nav-search-detail-d").css({'position': 'fixed', 'top': '0px', 'background': '#FFF', 'z-index': '99', 'width': '100%'});
            }

            $(document).scroll(function() {
                ysd = $(document).scrollTop();
                calcsd = parseInt(psd.top)+msd;
                if(ysd >= calcsd){
                    $("#nav-search-detail-d").next('#spc').css('height',$("#nav-search-detail-d").css('height'));
                    $("#nav-search-detail-d").css({'position': 'fixed', 'top': '0px', 'background': '#FFF', 'z-index': '99', 'width': '100%'});
                }else{
                    $("#nav-search-detail-d").next('#spc').css('height','0px');
                    $("#nav-search-detail-d").css({position: 'static'});
                }
            });

        }

    }



    if($("div.lazy").exists()){
        $("div.lazy").lazyload({
           effect : "fadeIn"
         });
    }

    if($('.fancybox').exists()){
        $('.fancybox').fancybox();
    }

    if($('#fb-button').exists() || $('#fb-button-lgn').exists() || $('#fb-button-search').exists() || $('#fb-button-map-search').exists() || $('#fb-button_call').exists()){

    var click_button = 0;
    var url_return = "";

    function fb_conect_data(){

        if(click_button == 1){
			
			if($('#fb-button').exists()){
				$('#loading-fb').css('display',"none");
			}
			
			if($('#fb-button-lgn').exists()){
				$('#loading-fb-lgn').css('display',"none");
			}
                        
			if($('#fb-button-search').exists()){
				$('#loading-fb-lgn').css('display',"none");
			}
                        
			if($('#fb-button-map-search').exists()){
				$('#loading-fb-lgn').css('display',"none");
			}
                        
			if($('#fb-button_call').exists()){
				$('#loading-fb_call').css('display',"none");
			}
            
			if($('#loading-fb').exists()){
				$('#loading-fb').css('display',"block");
			}
			
			if($('#loading-fb-lgn').exists()){
				$('#loading-fb-lgn').css('display',"block");
			}
                        
			if($('#loading-fb-search').exists()){
				$('#loading-fb-lgn').css('display',"block");
			}
                        
                        if($('#loading-fb_call').exists()){
				$('#loading-fb_call').css('display',"block");
			}
			
			
            FB.api('/me', {fields: ['id','email','first_name','last_name','gender','link']}, function(response) {

              ser = [];
              $.each(response, function( i, v ) {
                  ser.push( i + "=" + v );
                });

              
                   $.getJSON(__JSON+"?action=login-fb&"+ser.join("&"), function(r) {
                       //console.log(r['userId']);
                        sessionStorage.removeItem('userId');
                        sessionStorage.setItem('userId', r['userId']);
                        if(r["status"] == 200){

                            if(url_return != ""){

                                self.location.href=url_return;

                            }else{

                                //if(r["redirect"] != ""){
                                //    self.location.href=r["redirect"];
                                //}else{
                                    self.location.href="/user";
                                //}

                            }
                            
                        }else{
							
							if($('#fb-button').exists()){
								$('#fb-button').css('display',"block");
							}
							
							if($('#fb-button-lgn').exists()){
								$('#fb-button').css('display',"block");
							}
                                                        
							if($('#fb-button-search').exists()){
								$('#fb-button-search').css('display',"block");
							}
			
							if($('#fb-button-map-search').exists()){
								$('#fb-button-map-search').css('display',"block");
							}
                                                        
                                                        if($('#fb-button_call').exists()){
								$('#fb-button_call').css('display',"block");
							}
			
                            alert("Ha ocurrido un error, intente nuevamente");
                        }

 						if($('#loading-fb').exists()){
							$('#loading-fb').css('display',"none");
						}
						
						if($('#loading-fb-lgn').exists()){
							$('#loading-fb-lgn').css('display',"none");
						}

                   });

                                
            });

         }

    }


    function checkLoginState() {

          FB.getLoginStatus(function(response) {
            
                if(response.status == "connected"){
                    fb_conect_data();
                }

                //descomentar cuando se haya revisado.
                //$('#fb-button').css('display',"block");
				
				/*if($('#fb-button').exists()){
					$('#fb-button').css('display',"block");
				}
				
				if($('#fb-button-lgn').exists()){
					$('#fb-button-lgn').css('display',"block");
				}
                                
				if($('#fb-button-search').exists()){
					$('#fb-button-search').css('display',"block");
				}
                                
				if($('#fb-button-map-search').exists()){
					$('#fb-button-map-search').css('display',"block");
				}
                                
                                if($('#fb-button_call').exists()){
					$('#fb-button_call').css('display',"block");
				}*/

          });
    }

    function updateStatusCallback(response){
         FB.login(function(response) {
           
            if(response.status == "connected"){
                fb_conect_data();
            }

         }, {scope: 'public_profile,email'});
    }

    $.ajaxSetup({ cache: true });
      $.getScript('//connect.facebook.net/en_US/sdk.js', function(){
        FB.init({
          appId: '112080312215760',
          version: 'v2.5' // or v2.0, v2.1, v2.2, v2.3
        });     
        
        FB.getLoginStatus(checkLoginState);

      });




       $('#fb-button').click(function(e){
            url_return = $(this).attr("data-value");
            click_button = 1;
            updateStatusCallback();

       });
       
       $('#fb-button-lgn').click(function(e){
            click_button = 1;
            updateStatusCallback();
       });
           
       $('#fb-button-search').click(function(e){
            click_button = 1;
            url_return = $(this).attr("data-value");
            updateStatusCallback();
       });
       
       $('#fb-button-map-search').click(function(e){
            click_button = 1;
            url_return = $('#listParamsForSearch').attr('href').replace('search', 'map-vista');
            //url_return = $(this).attr("data-value");
            updateStatusCallback();
       });
       
       $('#fb-button_call').click(function(e){
            url_return = $(this).attr("data-value");
            click_button = 1;
            updateStatusCallback();
       });
       

    }


    if($("#form-confirm-user-facebook").exists()){

        var errores = [];
        $("#form-confirm-user-facebook").submit(function(e){

            $("#button-reg-fb").css("display","none");
            $("#loading-fb").css("display","block");
            $("#success").css("display", "none");
            $("#fail").css("display", "none");

            if(errores.length > 0){
                for(i=0;i<errores.length;i++){
                    $("#"+v).parent().removeClass("has-error");
                }
                errores = [];
            }
            
            

            $.getJSON(__JSON+"?action=sign-fb&"+$(this).serialize(), function(response){

                if(response["status"] == 200){

                    if(response["redirect"] != ""){
                        self.location.href=response["redirect"];
                    }else{
                        $("#success").html("<strong>Registro exitoso. Hemos enviado un correo con una url para poder activar tu cuenta.</strong>");
                        $(".form_content").css("display","none");
                        $("#success").css("display", "block");
                    }

                    
                }else{
                    if(response["register"] == 1){
                        $("#fail").html("<strong>El usuario ya se encuentra registrado, para recuperar tu contraseña haz click <a href='/login?forgot=1'>aqui</a></strong>");
                    }else{

                        if(typeof response["errores"] != 'undefined'){
                            if(response["errores"].length > 0){
                                for(i=0;i<response["errores"].length;i++){
                                    $("#"+response["errores"][i]).parent().addClass("has-error");
                                    errores.push(response["errores"][i]);
                                }
                            }
                        }

                        $("#fail").html("<strong>Ha ocurrido un error, intente nuevamente</strong>");
                    }

                    $("#fail").css("display", "block");
                }

                $("#button-reg-fb").css("display","block");
                $("#loading-fb").css("display","none");

            });

            return false;
        });

    }


    if($("#buy-pack").exists()){

        $(document).on('click','#buy-pack', function(e){

            $this = $(this);
            code = $this.attr("data-value");
            dl = $this.attr("dl");
            text = $this.text();

            $this.text("Cargando..");

            if(dl == "1"){

                $.getJSON(__JSON+"?action=comprar-pack&code="+code, function(response) {
                    if(response["status"] == 200){
                        self.location.href=response["redirect"];
                    }else{
                        alert("Ha ocurrido un error, intente nuevamente");
                        $this.text(text);
                    }

                     
                });

            }else{
                self.location.href="/login?s=pack&c="+code;
            }

        });


    }

    if($("#prop_rel_contact").exists()){

        //$("#prop_rel_contact").modal('show');

        var cont = $("#cont-rel-contact").val();
        
        $(document).on('click','#contact-now', function(e){

            $this = $(this);
            p = $this.attr("data-value");

            if(contact_serialize != ""){

                $this.css("display","none");
                $("#loading-form-"+p).css("display","block");

                $.getJSON(__JSON+"?action=contact-property-popup-detail&"+contact_serialize+"&pcode="+p, function(response) {

                    if(response["status"] == 200){

                        $this.parent().parent().parent().fadeOut();
                        cont = cont-1;

                        if(cont == 0){
                            $("#prop_rel_contact").modal('hide');
                        }

						sep = p.split("-");

						if(parseInt(sep[1]) > 0){
							ga('send', 'pageview', "/contactoproyectorelacionado");
						}else{
							ga('send', 'pageview', "/contactopropiedadrelacionada");
						}
						
						ga('send', 'pageview', "/contactosTotales");

						

                    }else{
                        $this.css("display","block");
                        $("#loading-form-"+p).css("display","none");

                        alert("Ha ocurrido un error, intente nuevamente");
                    }

                });

            }else{
                alert("Ha ocurrido un error, intente nuevamente");
            }


            return false;
        });

    }


    if($("#page-content-search").exists() || $("#page-property-content").exists()){


        var open_exit = false;
        $(document).mousemove(function(e) {
        var scroll_page = $(this).scrollTop();
        page_exit = (scroll_page+20);
            
            if(e.pageY <= page_exit && !open_exit){

                ok = true;
                if($("#doomosModal").exists()){
                    if($("#doomosModal").is(':visible')){
                        ok = false;
                    }
                } 

                if(ok && !ckeck_modals()){
                    if($("#emp_loc_popup").exists()){
                        $("#emp_loc_popup").modal('show');
                    }

                    if($("#proy_rel_popup").exists()){
                        $("#proy_rel_popup").modal('show');
                    }
                
                 open_exit=true;   
                }

            }

        });


        if($("#contact_proy_rel").exists()){

            $("#contact_proy_rel #model").change(function(e){
                $("#contact_proy_rel #model_image").attr("src",$('option:selected', this).attr('data-img'));
            });

            if($("#contact_proy_rel #region").exists()){

                options_reg = "<option value='-1'>Seleccione región</option>";
                $.each(regiones_ac, function(i,v){
                    options_reg = options_reg+"<option value='"+v[0]+"'>"+v[1]+"</option>";
                });
                $("#contact_proy_rel #region").html(options_reg);

                $("#contact_proy_rel #region").change(function(e){
                    
                    options_comuna = "<option value='-1'>Seleccione comuna</option>";
                    
                    for(i=0;i<comunas_ac.length;i++){
                        if(comunas_ac[i][1] == $(this).val()){
                            options_comuna = options_comuna+"<option value='"+comunas_ac[i][2]+"'>"+comunas_ac[i][2]+"</option>";
                        }
                    }
                    $("#contact_proy_rel #comuna").html(options_comuna);

                });

            }

        }

        var errores_proy = [];
        $("#contact_proy_rel").submit(function(e){

            $("#button-exit-proy").css("display","none");
            $("#loading-form-exit-proy").css("display","block");
            $("#send-ok-exit-proy").css("display","none");

            if(errores_proy.length > 0){
                for(i=0;i<errores_proy.length;i++){
                    $("#"+errores_proy[i]).parent().removeClass("has-error");
                }
                errores_proy = [];
            }

            $.getJSON(__JSON+"?action=contact-project-exit-popup&"+$(this).serialize(), function(response) {
                    
                if(response["status"] == 200){
                    $("#form_content-exit-proy").css("display","none");
                    $("#form_content2-exit-proy").css("display","none");
                    $("#send-ok-exit-proy").css("display","block");

					ga('send', 'pageview', "/contactoproyectorelacionado");
					ga('send', 'pageview', "/contactosTotales");

                    setTimeout(function() {
                            $("#proy_rel_popup").modal('hide');
                        }, 1500);
                        

                }else{

                        if(typeof response["errores"] != 'undefined'){
                            if(response["errores"].length > 0){
                                for(i=0;i<response["errores"].length;i++){
                                    $("#"+response["errores"][i]).parent().addClass("has-error");
                                    errores_proy.push(response["errores"][i]);
                                }
                            }else{
                                    alert("Ha ocurrido un error, intente nuevamente");
                            }
                        }else{
                            alert("Ha ocurrido un error, intente nuevamente");
                        }

                        $("#button-exit-proy").css("display","block");
                        $("#loading-form-exit-proy").css("display","none");


                }

            });

            return false;

        });

        var errores_emp_rel = [];
        $("#contact_emp_rel").submit(function(e){

            $("#contact_emp_rel #form-contact-emp-rel").css("display","none");
            $("#contact_emp_rel #loading-form").css("display","block");
            $("#contact_emp_rel #send-ok").css("display","none");
            //$("#emp_loc_popup #send-fail").css("display","none");

            if(errores_emp_rel.length > 0){
                for(i=0;i<errores_emp_rel.length;i++){
                    $("#contact_emp_rel #"+errores_emp_rel[i]).parent().removeClass("has-error");
                }
            }

            $.getJSON(__JSON+"?action=contact-emp-rel&"+$(this).serialize(), function(response) {

                if(response["status"] == 200){
                    $("#contact_emp_rel #form_content").css("display","none");
                    $("#contact_emp_rel #form_content2").css("display","none");
                    $("#contact_emp_rel #send-ok").css("display","block");
                    $("#contact_emp_rel #loading-form").css("display","none");
					ga('send', 'pageview', "/contactoexitpopup");
					ga('send', 'pageview', "/contactosTotales");
if($('#showDemands').parent().hasClass('checked')){ // checked
/* DEMA DSECOND STEP */
     var d_email = $('#contact_emp_rel #email').val();
     var d_phone = $('#contact_emp_rel #phone').val();
     
     
     var d_userid = '';
     if(d_email == '' || d_phone == ''){
         var cual= this;
            setTimeout(function(){ $(cual).iCheck('uncheck');}, 1);
     }
     if(d_email == ''){
         $('#contact_emp_rel #email').parent().addClass('has-error');
         return false;
     }else{$('#contact_emp_rel #email').parent().removeClass('has-error');}
     
     if(d_phone == ''){
         $('#contact_emp_rel #phone').parent().addClass('has-error');
         return false;
     }else{$('#contact_emp_rel #phone').parent().removeClass('has-error');}
     
     
         
     
     $('#contact_emp_rel_d #d_email').val(d_email);
     $('#contact_emp_rel_d #d_phone').val(d_phone);
     $('#contact_emp_rel').hide();
     $('#contact_emp_rel_d').show();
     
     var confirm_user_id = 0;
     var exist_user_id = 0;
     if($('#d_userid').val() != ''){ // logged in
         exist_user_id = $('#d_userid').val();
          /* initlaentry of demand */
                                var d_url = "?action=contact-emp-rel-locale_d_insert&usuario_id="+exist_user_id+"&usuario_confirmar_id="+confirm_user_id+"&locale-rel="+$('#contact_emp_rel_d #d_locale').val()+"&operation="+$('#contact_emp_rel_d #d_operation').val()+"&types="+$('#contact_emp_rel_d #d_types').val();
                                $.getJSON(__JSON+d_url, function(response) {
                                    $('#contact_emp_rel_d #d_demand_id').val(response['last_demand_id']);
                                    $('#contact_emp_rel_d #d_demand_ea_id').val(response['last_demand_ea_id']);
                                });
                          /* initlaentry of demand */
         $('#demandsTitle').html('También es importante que complete la siguiente información que nos ayudará a ayudarlo de manera más efectiva.');
     }else{ // not logged in
         $.getJSON(__JSON+"?action=user-email-check&email="+d_email, function(response) { 
                if(response == 'no'){ // register new or get from confirmar
                    $.getJSON(__JSON+"?action=user-confirmr-email-check&"+"email="+d_email, function(response) {
                       if(response == 'no'){ // create new user
                           /* REGISTER NEW USER */
                            var pass = randomString(10);
                            var uname = 'doomos_user_'+randomStringSimple(5);
                           $.getJSON(__JSON+"?action=registro_particular_popup&"+"name="+uname+"&pass-1="+pass+"&pass-2="+pass+"&email="+d_email, function(response) {
                              if(response['confirm_user_id'] !== null){
                                 confirm_user_id = response['confirm_user_id'];
                                 /* initlaentry of demand */
                                       var d_url = "?action=contact-emp-rel-locale_d_insert&usuario_id="+exist_user_id+"&usuario_confirmar_id="+confirm_user_id+"&locale-rel="+$('#contact_emp_rel_d #d_locale').val()+"&operation="+$('#contact_emp_rel_d #d_operation').val()+"&types="+$('#contact_emp_rel_d #d_types').val();
                                       $.getJSON(__JSON+d_url, function(response) {
                                           $('#contact_emp_rel_d #d_demand_id').val(response['last_demand_id']);
                                           $('#contact_emp_rel_d #d_demand_ea_id').val(response['last_demand_ea_id']);
                                       });
                                 /* initlaentry of demand */
                               $('#contact_emp_rel_d #d_user_confirm_id').val(response['confirm_user_id']);
                              }
                               /* REGISTER NEW USER */   
                           });
                           $('#demandsTitle').html('Felicitaciones: ha sido registrado en nuestro sistema con su correo electrónico, acceda a su bandeja de entrada para activar su cuenta; También es importante que complete la siguiente información que nos ayudará a ayudarlo de manera más efectiva.');
                       }
                       else{
                           //console.log(response);
                            confirm_user_id = response;
                            /* initlaentry of demand */
                                var d_url = "?action=contact-emp-rel-locale_d_insert&usuario_id="+exist_user_id+"&usuario_confirmar_id="+confirm_user_id+"&locale-rel="+$('#contact_emp_rel_d #d_locale').val()+"&operation="+$('#contact_emp_rel_d #d_operation').val()+"&types="+$('#contact_emp_rel_d #d_types').val();
                                $.getJSON(__JSON+d_url, function(response) {
                                    $('#contact_emp_rel_d #d_demand_id').val(response['last_demand_id']);
                                    $('#contact_emp_rel_d #d_demand_ea_id').val(response['last_demand_ea_id']);
                                    $('#contact_emp_rel_d #d_user_confirm_id').val(confirm_user_id);
                                });
                            /* initlaentry of demand */
                            $('#demandsTitle').html('Hemos identificado su email y asociado su demanda. Es importante completar la información para ayudarle de manera más efectiva.');
                          }
                        /* REGISTER NEW USER */   
                    });
                }
                else{ // exists
                    exist_user_id = response;
                    /* initlaentry of demand */
                        var d_url = "?action=contact-emp-rel-locale_d_insert&usuario_id="+exist_user_id+"&usuario_confirmar_id="+confirm_user_id+"&locale-rel="+$('#contact_emp_rel_d #d_locale').val()+"&operation="+$('#contact_emp_rel_d #d_operation').val()+"&types="+$('#contact_emp_rel_d #d_types').val();
                        $.getJSON(__JSON+d_url, function(response) {
                            $('#contact_emp_rel_d #d_demand_id').val(response['last_demand_id']);
                            $('#contact_emp_rel_d #d_demand_ea_id').val(response['last_demand_ea_id']);
                        });
                    /* initlaentry of demand */
                    $('#demandsTitle').html('Hemos identificado su email y asociado su demanda. Es importante completar la información para ayudarle de manera más efectiva.');
                }
         });
    }
    
     var d_operation = $('#d_operation').val();
                   //$('#form_content').hide();
                   if(d_operation == 1 || d_operation == 3 || d_operation == 4 || d_operation == 7){
                       $('#dimands_content').show();
                       $('#demands_rent').show();
                   }else{
                       $('#dimands_content').show();
                       $('#demands_rent').hide();
                   }
/* DEMA DSECOND STEP */ 
}else{ // not checked
                    setTimeout(function() {
                            $("#emp_loc_popup").modal('hide');
                        }, 2000);
}
return false;
                       

                }else{

                        if(typeof response["error"] != 'undefined'){
                            if(response["error"].length > 0){
                                for(i=0;i<response["error"].length;i++){
                                    $("#contact_emp_rel #"+response["error"][i]).parent().addClass("has-error");
                                    errores_emp_rel.push(response["error"][i]);
                                }
                            }else{
                                if(response["msg"] != ""){
                                    alert(response["msg"]);
                                }else{
                                    alert("Ha ocurrido un error, intente nuevamente");
                                }
                            }
                        }else{
                            alert("Ha ocurrido un error, intente nuevamente");
                        }

                        $("#contact_emp_rel #form-contact-emp-rel").css("display","block");
                        $("#contact_emp_rel #loading-form").css("display","none");


                }

            });
            
        $.getJSON('/json/countries.json', function(response){
            $.each(response,function(index,response){
                if(response == 'Chile'){
                    $('#d_nationality').append($("<option></option>").attr({"value": response, "selected":"selected"}).text(response));
                }
                else{
                    $('#d_nationality').append($("<option></option>").attr("value", response).text(response));
                 }
            });     
        });

            return false;

        });



    }



    if($("#contact-form-popup").exists()){

        var errores_contact = new Array();
        $("#contact-form-popup").submit(function(e){

            $("#contact-form-popup #submit").css("display","none");
            $("#contact-form-popup #loading").css("display","block");

            if(errores_contact.length > 0){
                for(i=0;i<errores_contact.length;i++){
                    $("#"+errores_contact[i]).parent().removeClass("has-error");
                }
            }

             $.getJSON(__JSON+"?action=contact-form-popup&"+$(this).serialize(), function(response) {

                    if(response["status"] == 200){

                        $("#contact-form-popup #form-contact").css("display","none");
                        $("#contact-form-popup #mensaje-enviado").css("display","block");

                         setTimeout(function() {
                            $("#contactFormBBox").slideUp("slow");
                            $('#maskBBox').fadeOut(1000);
                        }, 1500);
                        

                    }else{
                        if(typeof response["error"] != 'undefined'){
                            if(response["error"].length > 0){
                                for(i=0;i<response["error"].length;i++){
                                    $("#"+response["error"][i]).parent().addClass("has-error");
                                    errores_contact.push(response["error"][i]);
                                }
                            }
                        }else{
                            alert("Ha ocurrido un error, intente nuevamente");
                        }

                        $("#contact-form-popup #submit").css("display","block");
                        $("#contact-form-popup #loading").css("display","none");
                    }

             });



            return false;
        });


    }


    if($("#mejorar-doomos").exists()){

        var errores_mejorar = new Array();
        $("#mejorar-doomos").submit(function(e){

            $("#mejorar-doomos #submit").css("display","none");
            $("#mejorar-doomos #loading").css("display","block");

            if(errores_mejorar.length > 0){
                for(i=0;i<errores_mejorar.length;i++){
                    $("#"+errores_mejorar[i]).parent().removeClass("has-error");
                }
            }


            if($("#star-value").val() == "0"){
                alert("Te faltó calificarnos. Selecciona la cantidad de estrellas");
                $("#mejorar-doomos #submit").css("display","block");
                $("#mejorar-doomos #loading").css("display","none");

            }else{

                $.getJSON(__JSON+"?action=ayuda-mejorar&"+$(this).serialize(), function(response) {

                    if(response["status"] == 200){

                        $("#mejorar-doomos #form-contact").css("display","none");
                        $("#mejorar-doomos #mensaje-enviado").css("display","block");

                        setTimeout(function() {
                            $("#login-modal-ayudanos").modal("hide");
                        }, 1500);

                        

                    }else{
                        if(typeof response["error"] != 'undefined'){
                            if(response["error"].length > 0){
                                for(i=0;i<response["error"].length;i++){
                                    $("#"+response["error"][i]).parent().addClass("has-error");
                                    errores_mejorar.push(response["error"][i]);
                                }
                            }
                        }else{
                            alert("Ha ocurrido un error, intente nuevamente");
                        }

                        $("#mejorar-doomos #submit").css("display","block");
                        $("#mejorar-doomos #loading").css("display","none");
                    }

                    

                });

            } 

            return false;
        });

        $("#stars-mejorar > a").click(function(e){

            $this = $(this);

             value = parseInt($this.attr("data-value"));

            $("#stars-mejorar > a").each(function(){
                val = parseInt($(this).attr("data-value"));

                if(val <= value){
                    if($(this).hasClass("active")){
                        $(this).removeClass("active");
                    }

                    $(this).addClass("active");
                }else{
                    $(this).removeClass("active");
                }

            });

            $("#star-value").val(value);

            return false;

        });


    }


    $(document).on('click','.button-currencys', function(e){

        $this = $(this);

        $("."+$this.attr("data-id")).text($this.attr("data-value"));

        $("."+$this.attr("data-ul")+" > li").each(function(){
                $(this).removeClass($this.attr("data-active"));
            });

        $this.addClass($this.attr("data-active"));

    });



    if($("#form-dest-property-sample").exists()){ 


        function set_dest_salt($this, t){

            val = $this.val();
            dclass = $this.attr("data-class");
            dvalue = $this.attr("data-value");
            currency = $this.attr("data-curr");

            curr = "USD";
            symbol = "US$ ";
            decimal = ",";
            miles = ".";

            if(currency == "CLP"){
                curr = "CLP";
                symbol = "$ ";
                decimal = ",";
                miles = ".";
            }

            if(t == 1){
                total = parseInt($("#total-salt").val()) + parseInt(dvalue);
            }else{
                total = parseInt($("#total-salt").val()) - parseInt(dvalue);
            }
            

            $('#aux-currency').val(total);
            $("#total-salt").val(total);


            $('#aux-currency').formatCurrency({ 
                                            region: curr,
                                            roundToDecimalPlace: -2,
                                            symbol: symbol,
                                            decimalSymbol: decimal,
                                            digitGroupSymbol: miles
                                        });

            $('.price-dest-salt').text($("#aux-currency").val());


        }

         $(document).on('ifChecked','#dest-salt', function(e){

            $this = $(this);
            
            set_dest_salt($this,1);



         });

        $(document).on('ifUnchecked','#dest-salt', function(e){

            $this = $(this);
            set_dest_salt($this,0);

        });


        var sendind = 0;
        $(".dest-salt-ind").click(function(e){

            $this = $(this);

            if(sendind == 0){
                sendind = 1;
                $this.text("Cargando..");

                d = [];
                $(".dest-salt-check").each(function(ev){
                    if($(this).prop("checked")){
                        d.push("destacado-sample[]="+$(this).val());
                    }
                });

                if(d.length > 0){

                    $.getJSON(__JSON+"?action=comprar-ind-pack-salt&salt=1&total-price="+$("#total-salt").val()+"&disc=1&"+d.join("&"), function(r) {

                        if(r["status"] == 200){
                            self.location.href=r["redirect"];
                        }else{
                            if(r["redirect"] != ""){
                                self.location.href=r["redirect"];
                            }else{
                                if(r["error"] != ""){
                                    alert(r["error"]);
                                }
                            }

                        }

                        $this.text("Comprar");
                        sending = 0;

                    });

                }else{
                    alert("Seleccione al menos 1 destacado saltador");
                }

            }
            
            return false;
        });



        $(".dest-ind").click(function(e){

            $this = $(this);

            $this.text("Cargando..");

            $.getJSON(__JSON+"?action=comprar-ind-pack&total-price="+$this.attr("data-price")+"&disc=1&destacado-sample[]="+$this.attr("data-code"), function(r) {

                if(r["status"] == 200){
                    self.location.href=r["redirect"];
                }else{
                    if(r["redirect"] != ""){
                        self.location.href=r["redirect"];
                    }else{
                        if(r["error"] != ""){
                            alert(r["error"]);
                        }
                    }

                }

                $this.text("Comprar");

            });

            return false;
        });



        
        var destpri = false;
        var destcolor = false;
        var text_sample = $(".text-value").html();

         $(document).on('ifChecked','#destacado-sample', function(e){

            $this = $(this);

            $("#sample-property").addClass($this.attr("data-class"));
            if($this.attr("data-icostar") == "1"){
                $("#sample-property > .ico-star-div").css("display","block");
                if(destcolor){
                    $("#sample-property > .ico-star-div > a").addClass("ico-star-color");
                }
                destpri = true;
            }

            if($this.attr("data-class") == "dest-color" && destpri){
                 $("#sample-property > .ico-star-div > a").addClass("ico-star-color");
            }

            if($this.attr("data-class") == "dest-color"){
                 $("#sample-property > .ico-star-div > a").addClass("ico-star-color");
                destcolor = true;
            }


            currency = $this.attr("data-curr");

            curr = "USD";
            symbol = "US$ ";
            decimal = ",";
            miles = ".";

            if(currency == "CLP"){
                curr = "CLP";
                symbol = "$ ";
                decimal = ",";
                miles = ".";
            }



            /*price = parseInt($this.attr("data-value"));
            total = total+price;*/

            contp = 0;
            total = 0;
            cont_aux = 0;
            $(".publish-property").each(function(){

                $thiss = $(this);
                isChecked = $thiss.prop("checked");

                if(isChecked){
                    total = total+parseInt($thiss.attr("data-value"));
                    contp++;
                }

                cont_aux++;
            });

            if(contp == cont_aux){
                total = total-(total*0.2);
                $("#disc").val(1);
                $(".text-value").html("20% de descuento");
            }else{
                $("#disc").val(0);
                $(".text-value").html(text_sample);
            }


            $("#total-sample").val(total);
            $("#total-price").val(total);

            $('#total-sample').formatCurrency({ 
                                            region: curr,
                                            roundToDecimalPlace: -2,
                                            symbol: symbol,
                                            decimalSymbol: decimal,
                                            digitGroupSymbol: miles
                                        });

            $('#total-dest-sample').text($("#total-sample").val());


        });


        $(document).on('ifUnchecked','#destacado-sample', function(e){

            $this = $(this);

            $("#sample-property").removeClass($this.attr("data-class"));
            if($this.attr("data-icostar") == "1"){
                $("#sample-property > .ico-star-div").css("display","none");
                $("#sample-property > .ico-star-div > a").removeClass("ico-star-color");
                destpri = false;
            }

            if($this.attr("data-class") == "dest-color"){
                destcolor = false;
                $("#sample-property > .ico-star-div > a").removeClass("ico-star-color");
            }


            
            currency = $this.attr("data-curr");

            curr = "USD";
            symbol = "US$ ";
            decimal = ",";
            miles = ".";

            if(currency == "CLP"){
                curr = "CLP";
                symbol = "$ ";
                decimal = ",";
                miles = ".";
            }

            /*price = parseInt($this.attr("data-value"));
            total = total-price;*/
            contp = 0;
            total = 0;
            cont_aux = 0;
            $(".publish-property").each(function(){

                $thiss = $(this);
                isChecked = $thiss.prop("checked");

                if(isChecked){
                    total = total+parseInt($thiss.attr("data-value"));
                    contp++;
                }

                cont_aux++;
            });

            if(contp == cont_aux){
                total = total-(total*0.2);
                $("#disc").val(1);
                $(".text-value").html("20% de descuento");
            }else{
                $("#disc").val(0);
                $(".text-value").html(text_sample);
            }

            $("#total-sample").val(total);
            $("#total-price").val(total);

            $('#total-sample').formatCurrency({ 
                                            region: curr,
                                            roundToDecimalPlace: -2,
                                            symbol: symbol,
                                            decimalSymbol: decimal,
                                            digitGroupSymbol: miles
                                        });

            $('#total-dest-sample').text($("#total-sample").val());


        });

        $(".buy-ind-pack").click(function(e){

            ser = $("#form-dest-property-sample").serialize();

            $.getJSON(__JSON+"?action=comprar-ind-pack&"+ser, function(r) {

                if(r["status"] == 200){
                    self.location.href=r["redirect"];
                }else{
                    if(r["redirect"] != ""){
                        self.location.href=r["redirect"];
                    }else{
                        if(r["error"] != ""){
                            alert(r["error"]);
                        }
                    }

                }

            });

            return false;
        });

        


    }


    if($(".img-holder").exists()){

        $('.img-holder').imageScroll({
            coverRatio: '340px'
        });
    }


    if($("#form-newsletter").exists()){

        $("#form-newsletter #location").autocomplete({
                        minLength: 3,
                        source: __JSON+"?action=autocomplete_city",
                        search  : function(){$("#form-newsletter #loading_locale_news").css('display',"block"); $("#loading_locale").css('display',"block"); },
                        open    : function(){$("#form-newsletter #loading_locale_news").css('display',"none"); $("#loading_locale").css('display',"none"); },
                        select: function(e,ui){
                            $(this).attr("data-value",ui["item"]["code"]);
                        }

        });

        $("#form-newsletter").submit(function(e){

            $("#news-alert-success").css("display","none");
            $("#news-alert-fail").css("display","none");
            $("#button-news").css("display","none");
            $("#news-loading").css("display","block");

            //$("#form-newsletter").css("display","none");

            $.getJSON(__JSON+"?action=suscribe-newsletter&"+$(this).serialize()+"&locale="+$("#form-newsletter #location").attr("data-value"), function(response) {

                if(response["status"] == 200){

                    $("#news-alert-success").css("display","block");
                    $("#news-alert-fail").css("display","none");
                    $("#button-news").css("display","none");
                    $("#news-loading").css("display","none");
                    $("#form-newsletter").css("display","none");

                }else{
                    $("#news-alert-success").css("display","none");
                    $("#news-alert-fail").css("display","block");
                    $("#button-news").css("display","block");
                    $("#news-loading").css("display","none");
                    $("#form-newsletter").css("display","block");
                }

            });

            return false;
        });


    }


    if($("#newpassword").exists()){

        $("#newpassword").submit(function(e){

            $("#reset-alert-fail").css("display", "none");
            $("#reset-alert-success").css("display", "none");
            $("#newpassword #button-sign").css("display", "none");
            $("#newpassword #loading").css("display", "block");

            $.getJSON(__JSON+"?action=reset-password&"+$(this).serialize(), function(response) {
                if(response["status"] == 200){
                    $("#reset-alert-fail").css("display", "none");
                    $("#reset-alert-success").css("display", "block");
                    $("#newpassword #button-sign").css("display", "block");
                    $("#newpassword #loading").css("display", "none");
                    $("#newpassword").css("display", "none");
                }else{
                    $("#reset-alert-fail").css("display", "block");
                    $("#reset-alert-success").css("display", "none");
                    $("#newpassword #button-sign").css("display", "block");
                    $("#newpassword #loading").css("display", "none");

                    if(typeof response["error"] != 'undefined'){
                        if(response["error"] == 1){
                            $("#reset-alert-fail").css("display", "none");
                            $("#reset-alert-fail-password").css("display", "block");
                        }
                    }
                }
            });

            return false;
        });

    }


    
    if($("#loginform").exists()){

    
        $("#loginform").submit(function(e){

            $("#loginform #button-sign").css("display", "none");
            $("#loginform #loading").css("display", "block");
            $("#loginform #login-alert-fail").css("display", "none");
            $("#loginform #login-alert-success").css("display", "none");

            $.getJSON(__JSON+"?action=user-login&"+$(this).serialize().split("#").join("%23"), function(response) { 
                if(response["status"] == 200){
                    $("#loginform #loading").css("display", "none");
                    $("#loginform #login-alert-success").css("display", "block");
                    //self.location.href=response["redirect"];
                    location.reload();
                }else{
                    $("#loginform #loading").css("display", "none");
                    $("#loginform #login-alert-fail").css("display", "block");
                    $("#loginform #button-sign").css("display", "block");
                }
            });

            return false;
        });
        
       


        var sended = 0;
        $("#forgotform").submit(function(e){

            if(sended == 0){

                $("#forgotform #forgot-alert-success").css("display","none");
                $("#forgotform #button-forgot").css("display","none");
                $("#forgotform #loading").css("display","block");

                $.getJSON(__JSON+"?action=user-forgot-password&"+$(this).serialize(), function(response) {

                    $("#forgotform #forgot-alert-success").css("display","block");
                    $("#forgotform #button-forgot").css("display","block");
                    $("#forgotform #loading").css("display","none");

                    sended = 1;

                });

            }

            

            return false;
        });


    }





    if($("#form-create-particular-profile").exists()){

        
        var inputs_error = [];
        var u_doomos = false;

        function send_registro(form,action){

            if(inputs_error.length > 0){
                for(i=0;i<inputs_error.length;i++){
                    $("#"+form+" #"+inputs_error[i]).parent().removeClass("has-error");
                }
            }

            if(u_doomos){
                $("#"+form+" #emp-fail").css("display","none");
                u_doomos = true;
            }

            $("#"+form+" #button-create").css("display","none");
            $("#"+form+" #loading-form").css("display","block");
            $("#"+form+" #send-fail").css("display","none");
            $("#"+form+" #send-fail-registro").css("display","none");


             $.getJSON(__JSON+"?action="+action+"&"+$("#"+form).serialize(), function(response) {

                if(response["status"] == 200){

                    $(".signup-content").fadeOut();
                    $(".signup-successful").fadeIn();

                    $("html, body").animate({ scrollTop: 0 }, "slow");

					switch(form){

                            case "form-create-particular-profile": ga('send', 'pageview', "/registroparticular");
                                break;

                            case "form-create-professional-profile": ga('send', 'pageview', "/registroprofesional");
                                break;

                            case "form-create-professional-inmo-profile": ga('send', 'pageview', "/registroinmobiliaria");
                                break;

                        }

                }else{

                    if(response["user_active"] == 1){

                        $("#"+form+" #send-fail-registro").css("display","block");

                    }else{
                        
                        if(typeof response["url-doomos-fail"] != 'undefined'){
                            if(response["url-doomos-fail"] == 1){
                                 $("#"+form+" #emp-fail").css("display","block");
                                 u_doomos = true;
                            }else{
                                $("#"+form+" #send-fail").css("display","block");
                            }
                        }else{
                            $("#"+form+" #send-fail").css("display","block");
                        }

                    }

                        if(typeof response["error"] != 'undefined'){
                            if(response["error"].length > 0){
                                for(i=0;i<response["error"].length;i++){
                                    $("#"+form+" #"+response["error"][i]).parent().addClass("has-error");
                                    inputs_error.push(response["error"][i]);
                                }
                            }
                        }


                        switch(form){

                            case "form-create-particular-profile": grecaptcha.reset(recaptcha1);
                                break;

                            case "form-create-professional-profile": grecaptcha.reset(recaptcha2);
                                break;

                            case "form-create-professional-inmo-profile": grecaptcha.reset(recaptcha3);
                                break;

                        }

                    
                }

                $("#"+form+" #button-create").css("display","block");
                $("#"+form+" #loading-form").css("display","none");


             });

            
            
        }
        
        
        $("#form-create-particular-profile").submit(function(e){
            send_registro("form-create-particular-profile","registro_particular");
            return false;
        });

        $("#form-create-professional-profile").submit(function(e){
            send_registro("form-create-professional-profile","registro_profesional");
            return false;
        });
        
        $("#form-create-professional-inmo-profile").submit(function(e){
            send_registro("form-create-professional-inmo-profile","registro_profesional_inmo");
            return false;
        });


        $("#form-create-professional-profile #region").change(function(e){
            show_locale_parent("form-create-professional-profile", "comuna", $(this).val());
        });
        $("#form-create-professional-inmo-profile #region").change(function(e){
            show_locale_parent("form-create-professional-inmo-profile", "comuna", $(this).val());
        });
        


    }


    if($("#contact-company").exists()){

        var inputs_error = [];
        $("#contact-company").submit(function(e){

            $("#send-fail").css("display","none");
            $("#form-contact-company-submit").css("display","none");
            $("#loading-form").css("display","block");
            
            if(inputs_error.length > 0){
                for(i=0;i<inputs_error.length;i++){
                    $("#"+inputs_error[i]).parent().removeClass("has-error");
                }
            }

            $.getJSON(__JSON+"?action=contact_company&"+$("#contact-company").serialize(), function(response) { 
               
                if(response["status"] == 200){

                    $("#send-ok").css("display","block");
                    if(response["contact-data"] != ""){

                        $("#contact-company").css("display","none");
                        $("#contact-data-div").css("display","block");
                        $("#contact-data").html(response["contact-data"]);
                    }

					ga('send', 'pageview', "/contactocorredora");
					ga('send', 'pageview', "/contactosTotales");

                }else{

                    if(typeof response["error"] != 'undefined'){
                        if(response["error"].length > 0){
                            for(i=0;i<response["error"].length;i++){
                                $("#"+response["error"][i]).parent().addClass("has-error");
                                inputs_error.push(response["error"][i]);
                            }
                        }
                    }

                    $("#send-fail").css("display","block");
                    $("#form-contact-company-submit").css("display","block");
                    $("#loading-form").css("display","none");

                    grecaptcha.reset();

                }


            });

            return false;
        });
    }



    if($("#filter-emp").exists()){

        var page = 1;

        function get_propiedades_empresa(){

            $("#filter-emp").css({ opacity: 0.5 });
            $("#resultados").css({ opacity: 0.5 });
            $("#paginacion").css({ opacity: 0.5 });
            $("#cont-result").css({ opacity: 0.5 });

            self.location.href=location_path+"?"+$("#filter-emp").serialize()+"&page="+page;


            /*$.getJSON(__JSON+"?action=anuncios_empresas&"+$("#filter-emp").serialize()+"&page="+page, function(response) { 

                if(typeof response["status"] != 'undefined'){

                    if(response["status"] == 200){

                        $("#resultados").html(response["html"]);
                        $("#paginacion").html(response["paginacion"]);
                        $("#cont-result").html(response["total"]);

                    }else{
                        alert("Error, por favor actualize la página");
                    }

                }else{
                    alert("Error, por favor actualize la página");
                }


                /*$("#filter-emp").css({ opacity: 1 });
                $("#resultados").css({ opacity: 1 });
                $("#paginacion").css({ opacity: 1 });
                $("#cont-result").css({ opacity: 1 });
                

            });*/

        }

        $("#locale").change(function(e){
            page = 1;
            get_propiedades_empresa();
        });
        
        $("#types").change(function(e){
            page = 1;
            get_propiedades_empresa();
        });
        
        $("#operation").change(function(e){
            page = 1;
            get_propiedades_empresa();
        });
        
        $("#code").blur(function(e){
            if($.trim($(this).val()) != ""){
                    page = 1;
                   get_propiedades_empresa();
                }
        });

        $("#code").keypress(function( event ) {
                      if ( event.which == 13 ) {
                         if($.trim($("#code").val()) != ""){
                            page = 1;
                            get_propiedades_empresa();
                         }
                      }
                    }); 

        $("#filter-emp").submit(function(e){
            //get_propiedades_empresa();
            return false;
        });


        $(document).on("click",".pagination li a",function(e){

                page = $(this).attr("data-value");
                //console.log(page);
                get_propiedades_empresa();

                return false;

            });

    }

    if($("#filter-empresas").exists()){

            var page = 1;

            function get_empresas(){

                $("#filter-empresas").css({ opacity: 0.5 });
                $("#results").css({ opacity: 0.5 });
                $("#paginacion").css({ opacity: 0.5 });
                $("#results_cont").css({ opacity: 0.5 });
                $("#search_title").css({ opacity: 0.5 });

                ser = $("#filter-empresas").serializeArray();
                str_string = [];
                $.each(ser, function(i,v){
                    if(v["name"] == "locale"){
                        str_string.push(v["name"]+"="+$("#"+v["name"]).attr("data-value"));
                    }else{
                        str_string.push(v["name"]+"="+v["value"]);
                    }
                });

                $.getJSON(__JSON+"?action=empresas_busqueda&"+str_string.join("&")+"&page="+page, function(response) {
                    
                    $("#results").html(response["html"]);
                    $("#paginacion").html(response["paginacion"]);
                    $("#results_cont").html(response["total"]);
                    $("#search_title").html("<h1>"+response["titulo"]+"</h1>");

                    $("#filter-empresas").css({ opacity: 1 });
                    $("#results").css({ opacity: 1 });
                    $("#paginacion").css({ opacity: 1 });
                    $("#results_cont").css({ opacity: 1 });
                    $("#search_title").css({ opacity: 1 });

                });
            }

            $("#filter-empresas #locale").autocomplete({
                        minLength: 3,
                        source: __JSON+"?action=autocomplete_city",
                        select: function(e,ui){
                            $(this).attr("data-value",ui["item"]["code"]);
                            get_empresas();
                        }

            });

            $("#types").change(function(){
                get_empresas();
            });


            $("#keywords").keypress(function( event ) {
                      if ( event.which == 13 ) {
                         if($.trim($("#keywords").val()) != ""){
                            get_empresas();
                         }
                      }
                    }); 

            $("#keywords").blur(function(e){
                //if($.trim($(this).val()) != ""){
                    get_empresas();
                //}
            });

            //$(".pagination li").delegate("a","click",function(e){
            $(document).on("click",".pagination li a",function(e){

                page = $(this).attr("data-value");
                //console.log(page);
                get_empresas();

                return false;

            });

    }


    var inputs_error_project = [];
    var sended_project = 0;
    function contact_project_form(form,fuente){

        $("#"+form+" #send-fail").css("display","none");
        $("#"+form+" #form-contact-reply-submit-project").css("display","none");
        $("#"+form+" #loading-form").css("display","block");

        if(inputs_error_project.length > 0){
            for(i=0;i<inputs_error_project.length;i++){
                $("#"+form+" #"+inputs_error_project[i]).parent().removeClass("has-error");
            }
        }

        inputs_error_project = [];

        form_data = $("#"+form).serialize();

        $.getJSON(__JSON+"?action=contact-project&"+form_data+"&form="+fuente, function(response) { 

            if(response["status"] == 200){

                $("#"+form+" #send-ok").css("display","block");
                $("#"+form+" #form-content").css("display","none");
                if(response["contact-data"] != ""){

                        $("#"+form+" #contact-data-div").css("display","block");
                        $("#"+form+" #contact-data").html(response["contact-data"]);
                    
                }

                if($("#prop_rel_contact").exists()){
                    contact_serialize = form_data;
                    $("#prop_rel_contact").modal('show');
                }

                sended_project = 1;
				
					ga('send', 'pageview', "/contactoproyecto");
					ga('send', 'pageview', "/contactosTotales");

            }else{

                if(typeof response["errores"] != 'undefined'){
                    if(response["errores"].length > 0){
                        for(i=0;i<response["errores"].length;i++){
                            $("#"+form+" #"+response["errores"][i]).parent().addClass("has-error");
                            inputs_error_project.push(response["errores"][i]);
                        }
                    }
                }

                $("#"+form+" #send-fail").css("display","block");
                $("#"+form+" #form-contact-reply-submit-project").css("display","block");
                $("#"+form+" #loading-form").css("display","none");

                
                grecaptcha.reset(recaptcha1);
                grecaptcha.reset(recaptcha2);

            }

        });


    }

    
    if($("#form-single-project-reply #region").exists()){

        options_reg = "<option value='-1'>Seleccione región</option>";
        $.each(regiones_ac, function(i,v){
            options_reg = options_reg+"<option value='"+v[0]+"'>"+v[1]+"</option>";
        });
        $("#form-single-project-reply #region").html(options_reg);

        $("#form-single-project-reply #region").change(function(e){
            
            options_comuna = "<option value='-1'>Seleccione comuna</option>";
            
            for(i=0;i<comunas_ac.length;i++){
                if(comunas_ac[i][1] == $(this).val()){
                    options_comuna = options_comuna+"<option value='"+comunas_ac[i][2]+"'>"+comunas_ac[i][2]+"</option>";
                }
            }
            $("#form-single-project-reply #comuna").html(options_comuna);

        });


    }

    if($("#form-single-project-reply-modal #region").exists()){

        options_reg = "<option value='-1'>Seleccione región</option>";
        $.each(regiones_ac, function(i,v){
            options_reg = options_reg+"<option value='"+v[0]+"'>"+v[1]+"</option>";
        });
        $("#form-single-project-reply-modal #region").html(options_reg);

        $("#form-single-project-reply-modal #region").change(function(e){
            
            options_comuna = "<option value='-1'>Seleccione comuna</option>";
            
            for(i=0;i<comunas_ac.length;i++){
                if(comunas_ac[i][1] == $(this).val()){
                    options_comuna = options_comuna+"<option value='"+comunas_ac[i][2]+"'>"+comunas_ac[i][2]+"</option>";
                }
            }
            $("#form-single-project-reply-modal #comuna").html(options_comuna);

        });
        
    }

    $("#form-single-project-reply-modal").submit(function(e){

        if( sended_project == 0 ){
            contact_project_form('form-single-project-reply-modal','popup');
        }
        
        return false;
    });

    $("#form-single-project-reply").submit(function(e){

        
        if( sended_project == 0 ){
            contact_project_form('form-single-project-reply','');
        }

        return false;
    });

    





    var inputs_error = [];
    var sended_property = 0;
    function contact_property_form(form,fuente){


        $("#"+form+" #send-fail").css("display","none");
        $("#"+form+" #form-contact-reply-submit").css("display","none");
        $("#"+form+" #loading-form").css("display","block");

        if(inputs_error.length > 0){
            for(i=0;i<inputs_error.length;i++){
                $("#"+form+" #"+inputs_error[i]).parent().removeClass("has-error");
            }
        }

        inputs_error = [];
        form_data = $("#"+form).serialize();

        $.getJSON(__JSON+"?action=contact-property&"+form_data+"&form="+fuente, function(response) { 

            if(response["status"] == 200){

                $("#"+form+" #send-ok").css("display","block");
                //if(response["contact-data"] != ""){

                    /*if($("#data_anunciante_popup").exists()){

                        $("#data_anunciante_popup").html(response["contact-data"]);
                        $("#"+form+" #form-content").css("display","none");

                    }else{*/
                        $("#"+form+" #form-content").css("display","none");
                        $("#"+form+" #contact-data-div").css("display","block");
                        $("#"+form+" #contact-data").html(response["contact-data"]);

                    //}

                    
                //}

                if($("#prop_rel_contact").exists()){
                    contact_serialize = form_data;
                    $("#prop_rel_contact").modal('show');
                }

                sended_property = 1;

				ga('send', 'pageview', "/contactopropiedad");
				ga('send', 'pageview', "/contactosTotales");

                if(fuente == ''){
                    $(".msg-fraude").css("display","block");
                }else{
                    $(".msg-fraude-modal").css("display","block");
                }


            }else{

                if(typeof response["errores"] != 'undefined'){
                    if(response["errores"].length > 0){
                        for(i=0;i<response["errores"].length;i++){
                            $("#"+form+" #"+response["errores"][i]).parent().addClass("has-error");
                            inputs_error.push(response["errores"][i]);
                        }
                    }
                }

                $("#"+form+" #send-fail").css("display","block");
                $("#"+form+" #form-contact-reply-submit").css("display","block");
                $("#"+form+" #loading-form").css("display","none");

                grecaptcha.reset(recaptcha1);
                grecaptcha.reset(recaptcha2);

            }



        });

    }

    

    $("#form-single-property-reply").submit(function(e){

        if(sended_property == 0){
            contact_property_form('form-single-property-reply','');
        }

        return false;

    });


    $("#form-single-property-reply-modal").submit(function(e){

        if(sended_property == 0){
            contact_property_form('form-single-property-reply-modal','popup');
        }

        return false;
    });


    if($("#map-detail").exists()){


        var map2;
        var map3;
        
        function load_map_detail(lt,ln,ky){

            $("#map4").html('<iframe width="100%" height="'+$("#map4").height()+'" frameborder="0" style="border:0" src="https://www.google.com/maps/embed/v1/place?q='+lt+','+ln+'&zoom=18&maptype=satellite&key='+ky+'" allowfullscreen></iframe>');

        }


        var lat = parseFloat($("#map4").attr("data-lat"));
        var lng = parseFloat($("#map4").attr("data-lng"));
        var key = $("#map4").attr("key");
         
                
        var fl = 0;
        var fl2 = 0;


        $('.map4').click(function () {

            if(fl == 0){
                  load_map_detail(lat,lng,key);
                fl = 1;
            }

        });

        if($('#map-detail').attr("class") == "tab active"){
                load_map_detail(lat,lng,key);
                fl = 1;
        }


        $('.map5').click(function () {

            if(fl2 == 0){

                $("#map5").html('<iframe width="100%" height="'+$("#map5").height()+'" frameborder="0" style="border:0" src="https://www.google.com/maps/embed/v1/streetview?location='+lat+','+lng+'&key='+key+'" allowfullscreen></iframe>');

                fl2 = 1;
            }

       

        });

                    

    }


    function get_inputs_form(form){

        var inputs = [];

        $('#'+form+' input[id]').each(function() {
            inputs.push($(this).attr('id'));
        });

         $('#'+form+' select[id]').each(function() {
            inputs.push($(this).attr('id'));
        });

         return $.unique(inputs);

    }



        $("#images-detail").owlCarousel({
            items : 3,
            pagination: true,
            nav: true,
            slideSpeed: 700,
            responsive:{
                            0:{
                                items:1
                            },
                            728:{
                                items:2
                            },
                            940:{
                                items:3
                            },
                            1170:{
                                items:3
                            }
                        },
            loop:true,
            navText: [
            "<i class='fa fa-chevron-left'></i>",
            "<i class='fa fa-chevron-right'></i>"
            ]
        });
           /* functin for remove params */
    function removeParam(key, sourceURL) {
    var rtn = sourceURL.split("?")[0],
        param,
        params_arr = [],
        queryString = (sourceURL.indexOf("?") !== -1) ? sourceURL.split("?")[1] : "";
    if (queryString !== "") {
        params_arr = queryString.split("&");
        for (var i = params_arr.length - 1; i >= 0; i -= 1) {
            param = params_arr[i].split("=")[0];
            if (param === key) {
                params_arr.splice(i, 1);
            }
        }
        rtn = rtn + "?" + params_arr.join("&");
    }
    return rtn;
}
function changeLocaleParam(href, newVal) {
    //console.log(href);
    //console.log(newVal);
var tmpRegex = new RegExp("(locale=)[0-9]+", 'ig');

    //console.log(tmpRegex);

return href.replace(tmpRegex, '$1'+newVal);
}

        if($("#map-search").exists()){


                var lat = -33.4436991;
                var lng = -70.64986;
                var first_load = 1;
                var map;


                function load_results_map(map,latn,lats,lnge,lngo){

                    $("#map-loading").css("display","block");
                    $("#map-title").css("display","none");
                    $("#map-search").css({ opacity: 0.5 });
                    $("#form-filter-search-map").css({ opacity: 0.5 });
                    map.removeMarkers();
                    if($('#form-filter-search-map_res #searchbar').css('display') == 'none'){
                        //alert('normal');
                        var serialize = $("#form-filter-search-map").serializeArray();
                    }else{
                        //alert('res');
                        var serialize = $("#form-filter-search-map_res").serializeArray();    
                    }

                    str_url = [];
                    str_url_forlist = [];
                    tps = [];
                  var precio = "";
                  var precio_min = "";
                  var currency = "";
                  var currency_min = "";
                  var age = "";
                  var age_forlist = "";
                    
                    $.each(serialize, function(i,v){ 

                        if(v["name"] != "locale"){
                            if(v["name"] == "tipo_prop[]"){
                                tps.push(v["value"]);
                            }else if(v["name"] == "price-max"){
                                precio = v["value"];
                            }else if(v["name"] == "currency_max"){
                                currency = v["value"];
                            }else if(v["name"] == "price-min"){
                                precio_min = v["value"];
                            }else if(v["name"] == "currency_min"){
                                currency_min = v["value"];
                            }else if(v["name"] == "age"){
                                age = v["value"];
                                if(v["value"] == '-1'){
                                    age_forlist = '';
                                }
                            }
                            else{
                                str_url.push(v["name"]+"="+v["value"]);
                                if(v['value'] != '-1'){
                                    str_url_forlist.push(v["name"]+"="+v["value"]);
                                }
                            }
                            
                        }

                    });
                    // GET PROPERTYPRE

                    if(tps.length == 1 && tps.includes('1')){
                        $('#mapDepartProp').text('Departamentos');
                        $('#mapDepartProp_res').text('Departamentos');
                    }else if(tps.length == 1 && tps.includes('2')){
                        $('#mapDepartProp').text('Casas');
                        $('#mapDepartProp_res').text('Casas');
                    }
                    else if(tps.length == 1 && tps.includes('3')){
                        $('#mapDepartProp').text('Oficinas');
                        $('#mapDepartProp_res').text('Oficinas');
                    }
                    else if(tps.length == 1 && tps.includes('4')){
                        $('#mapDepartProp').text('Locales Comerciales');
                        $('#mapDepartProp_res').text('Locales Comerciales');
                    }
                    else if(tps.length == 1 && tps.includes('5')){
                        $('#mapDepartProp').text('Terrenos');
                        $('#mapDepartProp_res').text('Terrenos');
                    }
                    else if(tps.length == 1 && tps.includes('6')){
                        $('#mapDepartProp').text('Bodegas');
                        $('#mapDepartProp_res').text('Bodegas');
                    }
                    else if(tps.length == 1 && tps.includes('7')){
                        $('#mapDepartProp').text('Estacionamientos');
                        $('#mapDepartProp_res').text('Estacionamientos');
                    }
                    else if(tps.length == 1 && tps.includes('8')){
                        $('#mapDepartProp').text('Lofts');
                        $('#mapDepartProp_res').text('Lofts');
                    }
                    else if(tps.length == 1 && tps.includes('9')){
                        $('#mapDepartProp').text('Parcelas');
                        $('#mapDepartProp_res').text('Parcelas');
                    }
                    else if(tps.length == 1 && tps.includes('10')){
                        $('#mapDepartProp').text('Quintas');
                        $('#mapDepartProp_res').text('Quintas');
                    }
                    else if(tps.length == 1 && tps.includes('11')){
                        $('#mapDepartProp').text('Negocios');
                        $('#mapDepartProp_res').text('Negocios');
                    }
                    else if(tps.length == 1 && tps.includes('12')){
                        $('#mapDepartProp').text('Galpones');
                        $('#mapDepartProp_res').text('Galpones');
                    }
                    else if(tps.length == 1 && tps.includes('13')){
                        $('#mapDepartProp').text('Almacenes');
                        $('#mapDepartProp_res').text('Almacenes');
                    }
                    else if(tps.length == 1 && tps.includes('14')){
                        $('#mapDepartProp').text('Casas Comerciales');
                        $('#mapDepartProp_res').text('Casas Comerciales');
                    }
                    else if(tps.length == 1 && tps.includes('15')){
                        $('#mapDepartProp').text('Propiedades Industiales');
                        $('#mapDepartProp_res').text('Propiedades Industiales');
                    }
                    else if(tps.length == 1 && tps.includes('16')){
                        $('#mapDepartProp').text('Cabañas');
                        $('#mapDepartProp_res').text('Cabañas');
                    }
                    
                    
                    else{
                        $('#mapDepartProp').text('Propiedades');
                        $('#mapDepartProp_res').text('Propiedades');
                    }

                   var vars_maps = "map=1&latn="+latn+"&lats="+lats+"&lnge="+lnge+"&lngo="+lngo+"&"+str_url.join("&")+"&price-max="+precio+"_"+currency+"&price-min="+precio_min+"_"+currency_min+"&age="+age+"&types="+tps.join(",");

					ga('send', 'pageview', '/map/?'+vars_maps);
                                        //console.log(vars_maps);
                    $.getJSON(__JSON+"?action=search_map&"+vars_maps, function(response) { 

                        if(response["status"] == 200){
                           // update list view url
                            //alert(serialize);
                            
                                // construct prety URL
                                var mapUrlC = window.location.href.replace('map-vista', 'search');
                                var urlForList = str_url_forlist.join("&")+"&price-max="+precio+"_"+currency+"&price-min="+precio_min+"_"+currency_min+"&age="+age_forlist+"&types="+tps.join(",");
                                var urlForListPrice = urlForList.replace(/=_CLP/g, "=");
                                var urlForListPrice2 = urlForListPrice.replace(/[^=&]+=(&|$)/g,"").replace(/&$/,"")
                                if(urlForListPrice2 != ''){
                                    var urlForListFull  = '&'+urlForListPrice2;
                                }else{
                                    var urlForListFull = '';
                                }
                                // construct prety URL
//                            alert(urlForList);   
//                            alert(urlForListPrice);   
//                            alert(urlForListFull);   
                            //alert(urlForListFull);   
                            //console.log(serialize);
                            $('#listParamsForSearch').attr('href',  removeDuplicatesFromUrl(changeLocaleParam(mapUrlC+urlForListFull, $('#locale').attr('data-value'))));
                            // update list view url
                            
                            if(response["cantidad_resultados"] > 0){
$('#opensavesearch').css({'pointer-events': 'inherit', 'opacity': 1});
/* ######### SAVE ZONE AREA STARTS ########### */
                    function get_type(i) {
                        var typename = ''
                            switch (i) {
                            case '-1':
                                typename = '';
                                break;
                            case '1':
                                typename = 'Departamento';
                                break;
                            case '2':
                                typename = 'Casa';
                                break;
                            case '3':
                                typename = 'Oficinas';
                                break;
                            case '4':
                                typename = 'Locales Comerciales';
                                break;
                            case '5':
                                typename = 'Terrenos';
                                break;
                            case '6':
                                typename = 'Bodegas';
                                break;
                            case '7':
                                typename = 'Estacionamientos';
                                break;
                            case '8':
                                typename = 'Lofts';
                                break;
                            case '9':
                                typename = 'Parcelas';
                                break;
                            case '10':
                                typename = 'Quintas';
                                break;
                            case '11':
                                typename = 'Negocios';
                                break;
                            case '12':
                                typename = 'Galpones';
                                break;
                            case '13':
                                typename = 'Almacenes';
                                break;
                            case '14':
                                typename = 'Casas Comerciales';
                                break;
                            case '15':
                                typename = 'Propiedades Industiales';
                                break;
                            case '16':
                                typename = 'Cabañas';
                                break;
                            default :
                                typename = '';
                                break;
                                       }
                            return typename;           
                    }
                    var searchName; var details = ''; var link; var total;
                    //console.log(serialize);
                    var searchString = '';
                    var types = '';
                    for(var s=0; s<serialize.length; s++){
                        if(serialize[s].name == 'locale'){
                            searchName = serialize[s].value;
                        }
                        if(serialize[s].name == 'operation'){
                            var operation = serialize[s].value;
                        }
                        
                        if(serialize[s].name == 'tipo_prop[]'){
                            var types = types + get_type(serialize[s].value) + ',';
                        }
                        
                        
                        if(serialize[s].name == 'price-min'){
                            searchString +=  '&price-min='+serialize[s].value;
                            var pricemin = serialize[s].value;
                        }
                        if(serialize[s].name == 'currency_min'){
                            searchString +=  '&currency_min='+serialize[s].value;
                            var currencymin = serialize[s].value;
                        }
                        
                        if(serialize[s].name == 'price-max'){
                            searchString +=  '&price-max='+serialize[s].value;
                            var pricemax = serialize[s].value;
                        }
                        if(serialize[s].name == 'currency_max'){
                            searchString +=  '&currency_max='+serialize[s].value;
                            var currencymax = serialize[s].value;
                        }
                        
                        if(serialize[s].name == 'rooms'){
                            if(serialize[s].value == -1){
                                searchString +=  '&rooms=0';
                            }else{
                                searchString +=  '&rooms='+serialize[s].value;
                            }
                            var rooms = serialize[s].value;
                        }
                        if(serialize[s].name == 'baths'){
                            if(serialize[s].value == -1){
                                searchString +=  '&baths=0';
                            }else{
                                searchString +=  '&baths='+serialize[s].value;
                            }
                            var baths = serialize[s].value;
                        }
                        if(serialize[s].name == 'size-min'){
                            searchString +=  '&size-min='+serialize[s].value;
                            var sizemin = serialize[s].value;
                        }
                        if(serialize[s].name == 'size-min'){
                            searchString +=  '&size-max='+serialize[s].value;
                            var sizemax = serialize[s].value;
                        }
                        if(serialize[s].name == 'age'){
                            searchString +=  '&age='+serialize[s].value;
                            var age = serialize[s].value;
                        }
                        //details = searchString;
                    }
                    link = window.location.href+searchString;
                    total= response["resultados"].length;
                    //alert(link);
                   // alert(searchName);
                   // console.log(JSON.stringify(serialize));
                   function select_option(i) {
                     return $('#operation option[value="' + i + '"]').html();
                   }
                   function select_antiquity(i) {
                     return $('#age option[value="' + i + '"]').html();
                   }
                   
                   //generate criteria Data
                   var criteriaData = '';
                   
                   if(searchName != ''){
                       criteriaData += "<li>Comuna: <input id='mapPersonalized' type='text' value='' style='border: 1px solid #e5e5e5;  display:none;   width: auto;     padding: 0px 10px;'> "+searchName+"</li>";
                   }
                   if(operation != '' && operation != '-1'){
                       criteriaData += "<li>Operación: "+select_option(operation)+"</li>";
                       details += "Operación - "+select_option(operation)+'; ';
                   }
                   
                   if(types != '' && types != '-1'){
                       criteriaData += "<li>Tipo de propiedad: "+types.substring(0,types.length-1)+"</li>";
                       details += "Tipo de propiedad - "+types.substring(0,types.length-1)+'; ';
                   }
                   if(baths != '' && baths != '-1'){
                       criteriaData += "<li>Baños: "+baths+"</li>";
                       details += "Baños - "+baths+'; ';
                   }
                   if(rooms != '' && rooms != '-1'){
                       criteriaData += "<li>Habitaciones: "+rooms+"</li>";
                       details += "Habitaciones - "+rooms+'; ';
                   }
                   if(pricemin == '' || pricemax == ''){
                       criteriaData += "<li>Precio: Todo</li>";
                       details += "Precio - Todo"+'; ';
                   }
                   if(pricemin != ''){
                       criteriaData += "<li>Precio min:"+currencymin+" "+pricemin+"</li>";
                       details += "Precio min - "+currencymin+" "+pricemin+'; ';
                   }
                   if(pricemax != ''){
                       criteriaData += "<li>Precio max:"+currencymax+" "+pricemax+"</li>";
                       details += "Precio max - "+currencymax+" "+pricemax+'; ';
                   }
                   if(sizemin != ''){
                       criteriaData += "<li>Tamano min:"+sizemin+"</li>";
                       details += "Tamano min - "+sizemin+'; ';
                   }
                   if(sizemax != ''){
                       criteriaData += "<li>Tamano max:"+sizemax+"</li>";
                       details += "Tamano max - "+sizemax+'; ';
                   }
                   if(age != '' && age != '-1'){
                       criteriaData += "<li>Antigüedad: "+select_antiquity(age)+"</li>";
                       details += "Antigüedad - "+select_antiquity(age)+'; ';
                   }
                   details = details.slice(0, -1).trim();
                   
                   $('#criteria_map').html(criteriaData);
                   var slink = window.location.href+urlForListFull;
                   slink = changeLocaleParam(slink, $('#locale').attr('data-value'));
                    //generate criteria Data
                   
                    $('#mapCreateAlert').attr('onclick',"openPopUpSaveSearch('"+searchName+"', '"+details+"', '"+link+"', '"+total+"', '1')");
                    $('#saveSearchForm [name=id_localidad]').val($("#locale").attr("data-value"));        
                    $('#saveSearchForm [name=sarea]').val(searchName); 
                    
                    //slink = removeDuplicatesFromUrl(slink);
                    
                    $('#saveSearchForm [name=slink]').val(removeDuplicatesFromUrl(slink));        
                    $('#saveSearchForm [name=sdata]').val(details);        
                    $('#saveSearchForm [name=items]').val(total); 
                    $('#saveSearchForm [name=id_currency]').val(currencymax);        
                    $('#saveSearchForm [name=precio_max]').val(pricemax);        
                    $('#saveSearchForm [name=tamano_total_max]').val(sizemax);        
                    $('#saveSearchForm [name=banos]').val(baths);        
                    $('#saveSearchForm [name=habitaciones]').val(rooms);  
                    
                    $('#saveSearchFormLogin2 [name=id_localidad]').val($("#locale").attr("data-value"));          
                    $('#saveSearchFormLogin2 [name=sarea]').val(searchName);        
                    $('#saveSearchFormLogin2 [name=slink]').val(removeDuplicatesFromUrl(slink));        
                    $('#saveSearchFormLogin2 [name=sdata]').val(details);        
                    $('#saveSearchFormLogin2 [name=items]').val(total); 
                    $('#saveSearchFormLogin2 [name=id_currency]').val(currencymax);        
                    $('#saveSearchFormLogin2 [name=precio_max]').val(pricemax);        
                    $('#saveSearchFormLogin2 [name=tamano_total_max]').val(sizemax);        
                    $('#saveSearchFormLogin2 [name=banos]').val(baths);        
                    $('#saveSearchFormLogin2 [name=habitaciones]').val(rooms); 
                    
                    $('#saveSearchFormLogin [name=id_localidad]').val($("#locale").attr("data-value"));          
                    $('#saveSearchFormLogin [name=sarea]').val(searchName);        
                    $('#saveSearchFormLogin [name=slink]').val(removeDuplicatesFromUrl(slink));        
                    $('#saveSearchFormLogin [name=sdata]').val(details);        
                    $('#saveSearchFormLogin [name=items]').val(total); 
                    $('#saveSearchFormLogin [name=id_currency]').val(currencymax);        
                    $('#saveSearchFormLogin [name=precio_max]').val(pricemax);        
                    $('#saveSearchFormLogin [name=tamano_total_max]').val(sizemax);        
                    $('#saveSearchFormLogin [name=banos]').val(baths);        
                    $('#saveSearchFormLogin [name=habitaciones]').val(rooms); 
                    
                    // clearfms
                    $('#dialogSaveSearch #loadingSaveSearch').hide();
                    $('#dialogSaveSearch #searchSaved').hide();
                    $('#dialogSaveSearch #continueButtonSv').hide();
                    $('#dialogSaveSearch #saveSearchForm').show();
                    $('#dialogSaveSearch #button-sign-save').show();
                    
                    //set params for fb
                    $('#opensavesearch').attr('onclick' , "openPopUpSaveSearch('"+searchName+"', '"+details+"', '"+slink+"', '"+total+"', '1')");
                    
                    //get bounds of drawn polygon
                    var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};


if(getUrlParameter('shape')){
 
$('#mapPersonalised').show();
$('#mapOperation').hide();
$('#mapDepartProp').hide();
$('#mapLocaleen').hide();
$('#mapLocale').hide();
    

    $('#toggle-drawing_li').hide();
    $('#deleteShape').show();
    $('#deleteShape').click(function(){
        window.location = $('#cancelDrawnMap').attr('href');
    });
    
    function getCoordsFromZoneId(id){
        $.getJSON(__JSON+"?action=get_zone_bounds&id="+id, function(responseco) {
                if(responseco["status"] == 200){
                    var getZoneBounds =   responseco['coords'];
                          var savedZoneArea = JSON.parse(getZoneBounds);
                          // Construct the polygon.
                          var savedZonePolygon = new google.maps.Polygon({
                            paths: savedZoneArea,
                            strokeColor: '#409603',
                            fillColor: '#F29100',
                            strokeOpacity: 1,
                            strokeWeight: 2,
                            fillOpacity: 0.1
                          });
                          savedZonePolygon.setMap(map.map);
                          $("#map-title").html(response["titulo"]);
                                
                                var proprtyIdForList = '';
                                var rcount = 0;
                                for(i=0;i<response["resultados"].length;i++){
                                    // check if drawn area it there?
                                    
                                    var coordinate = new google.maps.LatLng(response["resultados"][i]["lat"], response["resultados"][i]["lng"]);
                                    if(savedZonePolygon.containsLatLng(coordinate))
                                    {
                                  
                                    proprtyIdForList += response["resultados"][i]["propertyId"] + ',';    
                                    map.addMarker({
                                        lat: response["resultados"][i]["lat"],
                                        lng: response["resultados"][i]["lng"],
                                        title: response["resultados"][i]["titulo"],
                                        icon: response["resultados"][i]["icon"],
                                        //animation: google.maps.Animation.DROP,
                                        infoWindow: {
                                          content: response["resultados"][i]["html"]
                                        }
                                      });
                                      rcount++;
                                  }
                                }
                                $("#mapResults").html(rcount);
                                $("#mapResults_res").html(rcount); 
                                //var mapUrl = window.location.href;
                                //var linkForSearchPage = removeParam('shape',mapUrl.replace('map-vista', 'search'));
                                //$('#listParamsForSearch').attr('href',  linkForSearchPage+'&zone_ids='+proprtyIdForList.replace(/,\s*$/, ""));
                                //alert(proprtyIdForList.replace(/,\s*$/, ""));
                } else {
                    alert('Algo va mal');
                    return false;
                }
            });
    };
    getCoordsFromZoneId(getUrlParameter('shape'));
    /* functin for remove params */
   
} else {
   // searchWithinPolygon();
   // get_bounds_map(map);
                                // $('#mapCreateAlert').text(JSON.parse(JSON.stringify(serialize)));
/* ######### SAVE ZONE AREA ENDS ########### */


                                $("#map-title").html(response["titulo"]);
                                $("#mapResults").html(response["resultados"].length);
                                $("#mapResults_res").html(response["resultados"].length);
                                for(i=0;i<response["resultados"].length;i++){
                                    // check if drawn area it there?
                                   
                                    map.addMarker({
                                        lat: response["resultados"][i]["lat"],
                                        lng: response["resultados"][i]["lng"],
                                        title: response["resultados"][i]["titulo"],
                                        icon: response["resultados"][i]["icon"],
                                        infoWindow: {
                                          content: response["resultados"][i]["html"]
                                        }
                                      });
                                  
                                }

}
                            }else{
                                alert("No se han encontrado resultados para su búsqueda");
                                $('#mapResults').text('0');
                                $('#mapResults_res').text('0');
                                $("#map-loading").css("display","none");
                        $("#map-title").css("display","block");
                        $("#map-search").css({ opacity: 1 });
                        $("#form-filter-search-map").css({ opacity: 1 });
                        $('#opensavesearch').css({'pointer-events': 'none', 'opacity': 0.5});
                                //return false;
                            }


                        }else{
                            alert("Hemos tenido un problema, intente nuevamente refrescando la página");
                        }

                        $("#map-loading").css("display","none");
                        $("#map-title").css("display","block");
                        $("#map-search").css({ opacity: 1 });
                        $("#form-filter-search-map").css({ opacity: 1 });

                    });



                }
                
                function get_bounds_map(map){

                    bounds = map.getBounds();

                    ne = bounds.getNorthEast();
                    sw = bounds.getSouthWest();

                    //console.log(ne.lat());
                    //console.log(sw.lat());
                    //console.log(ne.lng());
                    //console.log(sw.lng());


                    load_results_map(map,ne.lat(),sw.lat(),ne.lng(),sw.lng());

                }



                if($.trim($("#locale").val()) != "" && $("#locale").attr("data-value") != "-1"){

                    GMaps.geocode({
                                  address: $("#locale").val().split(" - ").reverse().join(", ")+", "+__PAIS,
                                  callback: function(results, status){
                                    if(status=='OK'){
                                      var latlng = results[0].geometry.location;

                                            var head = document.getElementsByTagName('head')[0];
                                            // Save the original method
                                            var insertBefore = head.insertBefore;
                                            // Replace it!
                                            head.insertBefore = function (newElement, referenceElement) {
                                                if (newElement.href && newElement.href.indexOf('https://fonts.googleapis.com/css?family=Roboto') === 0) {
                                                    return;
                                                }
                                                insertBefore.call(head, newElement, referenceElement);
                                            };

                                          map = new GMaps({
                                            div: '#map-search',
                                            lat: latlng.lat(), 
                                            lng: latlng.lng(),
                                            zoom: 14,
                                            mapType: "ROADMAP", // HYBRID, ROADMAP, SATELLITE, TERRAIN
                                            bounds_changed: function(e){
                                                if(first_load == 1){
                                                    get_bounds_map(map);
                                                    first_load = 0;
                                                }
                                            },
                                            dragend: function(e) {
                                                  //  get_bounds_map(map);
                                            },
                                            zoom_changed: function(e){
                                                  //  get_bounds_map(map);
                                            }
                                          
                                          });
/* ############## ATPL - DRAW MAP FUNCTIONALLITY ################## */  
                map.setOptions({gestureHandling: 'cooperative', mapTypeControlOptions: {
              style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
              position: google.maps.ControlPosition.BOTTOM_CENTER
          }});
                function drawFreeHand() {
                   
                    //the polygon
                    poly = new google.maps.Polyline({map: map.map, clickable: false});
                    poly.setOptions({strokeColor: '#307003',
                            fillColor: '#F29100',
                            strokeOpacity: 1,
                            strokeWeight: 2,
                            fillOpacity: 0.1});
                    //move-listener
                    var move = google.maps.event.addListener(map.map, 'mousemove', function (e) {
                        poly.getPath().push(e.latLng);

                    });

                    //mouseup-listener
                    google.maps.event.addListenerOnce(map.map, 'mouseup', function (e) {
                        google.maps.event.removeListener(move);
                        var path = poly.getPath();
                        poly.setMap(null);
                        poly = new google.maps.Polygon({map: map.map, path: path});
                        poly.setOptions({strokeColor: '#307003',
                            fillColor: '#F29100',
                            strokeOpacity: 1,
                            strokeWeight: 2,
                            fillOpacity: 0.1});
                        searchWithinPolygon();
                        google.maps.event.clearListeners(map.map.getDiv(), 'mousedown');
                        map.map.setOptions({draggableCursor:null});
                        $('body').css({'position':'inherit'});
                        enable()
                        
                        //get coordinates
                        var polypath = path;
                        var coordinates = [];
                        for (var i = 0 ; i < polypath.length ; i++) {
                          coordinates.push({
                            lat: polypath.getAt(i).lat(),
                            lng: polypath.getAt(i).lng()
                          });
                        }
                        var coordinateJsn = JSON.stringify(coordinates);  
                        
                        
                        map.setOptions({gestureHandling: 'cooperative'});
                    });
                }

                function disable() {
                    map.setOptions({
                        draggable: false,
                        zoomControl: false,
                        scrollwheel: false,
                        disableDoubleClickZoom: false
                    });
                }

                function enable() {
                    map.setOptions({
                        draggable: true,
                        zoomControl: true,
                        scrollwheel: true,
                        disableDoubleClickZoom: true
                    });
                }
                
                function searchWithinPolygon() {
                   // alert('search within it');
                   get_bounds_map_draw(map);
                }
               
                
                document.getElementById('toggle-drawing_li').addEventListener(
                    'click',
                    function(e) {
                        $('#deleteShape').show();
                       
                        // prevent scrolling
                        $('body').css({'position':'fixed', 'width': '100%'});
                        $('html, body').on('touchstart touchmove', function(e){ 
                            e.preventDefault(); 
                        });
                        // prevent scrolling
                        map.removeMarkers();
                        map.setOptions({draggableCursor:'crosshair', clickableIcons: false});
                        e.preventDefault();
                        disable()
                        google.maps.event.addDomListener(map.getDiv(), 'mousedown', function (e) {
                            drawFreeHand()
                        });
                        google.maps.event.addDomListener(map.getDiv(), 'touchstart', function (e) {
                            drawFreeHand()
                        });
                                 $('#toggle-drawing_li').hide();
                    });
                // This shows and hides (respectively) the drawing options.
                
                
               
                
              
                
            
            
/* ATPL */
                function load_results_map_draw(map,latn,lats,lnge,lngo){

                                   $("#map-loading").css("display","block");
                                   $("#map-title").css("display","none");
                                   $("#map-search").css({ opacity: 0.5 });
                                   $("#form-filter-search-map").css({ opacity: 0.5 });
                                   map.removeMarkers();

                                   serialize = $("#form-filter-search-map").serializeArray();

                                   str_url = [];
                                   tps = [];
                                   precio = "";
                                   currency = "";
                                   $.each(serialize, function(i,v){ 

                                       if(v["name"] != "locale"){
                                           if(v["name"] == "tipo_prop[]"){
                                               tps.push(v["value"]);
                                           }else if(v["name"] == "price-max"){
                                               precio = v["value"];
                                           }else if(v["name"] == "currency_max"){
                                               currency = v["value"];
                                           }else{
                                               str_url.push(v["name"]+"="+v["value"]);
                                           }
                                       }

                                   });

                                   vars_maps = "map=1&latn="+latn+"&lats="+lats+"&lnge="+lnge+"&lngo="+lngo+"&"+str_url.join("&")+"&price-max="+precio+"_"+currency+"&types="+tps.join(",");

                                                       ga('send', 'pageview', '/map/?'+vars_maps);

                                   $.getJSON(__JSON+"?action=search_map&"+vars_maps, function(response) { 

                                       if(response["status"] == 200){

                                           if(response["cantidad_resultados"] > 0){
/* ######### SAVE ZONE AREA STARTS ########### */
                    var searchName; var details; var link; var total;
                    var searchString = ''
                    for(var s=0; s<serialize.length; s++){
                        if(serialize[s].name == 'locale'){
                            searchName = serialize[s].value;
                        }
                        if(serialize[s].name == 'currency_max'){
                            searchString +=  '&currency_max='+serialize[s].value;
                            var currencymax = serialize[s].value;
                        }
                        if(serialize[s].name == 'price-max'){
                            searchString +=  '&price-max='+serialize[s].value;
                            var pricemax = serialize[s].value;
                        }
                        if(serialize[s].name == 'rooms'){
                            if(serialize[s].value == -1){
                                searchString +=  '&rooms=0';
                            }else{
                                searchString +=  '&rooms='+serialize[s].value;
                            }
                            var rooms = serialize[s].value;
                        }
                        if(serialize[s].name == 'baths'){
                            if(serialize[s].value == -1){
                                searchString +=  '&baths=0';
                            }else{
                                searchString +=  '&baths='+serialize[s].value;
                            }
                            var baths = serialize[s].value;
                        }
                        if(serialize[s].name == 'size-max'){
                            searchString +=  '&size-max='+serialize[s].value;
                            var sizemax = serialize[s].value;
                        }
                        
                        details = searchString;
                    }
                    link = window.location.href+searchString;
                    total= response["resultados"].length;
                    
                    $('#mapPersonalized').show();
                    $('#mapPersonalized').val('Su área personalizada en ');
                    
                    //alert(link);
                   // alert(searchName);
                    //console.log(JSON.stringify(serialize));
                    $('#mapCreateAlert').attr('onclick',"openPopUpSaveSearch('"+searchName+"', '"+details+"', '"+link+"', '"+total+"', '1')");
                    $('#saveSearchForm [name=sarea]').val($('#mapPersonalized').val()+searchName);        
                  //  $('#saveSearchForm [name=slink]').val(link);        
                   // $('#saveSearchForm [name=sdata]').val(details);        
                    $('#saveSearchForm [name=items]').val(total); 
                    $('#saveSearchForm [name=id_currency]').val(currencymax);        
                    $('#saveSearchForm [name=precio_max]').val(pricemax);        
                    $('#saveSearchForm [name=tamano_total_max]').val(sizemax);        
                    $('#saveSearchForm [name=banos]').val(baths);        
                    $('#saveSearchForm [name=habitaciones]').val(rooms);  
                    
                    $('#saveSearchFormLogin [name=sarea]').val($('#mapPersonalized').val()+searchName);        
                  //  $('#saveSearchFormLogin [name=slink]').val(link);        
                //    $('#saveSearchFormLogin [name=sdata]').val(details);        
                    $('#saveSearchFormLogin [name=items]').val(total); 
                    $('#saveSearchFormLogin [name=id_currency]').val(currencymax);        
                    $('#saveSearchFormLogin [name=precio_max]').val(pricemax);        
                    $('#saveSearchFormLogin [name=tamano_total_max]').val(sizemax);        
                    $('#saveSearchFormLogin [name=banos]').val(baths);        
                    $('#saveSearchFormLogin [name=habitaciones]').val(rooms);  
                    
                    $('#saveSearchFormLogin2 [name=sarea]').val($('#mapPersonalized').val()+searchName);        
                   // $('#saveSearchFormLogin2 [name=slink]').val(link);        
                  //  $('#saveSearchFormLogin2 [name=sdata]').val(details);        
                    $('#saveSearchFormLogin2 [name=items]').val(total); 
                    $('#saveSearchFormLogin2 [name=id_currency]').val(currencymax);        
                    $('#saveSearchFormLogin2 [name=precio_max]').val(pricemax);        
                    $('#saveSearchFormLogin2 [name=tamano_total_max]').val(sizemax);        
                    $('#saveSearchFormLogin2 [name=banos]').val(baths);        
                    $('#saveSearchFormLogin2 [name=habitaciones]').val(rooms);  
                    
                    // clearfms
                    $('#dialogSaveSearch #loadingSaveSearch').hide();
                    $('#dialogSaveSearch #searchSaved').hide();
                    $('#dialogSaveSearch #continueButtonSv').hide();
                    $('#dialogSaveSearch #saveSearchForm').show();
                    $('#dialogSaveSearch #button-sign-save').show();
                    
                    
                    
                    
                                // $('#mapCreateAlert').text(JSON.parse(JSON.stringify(serialize)));
/* ######### SAVE ZONE AREA ENDS ########### */
                                               $("#map-title").html(response["titulo"]);
                                               //console.log(poly);
                                               var rcount = 0;
                                                var proprtyIdForList = ''; // for store indb
                                               for(i=0;i<response["resultados"].length;i++){
                                                   // check if within polygon?
                                                   var position = new google.maps.LatLng(response["resultados"][i]["lat"], response["resultados"][i]["lng"]);
                                                   if (google.maps.geometry.poly.containsLocation(position, poly)) {
                                                       proprtyIdForList += response["resultados"][i]["propertyId"] + ','; 
                                                       
                                // end check if within polygon?
                                                       map.addMarker({
                                                       lat: response["resultados"][i]["lat"],
                                                       lng: response["resultados"][i]["lng"],
                                                       title: response["resultados"][i]["titulo"],
                                                       icon: response["resultados"][i]["icon"],
                                                       //animation: google.maps.Animation.DROP,
                                                       infoWindow: {
                                                         content: response["resultados"][i]["html"]
                                                       }
                                                     });
                                                     rcount++;
                                                 }
                                               }
                                               $('#saveSearchForm [name=items]').val(rcount); 
                                               $('#saveSearchFormLogin [name=items]').val(rcount); 
                                               $('#saveSearchFormLogin2 [name=items]').val(rcount); 
                                               $("#mapResults").html(rcount);
                                               $("#mapResults_res").html(rcount);
                                               $("#mapDepartProp").hide();
                                               $("#mapDepartProp_res").hide();
                                               $("#mapLocale, #mapLocale_res, #mapLocaleen, #mapLocaleen_res").hide();
                                               
                                               $("#mapOperation").text('propiedades en su área personalizada');
                                               $("#mapOperation_res").text('propiedades en su área personalizada');
                                               
                                               $('#opensavesearchForSavedDiv').hide();
                                               $('#opensavesearchForSavedP').show();
                                               
                                               $('#showifSaved').hide();
                                               $('#showifSavedRes').hide();
                                               $('#opensavesearch').show();
                                               
                                               $('#mapPersonalized').show();
                                              
                                               
                    
// store coords in db
var proprtyIds = proprtyIdForList.replace(/,\s*$/, "")
                        var polypath = poly.getPath();
                        var coordinates = [];
                            for (var i = 0 ; i < polypath.length ; i++) {
                              coordinates.push({
                                lat: polypath.getAt(i).lat(),
                                lng: polypath.getAt(i).lng()
                              });
                            }
                        var coordinateJsn = JSON.stringify(coordinates);  
                        var userId = 0;
                        //userId = $('#saveSearchForm[name=userId]').val;
                        //alert('userid'+userId);
                        var mapUrlWithShape;
                        $.getJSON(__JSON+"?action=store_coords&coords="+coordinateJsn+"&property_ids="+proprtyIds+"&user_id="+userId, function(response) { 

                                       if(response["status"] == 200){
                                           //alert(response["shapeId"]);
                                           var mapUrlCurent = removeParam('shape', window.location.href.replace('search', 'map-vista'));
                                           
                                           mapUrlWithShape = mapUrlCurent+'&shape='+response["shapeId"];
                                           mapUrlWithShape = changeLocaleParam(mapUrlWithShape, $('#locale').attr('data-value'));
                                           
                                           $('#polygonBounds').val(response["shapeId"]);
                                           $('#saveSearchForm [name=polygonBounds]').val(response["shapeId"]);  
                                           $('#saveSearchFormLogin [name=polygonBounds]').val(response["shapeId"]);  
                                           $('#saveSearchFormLogin2 [name=polygonBounds]').val(response["shapeId"]);  
                                           //alert('shapeId--'+mapUrlWithShape);
                                           $('#listParamsForSearch').attr('href',mapUrlWithShape.replace('map-vista', 'search'));
                                           
                                           $('#saveSearchForm [name=slink]').val(mapUrlWithShape);        
                                           $('#saveSearchFormLogin [name=slink]').val(mapUrlWithShape);        
                                           $('#saveSearchFormLogin2 [name=slink]').val(mapUrlWithShape);  
                                           
                                            //set params for fb
                                            $('#opensavesearch').attr('onclick' , "openPopUpSaveSearch('"+$('#mapPersonalized').val()+searchName+"', 'Su área personalizada', '"+mapUrlWithShape+"', '"+rcount+"', '1')");
                                       }else{
                                           alert('error');
                                           return false;
                                       } 
                        });
                        // store coords in db

                                           }else{
                                               alert("No se han encontrado resultados para su búsqueda");
                                                $('#mapResults').text('0');
                                                $('#mapResults_res').text('0');
                                               return false;
                                           }


                                       }else{
                                           alert("Hemos tenido un problema, intente nuevamente refrescando la página");
                                       }

                                       $("#map-loading").css("display","none");
                                       $("#map-title").css("display","block");
                                       $("#map-search").css({ opacity: 1 });
                                       $("#form-filter-search-map").css({ opacity: 1 });

                                   });
                               }

                function get_bounds_map_draw(map){
                   bounds = map.getBounds();
                   ne = bounds.getNorthEast();
                   sw = bounds.getSouthWest();
                   load_results_map_draw(map,ne.lat(),sw.lat(),ne.lng(),sw.lng());
               }
/* ATPL */
// show hide buttons
                $('#show-listings_li').hide();
                // show drawing tool bydefault 
                   //  drawingManager.setMap(map.map);
//                document.getElementById('show-listings_li').addEventListener(
//                    'click', showListings);
//                document.getElementById('hide-listings_li').addEventListener(
//                    'click', hideListings);
                document.getElementById('deleteShape').addEventListener(
                    'click', deleteShape);
//                document.getElementById('clearMap').addEventListener(
//                    'click', clearMap);
//                document.getElementById('mapCreateAlert').addEventListener(
//                    'click', mapCreateAlert);    
            function showListings() {
                $('#show-listings_li').hide();
                $('#hide-listings_li').show();
               
                get_bounds_map(map);
                
            }
            function hideListings() {
                $('#hide-listings_li').hide();
                $('#show-listings_li').show();
               
                map.removeMarkers();
               
                
            }
            function deleteShape() { 
                poly.setMap(null);
                $('#mapDepartProp').show();
                $('#mapDepartProp').text('');
                $('#mapDepartProp_res').show();
                $('#mapDepartProp_res').text('');
                $("#mapLocale, #mapLocale_res, #mapLocaleen, #mapLocaleen_res").show();
                
                $('#mapOperation').text($('#operation').find(":selected").text());
                $('#mapOperation_res').text($('#operation_res').find(":selected").text());
                
                
                get_bounds_map(map);
                $('#toggle-drawing_li').show();
                $('#deleteShape').hide();
                
                $('#mapPersonalized').hide();
                $('#mapPersonalized').val('');
                
            }
            
            function clearMap() {
                poly.setMap(null);
                map.removeMarkers();
                $('#deleteShape').hide();
                $('#locale').val('');
                $('#toggle-drawing_li').show();
                map.setOptions({gestureHandling: 'cooperative'});
            }
//            function mapCreateAlert(){
//                alert('working on this feature');
//            }
 /* ############## ATPL - DRAW MAP FUNCTIONALLITY ################## */   
                                    }
                                  }
                                });

                }else{

                
                var head = document.getElementsByTagName('head')[0];
                // Save the original method
                var insertBefore = head.insertBefore;
                // Replace it!
                head.insertBefore = function (newElement, referenceElement) {
                    if (newElement.href && newElement.href.indexOf('https://fonts.googleapis.com/css?family=Roboto') === 0) {
                        return;
                    }
                    insertBefore.call(head, newElement, referenceElement);
                };

                 map = new GMaps({
                    div: '#map-search',
                    lat: lat, 
                    lng: lng,
                    zoom: 14,
                    mapType: "ROADMAP", // HYBRID, ROADMAP, SATELLITE, TERRAIN
                    bounds_changed: function(e){
                        if(first_load == 1){
                            get_bounds_map(map);
                            first_load = 0;
                        }
                    },
                    dragend: function(e) {
                            //get_bounds_map(map);
                    },
                    zoom_changed: function(e){
                            //get_bounds_map(map);
                    }
                  
                  });
                  /* ############## ATPL - DRAW MAP FUNCTIONALLITY ################## */  
                map.setOptions({gestureHandling: 'cooperative', mapTypeControlOptions: {
              style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
              position: google.maps.ControlPosition.BOTTOM_CENTER
          }});
                function drawFreeHand() {
                   
                    //the polygon
                    poly = new google.maps.Polyline({map: map.map, clickable: false});
                    poly.setOptions({strokeColor: '#307003',
                            fillColor: '#F29100',
                            strokeOpacity: 1,
                            strokeWeight: 2,
                            fillOpacity: 0.1});
                    //move-listener
                    var move = google.maps.event.addListener(map.map, 'mousemove', function (e) {
                        poly.getPath().push(e.latLng);

                    });

                    //mouseup-listener
                    google.maps.event.addListenerOnce(map.map, 'mouseup', function (e) {
                        google.maps.event.removeListener(move);
                        var path = poly.getPath();
                        poly.setMap(null);
                        poly = new google.maps.Polygon({map: map.map, path: path});
                        poly.setOptions({strokeColor: '#307003',
                            fillColor: '#F29100',
                            strokeOpacity: 1,
                            strokeWeight: 2,
                            fillOpacity: 0.1});
                        searchWithinPolygon();
                        google.maps.event.clearListeners(map.map.getDiv(), 'mousedown');
                        map.map.setOptions({draggableCursor:null});
                        $('body').css({'position':'inherit'});
                        enable()
                        
                        //get coordinates
                        var polypath = path;
                        var coordinates = [];
                        for (var i = 0 ; i < polypath.length ; i++) {
                          coordinates.push({
                            lat: polypath.getAt(i).lat(),
                            lng: polypath.getAt(i).lng()
                          });
                        }
                        var coordinateJsn = JSON.stringify(coordinates);   
                        
                        //$('#polygonBounds').val(polypath.getArray());
 
                        map.setOptions({gestureHandling: 'cooperative'});
                    });
                }

                function disable() {
                    map.setOptions({
                        draggable: false,
                        zoomControl: false,
                        scrollwheel: false,
                        disableDoubleClickZoom: false
                    });
                }

                function enable() {
                    map.setOptions({
                        draggable: true,
                        zoomControl: true,
                        scrollwheel: true,
                        disableDoubleClickZoom: true
                    });
                }
                
                function searchWithinPolygon() {
                   // alert('search within it');
                   get_bounds_map_draw(map);
                }
               
                
                document.getElementById('toggle-drawing_li').addEventListener(
                    'click',
                    function(e) {
                        $('#deleteShape').show();
                       
                        // prevent scrolling
                        $('body').css({'position':'fixed'});
                        $('html, body').on('touchstart touchmove', function(e){ 
                            e.preventDefault(); 
                        });
                        // prevent scrolling
                        map.removeMarkers();
                        map.setOptions({draggableCursor:'crosshair'});
                        e.preventDefault();
                        disable()
                        google.maps.event.addDomListener(map.getDiv(), 'mousedown', function (e) {
                            drawFreeHand()
                        });
                        google.maps.event.addDomListener(map.getDiv(), 'touchstart', function (e) {
                            drawFreeHand()
                        });
                                 $('#toggle-drawing_li').hide();
                    });
                // This shows and hides (respectively) the drawing options.
                
                
               
                
              
                
            
            
/* ATPL */
                function load_results_map_draw(map,latn,lats,lnge,lngo){

                                   $("#map-loading").css("display","block");
                                   $("#map-title").css("display","none");
                                   $("#map-search").css({ opacity: 0.5 });
                                   $("#form-filter-search-map").css({ opacity: 0.5 });
                                   map.removeMarkers();

                                   serialize = $("#form-filter-search-map").serializeArray();

                                   str_url = [];
                                   tps = [];
                                   precio = "";
                                   currency = "";
                                   $.each(serialize, function(i,v){ 

                                       if(v["name"] != "locale"){
                                           if(v["name"] == "tipo_prop[]"){
                                               tps.push(v["value"]);
                                           }else if(v["name"] == "price-max"){
                                               precio = v["value"];
                                           }else if(v["name"] == "currency_max"){
                                               currency = v["value"];
                                           }else{
                                               str_url.push(v["name"]+"="+v["value"]);
                                           }
                                       }

                                   });

                                   vars_maps = "map=1&latn="+latn+"&lats="+lats+"&lnge="+lnge+"&lngo="+lngo+"&"+str_url.join("&")+"&price-max="+precio+"_"+currency+"&types="+tps.join(",");

                                                       ga('send', 'pageview', '/map/?'+vars_maps);

                                   $.getJSON(__JSON+"?action=search_map&"+vars_maps, function(response) { 

                                       if(response["status"] == 200){

                                           if(response["cantidad_resultados"] > 0){
/* ######### SAVE ZONE AREA STARTS ########### */
                    var searchName; var details; var link; var total;
                    var searchString = ''
                    for(var s=0; s<serialize.length; s++){
                        if(serialize[s].name == 'locale'){
                            searchName = serialize[s].value;
                        }
                        if(serialize[s].name == 'currency_max'){
                            searchString +=  '&currency_max='+serialize[s].value;
                            var currencymax = serialize[s].value;
                        }
                        if(serialize[s].name == 'price-max'){
                            searchString +=  '&price-max='+serialize[s].value;
                            var pricemax = serialize[s].value;
                        }
                        if(serialize[s].name == 'rooms'){
                            if(serialize[s].value == -1){
                                searchString +=  '&rooms=0';
                            }else{
                                searchString +=  '&rooms='+serialize[s].value;
                            }
                            var rooms = serialize[s].value;
                        }
                        if(serialize[s].name == 'baths'){
                            if(serialize[s].value == -1){
                                searchString +=  '&baths=0';
                            }else{
                                searchString +=  '&baths='+serialize[s].value;
                            }
                            var baths = serialize[s].value;
                        }
                        if(serialize[s].name == 'size-max'){
                            searchString +=  '&size-max='+serialize[s].value;
                            var sizemax = serialize[s].value;
                        }
                        
                        details = searchString;
                    }
                    link = window.location.href+searchString;
                    link = changeLocaleParam(link, $('#locale').attr('data-value'));
                    total= response["resultados"].length;
                    
                    $('#mapPersonalized').show();
                    $('#mapPersonalized').val('Su área personalizada en ');
                    //alert(link);
                   // alert(searchName);
                    //console.log(JSON.stringify(serialize));
                    $('#mapCreateAlert').attr('onclick',"openPopUpSaveSearch('"+searchName+"', '"+details+"', '"+link+"', '"+total+"', '1')");
                    $('#saveSearchForm [name=sarea]').val($('#mapPersonalized').val()+searchName);        
                    //link = removeDuplicatesFromUrl(link);
                    $('#saveSearchForm [name=slink]').val(removeDuplicatesFromUrl(link));        
                    //$('#saveSearchForm [name=sdata]').val(details);        
                    $('#saveSearchForm [name=items]').val(total); 
                    $('#saveSearchForm [name=id_currency]').val(currencymax);        
                    $('#saveSearchForm [name=precio_max]').val(pricemax);        
                    $('#saveSearchForm [name=tamano_total_max]').val(sizemax);        
                    $('#saveSearchForm [name=banos]').val(baths);        
                    $('#saveSearchForm [name=habitaciones]').val(rooms);  
                    
                    $('#saveSearchFormLogin [name=sarea]').val($('#mapPersonalized').val()+searchName);        
                    $('#saveSearchFormLogin [name=slink]').val(removeDuplicatesFromUrl(link));        
                    //$('#saveSearchFormLogin [name=sdata]').val(details);        
                    $('#saveSearchFormLogin [name=items]').val(total); 
                    $('#saveSearchFormLogin [name=id_currency]').val(currencymax);        
                    $('#saveSearchFormLogin [name=precio_max]').val(pricemax);        
                    $('#saveSearchFormLogin [name=tamano_total_max]').val(sizemax);        
                    $('#saveSearchFormLogin [name=banos]').val(baths);        
                    $('#saveSearchFormLogin [name=habitaciones]').val(rooms);  
                    
                    $('#saveSearchFormLogin2 [name=sarea]').val($('#mapPersonalized').val()+searchName);        
                    $('#saveSearchFormLogin2 [name=slink]').val(removeDuplicatesFromUrl(link));        
                    //$('#saveSearchFormLogin2 [name=sdata]').val(details);        
                    $('#saveSearchFormLogin2 [name=items]').val(total); 
                    $('#saveSearchFormLogin2 [name=id_currency]').val(currencymax);        
                    $('#saveSearchFormLogin2 [name=precio_max]').val(pricemax);        
                    $('#saveSearchFormLogin2 [name=tamano_total_max]').val(sizemax);        
                    $('#saveSearchFormLogin2 [name=banos]').val(baths);        
                    $('#saveSearchFormLogin2 [name=habitaciones]').val(rooms);  
                    
                    // clearfms
                    $('#dialogSaveSearch #loadingSaveSearch').hide();
                    $('#dialogSaveSearch #searchSaved').hide();
                    $('#dialogSaveSearch #continueButtonSv').hide();
                    $('#dialogSaveSearch #saveSearchForm').show();
                    $('#dialogSaveSearch #button-sign-save').show();
                    
                    
                                // $('#mapCreateAlert').text(JSON.parse(JSON.stringify(serialize)));
/* ######### SAVE ZONE AREA ENDS ########### */
                                               $("#map-title").html(response["titulo"]);
                                              // console.log(poly);
                                               var proprtyIdForList = ''; // for store indb
                                               var rcount = 0;
                                               for(i=0;i<response["resultados"].length;i++){
                                                   // check if within polygon?
                                                   var position = new google.maps.LatLng(response["resultados"][i]["lat"], response["resultados"][i]["lng"]);
                                                   if (google.maps.geometry.poly.containsLocation(position, poly)) {
                                                       proprtyIdForList += response["resultados"][i]["propertyId"] + ','; 
                                                       //alert('after shapeid->'+mapUrlWithShape);
                                                   // end check if within polygon?
                                                       map.addMarker({
                                                       lat: response["resultados"][i]["lat"],
                                                       lng: response["resultados"][i]["lng"],
                                                       title: response["resultados"][i]["titulo"],
                                                       icon: response["resultados"][i]["icon"],
                                                       //animation: google.maps.Animation.DROP,
                                                       infoWindow: {
                                                         content: response["resultados"][i]["html"]
                                                       }
                                                     });
                                                     rcount++;
                                                 }
                                               }
                                               $('#saveSearchForm [name=items]').val(rcount); 
                                               $('#saveSearchFormLogin [name=items]').val(rcount); 
                                               $('#saveSearchFormLogin2 [name=items]').val(rcount); 
                                               $("#mapResults").html(rcount);
                                               $("#mapResults_res").html(rcount);
                                               
                                               $("#mapDepartProp").hide();
                                               $("#mapDepartProp_res").hide();
                                               $("#mapLocale, #mapLocale_res, #mapLocaleen, #mapLocaleen_res").hide();
                                               
                                               $("#mapOperation").text('propiedades en su área personalizada');
                                               $("#mapOperation_res").text('propiedades en su área personalizada');
                                               
                                               $('#opensavesearchForSavedDiv').hide();
                                               $('#opensavesearchForSavedP').show();
                                               
                                               $('#showifSaved').hide();
                                               $('#showifSavedRes').hide();
                                               $('#opensavesearch').show();
                                               
                                               $('#mapPersonalized').show();
// store coords in db
var proprtyIds = proprtyIdForList.replace(/,\s*$/, "")
                        var polypath = poly.getPath();
                        var coordinates = [];
                            for (var i = 0 ; i < polypath.length ; i++) {
                              coordinates.push({
                                lat: polypath.getAt(i).lat(),
                                lng: polypath.getAt(i).lng()
                              });
                            }
                        var coordinateJsn = JSON.stringify(coordinates);  
                        var userId = 0;
                        //userId = $('#saveSearchForm[name=userId]').val;
                        //alert('userid'+userId);
                        var mapUrlWithShape;
                        $.getJSON(__JSON+"?action=store_coords&coords="+coordinateJsn+"&property_ids="+proprtyIds+"&user_id="+userId, function(response) { 

                                       if(response["status"] == 200){
                                           //alert(response["shapeId"]);
                                           var mapUrlCurent = window.location.href.replace('search', 'map-vista');
                                           mapUrlWithShape = mapUrlCurent+'&shape='+response["shapeId"];
                                           $('#polygonBounds').val(response["shapeId"]);
                                           $('#saveSearchForm [name=polygonBounds]').val(response["shapeId"]);  
                                           $('#saveSearchFormLogin [name=polygonBounds]').val(response["shapeId"]);  
                                           $('#saveSearchFormLogin2 [name=polygonBounds]').val(response["shapeId"]);  
                                           //alert('shapeId--'+mapUrlWithShape);
                                           $('#listParamsForSearch').attr('href',mapUrlWithShape);
                                           //set params for fb
                                            $('#opensavesearch').attr('onclick' , "openPopUpSaveSearch('"+$('#mapPersonalized').val()+searchName+"', 'Su área personalizada', '"+mapUrlWithShape+"', '"+rcount+"', '1')");
                                       
                                       }else{
                                           alert('error');
                                           return false;
                                       } 
                        });
                        // store coords in db

                                           }else{
                                               alert("No se han encontrado resultados para su búsqueda");
                                                $('#mapResults').text('0');
                                                $('#mapResults_res').text('0');
                                               return false;
                                           }


                                       }else{
                                           alert("Hemos tenido un problema, intente nuevamente refrescando la página");
                                       }

                                       $("#map-loading").css("display","none");
                                       $("#map-title").css("display","block");
                                       $("#map-search").css({ opacity: 1 });
                                       $("#form-filter-search-map").css({ opacity: 1 });

                                   });
                               }

                function get_bounds_map_draw(map){
                   bounds = map.getBounds();
                   ne = bounds.getNorthEast();
                   sw = bounds.getSouthWest();
                   load_results_map_draw(map,ne.lat(),sw.lat(),ne.lng(),sw.lng());
               }
/* ATPL */
// show hide buttons
                $('#show-listings_li').hide();
                // show drawing tool bydefault 
                   //  drawingManager.setMap(map.map);
//                document.getElementById('show-listings_li').addEventListener(
//                    'click', showListings);
//                document.getElementById('hide-listings_li').addEventListener(
//                    'click', hideListings);
                document.getElementById('deleteShape').addEventListener(
                    'click', deleteShape);
//                document.getElementById('clearMap').addEventListener(
//                    'click', clearMap);
//                document.getElementById('mapCreateAlert').addEventListener(
//                    'click', mapCreateAlert);    
            function showListings() {
                $('#show-listings_li').hide();
                $('#hide-listings_li').show();
               
                get_bounds_map(map);
                
            }
            function hideListings() {
                $('#hide-listings_li').hide();
                $('#show-listings_li').show();
               
                map.removeMarkers();
               
                
            }
            function deleteShape() { 
                poly.setMap(null);
                $('#mapDepartProp').show();
                $('#mapDepartProp').text('');
                $('#mapDepartProp_res').show();
                $('#mapDepartProp_res').text('');
                $("#mapLocale, #mapLocale_res, #mapLocaleen, #mapLocaleen_res").show();
                
                $('#mapOperation').text($('#operation').find(":selected").text());
                $('#mapOperation_res').text($('#operation_res').find(":selected").text());
                
                
                get_bounds_map(map);
                $('#toggle-drawing_li').show();
                $('#deleteShape').hide();
                
                $('#mapPersonalized').hide();
                $('#mapPersonalized').val('');
            }
            
            function clearMap() {
                poly.setMap(null);
                map.removeMarkers();
                $('#deleteShape').hide();
                $('#locale').val('');
                $('#toggle-drawing_li').show();
                map.setOptions({gestureHandling: 'cooperative'});
            }
//            function mapCreateAlert(){
//                alert('working on this feature');
//            }
 /* ############## ATPL - DRAW MAP FUNCTIONALLITY ################## */   
                

             }



                $("#form-filter-search-map #locale").autocomplete({
                            minLength: 3,
                            source: __JSON+"?action=autocomplete_city",
                            select: function(e,ui){
                                $(this).attr("data-value",ui["item"]["code"]);
                                $('#mapLocale').text(ui["item"]["label"].split(" - ")[0]);
                                var SearchUrl = $('#listParamsForSearch').attr('href');
                                $('#listParamsForSearch').attr('href',removeDuplicatesFromUrl(changeLocaleParam(SearchUrl, ui["item"]["code"])));
                                
                                //var mapResetLink = $('#mapResetLink').attr('href');
                                //$('#mapResetLink').attr('href',changeLocaleParam(mapResetLink, ui["item"]["code"]));
                                
                                GMaps.geocode({
                                  address: ui["item"]["label"].split(" - ").reverse().join(", ")+", "+__PAIS,
                                  callback: function(results, status){
                                    if(status=='OK'){
                                      var latlng = results[0].geometry.location;
                                      map.setCenter(latlng.lat(), latlng.lng());
                                      get_bounds_map(map);
                                    }
                                  }
                                });
                        }

                });
                $("#form-filter-search-map_res #locale").autocomplete({
                            minLength: 3,
                            source: __JSON+"?action=autocomplete_city",
                            select: function(e,ui){
                                $(this).attr("data-value",ui["item"]["code"]);
                                $('#mapLocale_res').text(ui["item"]["label"].split(" - ")[0]);
                                
                                var mapResetLink_res = $('#mapResetLink_res').attr('href');
                                $('#mapResetLink_res').attr('href',changeLocaleParam(mapResetLink_res, ui["item"]["code"]));
                                
                                GMaps.geocode({
                                  address: ui["item"]["label"].split(" - ").reverse().join(", ")+", "+__PAIS,
                                  callback: function(results, status){
                                    if(status=='OK'){
                                      var latlng = results[0].geometry.location;
                                      map.setCenter(latlng.lat(), latlng.lng());
                                      get_bounds_map(map);
                                    }
                                  }
                                });
                        }

                });



                var inputs = get_inputs_form('form-filter-search-map');

                $.each(inputs, function(i,v){

                    $("#"+v).keypress(function( event ) {
                      if ( event.which == 13 ) {
                         get_bounds_map(map);
                      }
                    }); 

                });


                $('input').on('ifChecked', function(event){
                 get_bounds_map(map);
                });

                $('input').on('ifUnchecked', function(event){
                 get_bounds_map(map);
                });

                $('#operation').change(function(e){
                    
                    get_bounds_map(map);
                    switch ($(this).val()) {
                        case '-1':
                            $('#mapOperation').text('');
                            break;
                        case '1': // 
                            $('#mapOperation').text('Arriendo');
                            break;
                        case '2':
                            $('#mapOperation').text('Venta');
                            break;
                        case '3':
                            $('#mapOperation').text('Compartir');
                            break;  
                        case '4':
                            $('#mapOperation').text('Arriendo vacaciones');
                            break;  
                        case '5':
                            $('#mapOperation').text('Traspaso');
                            break;  
                        case '6':
                            $('#mapOperation').text('Remate');
                            break;  
                        case '7':
                            $('#mapOperation').text('Arriendo temporada');
                            break;  
                        case '8':
                            $('#mapOperation').text('Arriendo diario');
                            break;  
                        default:
                            $('#mapOperation').text('');
                    }
                });
                
                $('#operation_res').change(function(e){
                    get_bounds_map(map);
                    switch ($(this).val()) {
                        case '-1':
                            $('#mapOperation_res').text('');
                            break;
                        case '1': // 
                            $('#mapOperation_res').text('Arriendo');
                            break;
                        case '2':
                            $('#mapOperation_res').text('Venta');
                            break;
                        case '3':
                            $('#mapOperation_res').text('Compartir');
                            break;  
                        case '4':
                            $('#mapOperation_res').text('Arriendo vacaciones');
                            break;  
                        case '5':
                            $('#mapOperation_res').text('Traspaso');
                            break;  
                        case '6':
                            $('#mapOperation_res').text('Remate');
                            break;  
                        case '7':
                            $('#mapOperation_res').text('Arriendo temporada');
                            break;  
                        case '8':
                            $('#mapOperation_res').text('Arriendo diario');
                            break;  
                        default:
                            $('#mapOperation_res').text('');
                    }
                });
                
                $('#age').change(function(e){
                    get_bounds_map(map);
                });
                $('#age_res').change(function(e){
                    get_bounds_map(map);
                });

                $('#rooms').change(function(e){
                    get_bounds_map(map);
                });
                
                $('#rooms_res').change(function(e){
                    get_bounds_map(map);
                });

                $('#baths').change(function(e){
                    get_bounds_map(map);
                });
                
                $('#baths_res').change(function(e){
                    get_bounds_map(map);
                });

                $('#currency_max').change(function(e){
                    get_bounds_map(map);
                });
                
                $('#currency_max_res').change(function(e){
                    get_bounds_map(map);
                });

                $('#currency_min').change(function(e){
                    get_bounds_map(map);
                });
                
                $('#currency_min_res').change(function(e){
                    get_bounds_map(map);
                });
                
                
                $("#price-max").blur(function(e){
                    get_bounds_map(map);
                });
                
                $("#price-max_res").blur(function(e){
                    get_bounds_map(map);
                });
                
                $("#price-min").blur(function(e){
                    get_bounds_map(map);
                });
                
                $("#price-min_res").blur(function(e){
                    get_bounds_map(map);
                });

                $("#size-max").blur(function(e){
                    get_bounds_map(map);
                });
                $("#size-max_res").blur(function(e){
                    get_bounds_map(map);
                });
                
                $("#size-min").blur(function(e){
                    get_bounds_map(map);
                });
                $("#size-min_res").blur(function(e){
                    get_bounds_map(map);
                });



    }


 





    if($("#form-filter-search").exists() && $("#form-filter-search").is(":visible")){
        var locale = $("#locale").attr("data-value");
        var page = 1;
        var sort = $("#sort").val();

        function form_search_submit(redirect,form){
            s = $("#"+form).serializeArray();
            str_url = [];
            cmi = "";
            cma = "";
            pmi = "";
            pma = "";
            tp = [];

            //console.log(s);
            //console.log("wtf!");

            $.each(s, function(i,v){

                if(v["name"] == "locale"){
                    if($("#"+form+" #locale_aux").val() != "-1"){
                        str_url.push(v["name"]+"="+$("#"+form+" #locale_aux").val());
                    }
                }else if(v["name"] == "price-min"){
                    pmi = v["value"];
                }else if(v["name"] == "price-max"){
                    pma = v["value"];
                }else if(v["name"] == "currency_min"){
                    cmi = v["value"];
                }else if(v["name"] == "currency_max"){
                    cma = v["value"];
                }else if(v["name"] == "size-min"){
                    if(v["value"] != "0" && $.trim(v["value"]) != ""){
                        str_url.push(v["name"]+"="+v["value"]+"_m2");
                    }
                }else if(v["name"] == "size-max"){
                    if(v["value"] != "0" && $.trim(v["value"]) != ""){
                        str_url.push(v["name"]+"="+v["value"]+"_m2");
                    }
                }else if(v["name"] == "tipo_prop[]"){
                    tp.push(v["value"]);
                }else{
                    if(v["value"] != "-1" && $.trim(v["value"]) != ""){
                        str_url.push(v["name"]+"="+v["value"]);
                    }
                }


            });

                if(pmi != 0 && $.trim(pmi) != ""){
                    str_url.push("price-min="+pmi+"_"+cmi);
                }

                if(pma != 0 && $.trim(pma) != ""){
                    str_url.push("price-max="+pma+"_"+cma);
                }

                if(page > 1){
                    if(redirect != 1){
                        str_url.push("page=1");
                    }else{
                        str_url.push("page="+page);
                    }
                    
                }

                if(tp.length > 0){
                    str_url.push("types="+tp.join(","));
                }

            if(redirect == 1){
                self.location.href=location_path+"?"+str_url.join("&");
            }else{

                $("#loading-data").css("display","block");
                $("#results").css("opacity",0);
                $("html, body").animate({ scrollTop: $('#header-title').offset().top }, 1000);
                //$("html, body").animate({ scrollTop: $('.wide_container').offset().top }, 1000);

				ga('send', 'pageview', '/search/?'+str_url.join("&"));

                //console.log(location_path);
                if(location_path.indexOf('/de') != -1){
                    var searchurl = window.origin+'/search';
                    self.location.href=searchurl+"?"+str_url.join("&");
                }
                else{
                    self.location.href=location_path+"?"+str_url.join("&");
                }

                /*$.getJSON(__JSON+"?action=get_ads_search&"+str_url.join("&"), function(response) {

                    $("#loading-data").css("display","none");
                    $("#results").css("opacity",1);

                    if(response["title"] != ""){
                        $("#results_title").html(response["title"]);
                    }
                    
                    $("#results").html(response["results_data"]);
                    $("#results_count").html(response["results_count_text"]);
                    $("#results_pagination").html(response["pagination"]);

                    self.location.href="#!"+str_url.join("&");

                });*/

                

            }    

            

        }

        
        /*var inputs = get_inputs_form('form-filter-search');

        $.each(inputs, function(i,v){

            $("#"+v).keypress(function( event ) {
              if ( event.which == 13 ) {
                 form_search_submit();
              }
            }); 

            if(v != "currency_min" && v != "currency_max"){

                get_type = $("#"+v).getType();

                switch(get_type){

                    case "checkbox":    $(document).on('ifChecked',"#"+v, function(e){ form_search_submit(); });
                                        $(document).on('ifUnchecked',"#"+v, function(e){ form_search_submit(); });
                                        break;

                    case "text":        $("#"+v).on("blur",function(e){ form_search_submit(); });
                                        break;

                    case "select":      $("#"+v).on("change",function(e){ form_search_submit(); });
                                        break;


                }

            }

        });*/

            $("#form-filter-search #locale").autocomplete({
                minLength: 3,
                source: __JSON+"?action=autocomplete_city",
                search  : function(){$("#loading_locale").css('display',"block"); },
                open    : function(){$("#loading_locale").css('display',"none"); },
                select: function(e,ui){
                    $(this).attr("data-value",ui["item"]["code"]);
                    loc_gen = ui["item"]["label"];
                    //form_search_submit();

                    $("#form-filter-search #locale_aux").val(ui["item"]["code"]);
                }

            }); 

            $("#form-filter-search-m #locale").autocomplete({
                minLength: 3,
                source: __JSON+"?action=autocomplete_city",
                search  : function(){$("#loading_locale").css('display',"block"); },
                open    : function(){$("#loading_locale").css('display',"none"); },
                select: function(e,ui){
                    $(this).attr("data-value",ui["item"]["code"]);
                    loc_gen = ui["item"]["label"];
                    //form_search_submit();

                    $("#form-filter-search-m #locale_aux").val(ui["item"]["code"]);
                }

            }); 

            $(document).on('click',".pagination li a", function(e){ 

                page = $(this).attr("data-value");
                form_search_submit(1);

                if($("#form-filter-search").is(":visible")){
                    form_search_submit(1,"form-filter-search");
                }else{
                    form_search_submit(1,"form-filter-search-m");
                }

                return false;

            });

// ATPL
            $("#display-prices").on('change', function(e){
                form_search_submit(0,"form-filter-search");
            });
            $("#display-prices_resp").on('change', function(e){
                form_search_submit(0,"form-filter-search");
            });
            $("#sort").on('change', function(e){
                form_search_submit(0,"form-filter-search");
            });
            $("#sort_resp").on('change', function(e){
                form_search_submit(0,"form-filter-search");
            });
            
            $("#form-filter-search #button-filter-search-up").click(function(e){
                form_search_submit(0,"form-filter-search");
            });

            $("#form-filter-search #button-filter-search-down").click(function(e){
                form_search_submit(0,"form-filter-search");
            });

            $("#form-filter-search-m #button-filter-search-up-m").click(function(e){
                form_search_submit(0,"form-filter-search-m");
                $('#navbar').collapse('hide');
            });

            $("#form-filter-search-m #button-filter-search-down-m").click(function(e){
                form_search_submit(0,"form-filter-search-m");
                $('#navbar').collapse('hide');
            });

            var surl = location_href.split("#");
            if(surl.length > 1){
              if(location_path.indexOf('/de') == -1){
                if($("#form-filter-search").is(":visible")){
                    form_search_submit(0,"form-filter-search");
                }else{
                    form_search_submit(0,"form-filter-search-m");
                }
              }

            }
    }
    
    if($("#form-filter-search_res").exists() && $("#form-filter-search_res").is(":visible")){
        var locale = $("#locale").attr("data-value");
        var page = 1;
        var sort = $("#sort").val();

        function form_search_submit(redirect,form){
            s = $("#"+form).serializeArray();
            str_url = [];
            cmi = "";
            cma = "";
            pmi = "";
            pma = "";
            tp = [];

            //console.log(s);

            $.each(s, function(i,v){

                if(v["name"] == "locale"){
                    if($("#"+form+" #locale_aux").val() != "-1"){
                        str_url.push(v["name"]+"="+$("#"+form+" #locale_aux").val());
                    }
                }else if(v["name"] == "price-min"){
                    pmi = v["value"];
                }else if(v["name"] == "price-max"){
                    pma = v["value"];
                }else if(v["name"] == "currency_min"){
                    cmi = v["value"];
                }else if(v["name"] == "currency_max"){
                    cma = v["value"];
                }else if(v["name"] == "size-min"){
                    if(v["value"] != "0" && $.trim(v["value"]) != ""){
                        str_url.push(v["name"]+"="+v["value"]+"_m2");
                    }
                }else if(v["name"] == "size-max"){
                    if(v["value"] != "0" && $.trim(v["value"]) != ""){
                        str_url.push(v["name"]+"="+v["value"]+"_m2");
                    }
                }else if(v["name"] == "tipo_prop[]"){
                    tp.push(v["value"]);
                }else{
                    if(v["value"] != "-1" && $.trim(v["value"]) != ""){
                        str_url.push(v["name"]+"="+v["value"]);
                    }
                }


            });

                if(pmi != 0 && $.trim(pmi) != ""){
                    str_url.push("price-min="+pmi+"_"+cmi);
                }

                if(pma != 0 && $.trim(pma) != ""){
                    str_url.push("price-max="+pma+"_"+cma);
                }

                if(page > 1){
                    if(redirect != 1){
                        str_url.push("page=1");
                    }else{
                        str_url.push("page="+page);
                    }
                    
                }

                if(tp.length > 0){
                    str_url.push("types="+tp.join(","));
                }

            if(redirect == 1){
                self.location.href=location_path+"?"+str_url.join("&");
            }else{

                $("#loading-data").css("display","block");
                $("#results").css("opacity",0);
                $("html, body").animate({ scrollTop: $('#header-title').offset().top }, 1000);

				ga('send', 'pageview', '/search/?'+str_url.join("&"));

                //console.log(location_path);
                if(location_path.indexOf('/de') != -1){
                    var searchurl = window.origin+'/search';
                    self.location.href=searchurl+"?"+str_url.join("&");
                }
                else{
                    self.location.href=location_path+"?"+str_url.join("&");
                }

            }    

            

        }

            $("#form-filter-search_res #locale").autocomplete({
                minLength: 3,
                source: __JSON+"?action=autocomplete_city",
                search  : function(){$("#loading_locale").css('display',"block"); },
                open    : function(){$("#loading_locale").css('display',"none"); },
                select: function(e,ui){
                    $(this).attr("data-value",ui["item"]["code"]);
                    loc_gen = ui["item"]["label"];
                    //form_search_submit();

                    $("#form-filter-search_res #locale_aux").val(ui["item"]["code"]);
                }

            }); 

            $("#form-filter-search-m #locale").autocomplete({
                minLength: 3,
                source: __JSON+"?action=autocomplete_city",
                search  : function(){$("#loading_locale").css('display',"block"); },
                open    : function(){$("#loading_locale").css('display',"none"); },
                select: function(e,ui){
                    $(this).attr("data-value",ui["item"]["code"]);
                    loc_gen = ui["item"]["label"];
                    //form_search_submit();

                    $("#form-filter-search-m #locale_aux").val(ui["item"]["code"]);
                }

            }); 

            $(document).on('click',".pagination li a", function(e){ 

                page = $(this).attr("data-value");
                form_search_submit(1);

                if($("#form-filter-search_res").is(":visible")){
                    form_search_submit(1,"form-filter-search_res");
                }else{
                    form_search_submit(1,"form-filter-search-m");
                }

                return false;

            });

// ATPL
            $("#display-prices").on('change', function(e){
                form_search_submit(0,"form-filter-search_res");
            });
            $("#display-prices_res").on('change', function(e){
                form_search_submit(0,"form-filter-search_res");
            });
            $("#sort").on('change', function(e){
                form_search_submit(0,"form-filter-search_res");
            });
            $("#sort_res").on('change', function(e){
                form_search_submit(0,"form-filter-search_res");
            });
            
            $("#form-filter-search_res #button-filter-search-up").click(function(e){
                form_search_submit(0,"form-filter-search_res");
            });

            $("#form-filter-search_res #button-filter-search-down").click(function(e){
                form_search_submit(0,"form-filter-search_res");
            });

            $("#form-filter-search-m #button-filter-search-up-m").click(function(e){
                form_search_submit(0,"form-filter-search-m");
                $('#navbar').collapse('hide');
            });

            $("#form-filter-search-m #button-filter-search-down-m").click(function(e){
                form_search_submit(0,"form-filter-search-m");
                $('#navbar').collapse('hide');
            });

            var surl = location_href.split("#");
            if(surl.length > 1){
              if(location_path.indexOf('/de') == -1){
                if($("#form-filter-search_res").is(":visible")){
                    form_search_submit(0,"form-filter-search_res");
                }else{
                    form_search_submit(0,"form-filter-search-m");
                }
              }

            }
    }




    $("#form-contact").submit(function(e){

            $("#submit").css("display","none");
             $("#loading").css("display","block");
             $("#form-contact-content").css("display","block");
             $("#send-ok").css("display","none");
             $("#send-fail").css("display","none");

        $.getJSON(__JSON+"?action=contact-doomos&"+$(this).serialize(), function(response) {

            if(response["status"] == 200){

                $("#submit").css("display","none");
                $("#loading").css("display","none");
                $("#form-contact-content").css("display","none");
                $("#send-ok").css("display","block");
                $("#send-fail").css("display","none");

            }else{

                $("#submit").css("display","block");
                $("#loading").css("display","none");
                $("#form-contact-content").css("display","block");
                $("#send-ok").css("display","none");
                $("#send-fail").css("display","block");

                grecaptcha.reset();


            }

        });


        return false;
    });


    function select_home_change(input,text,value){

        $('#'+input+' > li').each(function(){
            $this = $(this);
            $this.children().removeClass("active");
            if($this.children().attr("data-value") == value){
                $this.children().addClass("active");
            }
        });

        $("#"+input).addClass("active");
        $('#'+input+'-name').html(text+' <span class="caret"></span>');
        $('#'+input+'-name').parent().removeClass("open");

    }

    function get_value_select_home(input){

        value = "";

        $('#'+input+' > li').each(function(){
            if($(this).children().hasClass("active")){
                value = $(this).children().attr("data-value");
            }
        });

        return value;

    }

    $('#search-home-op > li > a').click(function(e){
        select_home_change("search-home-op",$(this).text(),$(this).attr("data-value"));
        return false;
    });

    $('#search-home-tipo > li > a').click(function(e){
        select_home_change("search-home-tipo",$(this).text(),$(this).attr("data-value"));
        return false;
    });


    var loc_gen = "";
    $("#search-home").click(function(e){

        loc = $("#location-home").attr("data-value");
        loc_name = $("#location-home").val();
        tipo_prop = get_value_select_home("search-home-tipo");
        tipo_op = get_value_select_home("search-home-op");


        if(loc_name != loc_gen){
            loc = "-1";
        }

        if($("#mapa-search-home").is(':checked') || $("#mapa-search-home2").is(':checked')){
            //url = '/map/?locale='+loc+'&operation='+tipo_op+'&types='+tipo_prop
            url = '/map-vista/?locale='+loc+'&operation='+tipo_op+'&types='+tipo_prop
        }else{
            url = '/search/?locale='+loc+'&operation='+tipo_op+'&types='+tipo_prop
        }

        self.location.href=url;

        return false;
    });

    $("#search-home-m").click(function(e){

        loc = $("#location-home-m").attr("data-value");
        loc_name = $("#location-home-m").val();
        tipo_prop = $("#tipo-prop-m").val();
        tipo_op = $("#tipo-op-m").val();


        if(loc_name != loc_gen){
            loc = "-1";
        }

        if($("#mapa-search-home-m").is(':checked')){
            url = '/map/?locale='+loc+'&operation='+tipo_op+'&types='+tipo_prop
        }else{
            url = '/search/?locale='+loc+'&operation='+tipo_op+'&types='+tipo_prop
        }

        self.location.href=url;

        return false;
    });


    $("#location-home").autocomplete({
        minLength: 3,
        source: __JSON+"?action=autocomplete_city",
        search  : function(){$("#loading_locale-m").css('display',"block"); $("#loading_locale").css('display',"block"); },
        open    : function(){$("#loading_locale-m").css('display',"none"); $("#loading_locale").css('display',"none"); },
        select: function(e,ui){
            $("#location-home").attr("data-value",ui["item"]["code"]);
            loc_gen = ui["item"]["label"];
        }

    });

    $("#location-home-m").autocomplete({
        minLength: 3,
        source: __JSON+"?action=autocomplete_city",
        search  : function(){$("#loading_locale-m").css('display',"block"); $("#loading_locale").css('display',"block"); },
        open    : function(){$("#loading_locale-m").css('display',"none"); $("#loading_locale").css('display',"none"); },
        select: function(e,ui){
            $("#location-home-m").attr("data-value",ui["item"]["code"]);
            loc_gen = ui["item"]["label"];
        }

    });



    if($("#filter-project").exists()){

        var page_project = 1;

        function submit_project(){

            self.location.href = location_path+"?locale="+$("#locale").attr("data-value")+"&show="+$("#show").val()+"&page="+page_project;

            return false;
        }


        $("#filter-project #locale").autocomplete({
            minLength: 3,
            source: __JSON+"?action=autocomplete_city",
            select: function(e,ui){
                $(this).attr("data-value",ui["item"]["code"]);
                loc_gen = ui["item"]["label"];

                submit_project();
            }

        });


        var loc_val = "";
        var loc_val2 = "-1";
        $("#filter-project #locale").on("focus",function(e){

            var $this = $(this);
            loc_val = $this.val();
            loc_val2 = $this.attr("data-value");

            $this.val("");
            $this.attr("data-value","-1");

        });

        $("#filter-project #locale").on("blur",function(e){

            var $this = $(this);
            if($this.attr("data-value") == -1){
                $this.val(loc_val);
                $this.attr("data-value",loc_val2);
            }

        });




        $("#show").change(function(e){
            submit_project();
        });

        $(".pagination li a").click(function(e){
            page_project = $(this).attr("data-value");
            submit_project();
        });


    }

    //Search page hidden content
    $('#toggle-link').on('click',function(e) {
        var $message = $('#hidden_content');
        if ($message.css('display') != 'block') {
            $message.show();
            var firstClick = true;
            $(document).bind('click.myEvent', function(e) {
                if (!firstClick && $(e.target).closest('#hidden_content').length == 0) {
                    $message.hide();
                    $(document).unbind('click.myEvent');
                }
                firstClick = false;
            });
        }
        e.preventDefault();
    });



        
    // Property page tabs
    $('.tabs .tab-links a').on('click', function(e)  {
        var currentAttrValue = $(this).attr('href');
        var priceSlider = $('.jslider').detach();
        $('.tabs ' + currentAttrValue).slideDown(400).siblings().slideUp(400);
        $(this).parent('li').addClass('active').siblings().removeClass('active');
        
        priceSlider.appendTo($('.tabs ' + currentAttrValue).find('.price-range-wrapper'));
        priceSlider = null;

		ga('send', 'pageview', location.pathname+currentAttrValue);

        e.preventDefault();
    });

    $('#tabs-signup li a').on('click', function(e)  {

		ga('send', 'pageview', location.pathname+$(this).attr('href'));

    });

    $("#modalcontacto").on('click', function(e){

        $this = $(this);
        modal = $this.attr("data-target");

		ga('send', 'pageview', location.pathname+$this.attr('href'));

        $("#"+modal).modal('show');

        return false;

    });
    
    
    // ############# CALL NOW FORM STARTS
    $(document).ready(function () {
        if(window.location.href.indexOf('operation=callnow') != -1){
            $( "#modalcontacto_call" ).trigger( "click" );
        }
    });
    
    $("#modalcontacto_call").on('click', function(e){
        var property_id = $(this).next().val();
        var ptype = $(this).next().next().val();
        // GET OWNER INFO
        $.getJSON(__JSON+"?action=get_awner_info&"+"pid="+property_id+"&ptype="+ptype, function(response) {
          //console.log(response);
            if(response.correo != ''){
                $('#callNowForm [name=oemail], #loginformCallF2 [name=oemail]').val(response.correo);
                $('#callNowForm [name=oname], #loginformCallF2 [name=oname]').val(response.nombre_contacto);
                $('#callNowForm [name=ocontact], #loginformCallF2 [name=ocontact]').val(response.telefono_contacto);
                $('.callNowNumber').html('<i class="fa fa-phone" aria-hidden="true"></i> '+response.telefono_contacto);
                    $('.callNowNumber').attr('href','tel:'+response.telefono_contacto);
                    
                    // hide - shows
        $('#continueButtonF1-call').hide();
        
        
        
                    if(typeof $('#callNowForm [name=uemail]').val() != 'undefined' && $('#callNowForm [name=uemail]').val() != ''){ // LOGGED IN
                        $('#confirmLlamar').modal('show');
                        $('#YconfirmLlamar').click(function(){
                            $('#confirmLlamar').modal('hide');
                            if($("#callNowForm").exists())
                                {
                                    $("#callNowForm").submit();
                                }
                            
                            $this = $('#modalcontacto_call');
                            modal = $this.attr("data-target");

                                    ga('send', 'pageview', location.pathname+$this.attr('href'));

                            $("#"+modal).modal('show');
                            return false;
                        });
                        return false;
                    }else{ // NOT LOGGED IN

                        if($("#callNowForm").exists())
                        {
                            $("#callNowForm").submit();
                        }

                        $this = $('#modalcontacto_call');
                        modal = $this.attr("data-target");

                                ga('send', 'pageview', location.pathname+$this.attr('href'));

                        $("#"+modal).modal('show');
                        return false;
                    }
            }
        });
         return false;
        
    });
    
    if($("#callNowForm").exists())
        {
            $("#callNowForm").submit(function(e){
                
            var uname = $('#callNowForm [name=uname]').val(); 
            var uemail = $('#callNowForm [name=uemail]').val(); 
            var ucontact_no = $('#callNowForm [name=ucontact_no]').val(); 
            var purl = $('#callNowForm [name=purl]').val(); 
            var pname = $('#callNowForm [name=pname]').val(); 
            var oemail = $('#callNowForm [name=oemail]').val(); 
            var oname = $('#callNowForm [name=oname]').val(); 
            var ocontact = $('#callNowForm [name=ocontact]').val(); 
            var formParams = "uname="+uname+"&uemail="+uemail+"&ucontact_no="+ucontact_no+"&purl="+purl+"&oemail="+oemail+"&pname="+pname+"&oname="+oname+"&ocontact="+ocontact;
                $.getJSON(__JSON+"?action=submit_callnow&"+formParams, function(response) {
                        });
            return false;            
            });
        }    
        if($("#loginformCallF").exists()){
            $("#loginformCallF").submit(function(e){
            
            $("#loginformCallF #button-sign-call").css("display", "none");
            $("#loginformCallF #loading-call").css("display", "block");
            $("#loginformCallF #login-alert-fail").css("display", "none");
            $("#loginformCallF #login-alert-success-call").css("display", "none");
//alert(__JSON+"?action=user-login-check&"+$(this).serialize().split("#").join("%23"));

               $.getJSON(__JSON+"?action=user-email-check&"+$(this).serialize().split("#").join("%23"), function(response) { 
                if(response == 'no'){
                   /* POPUP LOGIN/REGISTER */
                   $.getJSON(__JSON+"?action=registro_particular_popup&"+$("#loginformCallF").serialize(), function(response) {
                       $('#needActivationS-call').show();
                       $('#displayCallNow').show();
                       $('#formCallInstruction').hide();
                       $('#loading-call').hide();
                   });
                   /* POPUP LOGIN/REGISTER */
               }
               else{
                   $('#loginformCallF').hide();
                   $('#loginformCallF2').show();
                   $('#loginformCallF2 #userId2-call').val(response);
                   $('#loginformCallF2 #usernameF2-call').val($('#usernameF-call').val());
                   
               }  
            });
     
            return false;
        });
        }
        if($("#loginformCallF2").exists()){
            $("#loginformCallF2").submit(function(e){
                $("#loginformCallF2 #button-sign-call").css("display", "none");
                $("#loginformCallF2 #loading-call").css("display", "block");
                $("#loginformCallF2 #login-alert-fail-call").css("display", "none");
                $("#loginformCallF2 #login-alert-success-call").css("display", "none");

                $.getJSON(__JSON+"?action=user-login&"+$(this).serialize().split("#").join("%23"), function(response) { 

                    if(response["status"] == 200){
                        $("#loginformCallF,#loginformCallF2").hide();
                        $('#displayCallNow').show();
                        $('#formCallInstruction').hide();
                        var userArray = $('#loginformCallF2').serializeArray();
                        var userData = {};
                        $("#loginformCallF2 #loading-call").css("display", "none");
                        var uname = $('#loginformCallF2 [name=username]').val().split("@")[0]; 
                        var uemail = $('#loginformCallF2 [name=username]').val(); 
                        var ucontact_no = '123456789'; 
                        var purl = $('#loginformCallF2 [name=purl]').val(); 
                        var pname = $('#loginformCallF2 [name=pname]').val(); 
                        var oemail = $('#loginformCallF2 [name=oemail]').val(); 
                        var oname = $('#loginformCallF2 [name=oname]').val(); 
                        var ocontact = $('#loginformCallF2 [name=ocontact]').val(); 
                        var formParams = "uname="+uname+"&uemail="+uemail+"&ucontact_no="+ucontact_no+"&purl="+purl+"&oemail="+oemail+"&pname="+pname+"&oname="+oname+"&ocontact="+ocontact;
                        $.getJSON(__JSON+"?action=submit_callnow&"+formParams, function(response) {
                                        
                                        
                                    });
                    }else{
                        $("#loginformCallF2 #loading-call").css("display", "none");
                        $("#loginformCallF2 #login-alert-fail-call").css("display", "block");
                        $("#loginformCallF2 #button-sign-call").css("display", "block");
                    }
                });

                return false;
            });
        }
    
    // ############# CALL NOW FORM STARTS
     var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};
    // ############# CALL NOW FORM LIST STARTS
    $(document).ready(function () {
        if(window.location.href.indexOf('&id=') != -1){
            var propid = getUrlParameter('id');
            $( "#"+propid+" > div.col-lg-2.col-md-3.col-sm-3.col-xs-12 > div:nth-child(2) > div:nth-child(3) > a.modalcontacto_call_list" ).trigger( "click" );
        }
    });
    
    $(".modalcontacto_call_list").on('click', function(e){
        var property_id = $(this).next().next().next().val();
        var purl = $(this).next().val();
        var pname = $(this).next().next().val();
        var ptype = '';
        if (~purl.indexOf("/de/")){
            ptype = 'property';
            var property_id = $(this).next().next().next().val();
        }else{
            ptype = 'project';
            var property_id = $(this).next().next().next().next().val();
        }
        
        // GET OWNER INFO
        $.getJSON(__JSON+"?action=get_awner_info&"+"pid="+property_id+"&ptype="+ptype, function(response) {
            if(response.correo != ''){
                    $('#fb-button_call').attr('data-value', $('#fb-button_call').attr('data-value')+'&id='+property_id)
                    $('#callNowForm_list [name=oemail], #loginformCallF2_list [name=oemail]').val(response.correo);
                    $('#callNowForm_list [name=oname], #loginformCallF2_list [name=oname]').val(response.nombre_contacto);
                    $('#callNowForm_list [name=ocontact], #loginformCallF2_list [name=ocontact]').val(response.telefono_contacto);
                    $('#callNowForm_list [name=purl], #loginformCallF2_list [name=purl]').val(purl);
                    $('#callNowForm_list [name=pname], #loginformCallF2_list [name=pname]').val(pname);
                    $('.callNowNumber_list, .displayCallNow_list').html('<i class="fa fa-phone" aria-hidden="true"></i> '+response.telefono_contacto);
                    $('.callNowNumber_list, .displayCallNow_list').attr('href','tel:'+response.telefono_contacto);
                    // hide - shows
                    $('#continueButtonF1-call_list').hide();
                    
                    if(typeof $('#callNowForm_list [name=uemail]').val() != 'undefined' && $('#callNowForm_list [name=uemail]').val() != ''){ // LOGGED IN
                        $('#confirmLlamar').modal('show');
                        $('#YconfirmLlamar').click(function(){
                            $('#confirmLlamar').modal('hide');
                            if($("#callNowForm_list").exists())
                            {
                                $("#callNowForm_list").submit();
                            }
                            $this = $('.modalcontacto_call_list');
                            modal = $this.attr("data-target");

                            ga('send', 'pageview', location.pathname+$this.attr('href'));

                            $("#"+modal).modal('show');
                            return false;
                        });
                        return false;
                    }else{ // NOT LOGGED IN
                        if($("#callNowForm_list").exists())
                        {
                            $("#callNowForm_list").submit();
                        }
                        $this = $('.modalcontacto_call_list');
                        modal = $this.attr("data-target");

                        ga('send', 'pageview', location.pathname+$this.attr('href'));

                        $("#"+modal).modal('show');
                        return false;
                    }
                    

                    
            }    
        });
        return false;
        // GET OWNER INFO                
       
    });
    if($("#callNowForm_list").exists())
        {
            $("#callNowForm_list").submit(function(e){
            var uname = $('#callNowForm_list [name=uname]').val(); 
            var uemail = $('#callNowForm_list [name=uemail]').val(); 
            var ucontact_no = $('#callNowForm_list [name=ucontact_no]').val(); 
            var purl = $('#callNowForm_list [name=purl]').val(); 
            var pname = $('#callNowForm_list [name=pname]').val(); 
            var oemail = $('#callNowForm_list [name=oemail]').val(); 
            var oname = $('#callNowForm_list [name=oname]').val(); 
            var ocontact = $('#callNowForm_list [name=ocontact]').val(); 
            var formParams = "uname="+uname+"&uemail="+uemail+"&ucontact_no="+ucontact_no+"&purl="+purl+"&oemail="+oemail+"&pname="+pname+"&oname="+oname+"&ocontact="+ocontact;
            $.getJSON(__JSON+"?action=submit_callnow&"+formParams, function(response) {
                        });
            return false;            
            });
        }    
        if($("#loginformCallF_list").exists()){
            $("#loginformCallF_list").submit(function(e){
            $("#loginformCallF_list #button-sign-call_list").css("display", "none");
            $("#loginformCallF_list #loading-call_list").css("display", "block");
            $("#loginformCallF_list #login-alert-fail_list").css("display", "none");
            $("#loginformCallF_list #login-alert-success-call_list").css("display", "none");
//alert(__JSON+"?action=user-login-check&"+$(this).serialize().split("#").join("%23"));

               $.getJSON(__JSON+"?action=user-email-check&"+$(this).serialize().split("#").join("%23"), function(response) { 
                if(response == 'no'){
                   /* POPUP LOGIN/REGISTER */
                   var pass = randomString(10);
                            var uname = 'doomos_user_'+randomStringSimple(5);
                    $.getJSON(__JSON+"?action=registro_particular_popup&"+"name="+uname+"&pass-1="+pass+"&pass-2="+pass+"&"+$("#loginformCallF_list").serialize(), function(response) {
                        if(response.confirm_user_id){
                       var userId = response.confirm_user_id;
                        }else{
                          var userId = '';  
                        }
                        var oemail = $('#loginformCallF2_list [name=oemail]').val(); 
                        var oname = $('#loginformCallF2_list [name=oname]').val(); 
                        var ocontact = $('#loginformCallF2_list [name=ocontact]').val(); 
                        var purl = $('#loginformCallF2_list [name=purl]').val();
                        var pname = $('#loginformCallF2_list [name=pname]').val(); 
                        var uemail = $('#loginformCallF_list #usernameF-call_list').val();
                        var ucontact_no = ''; 
                        var formParams = "uname="+uname+"&uemail="+uemail+"&ucontact_no="+ucontact_no+"&purl="+purl+"&oemail="+oemail+"&pname="+pname+"&oname="+oname+"&ocontact="+ocontact;
                        $.getJSON(__JSON+"?action=submit_callnow&"+formParams, function(response) {
         
                                    });
                        
                        
                       $('#needActivationS-call_list').show();
                       $('#displayCallNow_list').show();
                       $('#formCallInstruction_list').hide();
                       $('#loading-call_list').hide();
                   });
                   /* POPUP LOGIN/REGISTER */
               }
               else{
                   $('#loginformCallF_list').hide();
                   $('#loginformCallF2_list').show();
                   $('#loginformCallF2_list #userId2-call_list').val(response);
                   $('#loginformCallF2_list #usernameF2-call_list').val($('#usernameF-call_list').val());
                   
               }  
            });
     
            return false;
        });
        }
        if($("#loginformCallF2_list").exists()){
            $("#loginformCallF2_list").submit(function(e){
                $("#loginformCallF2_list #button-sign-call_list").css("display", "none");
                $("#loginformCallF2_list #loading-call_list").css("display", "block");
                $("#loginformCallF2_list #login-alert-fail-call_list").css("display", "none");
                $("#loginformCallF2_list #login-alert-success-call_list").css("display", "none");

                $.getJSON(__JSON+"?action=user-login&"+$(this).serialize().split("#").join("%23"), function(response) { 

                    if(response["status"] == 200){
                        $("#loginformCallF_list,#loginformCallF2_list").hide();
                        $('#displayCallNow_list').show();
                        $('#formCallInstruction_list').hide();
                        var userArray = $('#loginformCallF2_list').serializeArray();
                        var userData = {};
                        $("#loginformCallF2_list #loading-call_list").css("display", "none");
                        var uname = $('#loginformCallF2_list [name=username]').val().split("@")[0]; 
                        var uemail = $('#loginformCallF2_list [name=username]').val(); 
                        var ucontact_no = '123456789'; 
                        var purl = $('#loginformCallF2_list [name=purl]').val(); 
                        var pname = $('#loginformCallF2_list [name=pname]').val(); 
                        var oemail = $('#loginformCallF2_list [name=oemail]').val();
                        var oname = $('#loginformCallF2_list [name=oname]').val(); 
                        var ocontact = $('#loginformCallF2_list [name=ocontact]').val(); 
                        var formParams = "uname="+uname+"&uemail="+uemail+"&ucontact_no="+ucontact_no+"&purl="+purl+"&oemail="+oemail+"&pname="+pname+"&oname="+oname+"&ocontact="+ocontact;
                        $.getJSON(__JSON+"?action=submit_callnow&"+formParams, function(response) {
                                        
                                        
                                    });
                    }else{
                        $("#loginformCallF2_list #loading-call_list").css("display", "none");
                        $("#loginformCallF2_list #login-alert-fail-call_list").css("display", "block");
                        $("#loginformCallF2_list #button-sign-call_list").css("display", "block");
                    }
                });

                return false;
            });
        }
    
    // ############# CALL NOW FORM LIST STARTS
    

    $('#proy_rel_popup').on('shown.bs.modal', function (e) {
		ga('send', 'pageview', location.pathname+"#proy_rel_popup");
    });

    $('#emp_loc_popup').on('shown.bs.modal', function (e) {
		ga('send', 'pageview', location.pathname+"#emp_loc_popup");
    });

    $('#prop_rel_contact').on('shown.bs.modal', function (e) {
		ga('send', 'pageview', location.pathname+"#prop_rel_contact");
    });

    $('#modal_map_sv').on('shown.bs.modal', function (e) {
		ga('send', 'pageview', location.pathname+"#streetview360");
    });


    function submit_search_detail(form){

        ser = $("#"+form).serializeArray();

        data = [];
        for(i=0;i<ser.length;i++){

            if(ser[i]["name"] == "locale"){
                data_value = $("#"+form+" #"+ser[i]["name"]).attr("data-value");
                //console.log(data_value);
                if(data_value != "" && data_value != "-1"){
                    data.push(ser[i]["name"]+"="+data_value);
                }
            }else if(ser[i]["name"] == "tipo_prop"){
                if(ser[i]["value"] != ""){
                    data.push("types="+ser[i]["value"]);
                }
            }else{
                if(ser[i]["value"] != ""){
                    data.push(ser[i]["name"]+"="+ser[i]["value"]);
                }
            }

        }

        if(data.length > 0){
            self.location.href = "/search/?"+data.join("&");
        }else{
            alert("Debe seleccionar al menos un item del formulario.");
        }

    }

    $("#search-detail-xs").submit(function(e){
        submit_search_detail('search-detail-xs');
        return false;
    });

    $("#search-detail-lg").submit(function(e){
        submit_search_detail('search-detail-lg');
        return false;
    });

    $("#search-detail-lg #locale").autocomplete({
                        minLength: 3,
                        source: __JSON+"?action=autocomplete_city",
                        search  : function(){$("#search-detail-lg #loading_locale").css('display',"block"); },
                        open    : function(){$("#search-detail-lg #loading_locale").css('display',"none"); },
                        select: function(e,ui){
                            $(this).attr("data-value",ui["item"]["code"]);
                        }

        });

    $("#search-detail-xs #locale").autocomplete({
                        minLength: 3,
                        source: __JSON+"?action=autocomplete_city",
                        search  : function(){$("#search-detail-xs #loading_locale").css('display',"block"); },
                        open    : function(){$("#search-detail-xs #loading_locale").css('display',"none"); },
                        select: function(e,ui){
                            $(this).attr("data-value",ui["item"]["code"]);
                        }

        });


    //  Price slider search page 
    if( $(".price-input").length > 0) {
        $(".price-input").each(function() {
            var vSLider = $(this).slider({
                from: 0,
                to: 9000000,
                smooth: true, 
                round: 0,       
                dimension: ',00&nbsp;$',
            }); 
        });
    }

    //Magnific popup init
    if ($('.image-popup').length > 0 ) {
        $('.image-popup').magnificPopup({type:'image'});
    }
    
    //  Pricing Tables in Submit page
    if ($('.submit-pricing').length > 0){
        $('.but-sel').click(function() {
            $('.submit-pricing .buttons td').each(function () {
                $(this).removeClass('package-selected');
            });
            $(this).parent().css('opacity','1');
            $(this).parent().addClass('package-selected');
        }
        );
    }

    //  Payment in Submit page
    if($('.pay-now').length >0 ){
        $('.bank .bank-logo').click(function() {
            $('.bank').each(function () {
                $(this).removeClass('active');
            });
            $(this).parent().addClass('active');
        }
        );
    }


    $("#models-project").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            slideSpeed: 500,
            items : 3, //10 items above 1000px browser width
                        responsive:{
                            0:{
                                items:1
                            },
                            600:{
                                items:2
                            },
                            1024:{
                                items:3
                            }
                        },
           loop:true,
           stopOnHover: true,
           navigationText: false,
           rewindNav: true,
           nav: false

      });
 

    $("#serv-in").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            slideSpeed: 500,
            items : 1, //10 items above 1000px browser width
           loop:true,
           stopOnHover: true,
           navigationText: false,
           rewindNav: true,
           nav: false

      });

 
    $("#emp-dest").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            slideSpeed: 500,
            items : 5, //10 items above 1000px browser width
            responsive:{
                            0:{
                                items:1
                            },
                            600:{
                                items:2
                            },
                            1024:{
                                items:5
                            }
                        },
           loop:true,
           stopOnHover: true,
           navigationText: false,
           rewindNav: true,
           nav: false,
           navText: [
                    "<i class='fa fa-chevron-left img-circle arr-dest-left'></i>",
                    "<i class='fa fa-chevron-right img-circle arr-dest-right'></i>"
                    ]

      });

    $("#project-dest").owlCarousel({
            autoplay: 3000,
            stopOnHover: true,
            autoplayHoverPause: true,
            slideSpeed: 500,
            items : 3, //10 items above 1000px browser width
            responsive:{
                             0:{
                                items:1,
                                nav:false
                            },
                            600:{
                                items:2,
                                nav:false
                            },
                            1024:{
                                items:3,
                                nav:true
                            }
                        },
           loop:true,
           stopOnHover: true,
           navigationText: false,
           rewindNav: true,
           nav: true,
           navText: [
                    "<i class='fa fa-chevron-left img-circle arr-dest-left'></i>",
                    "<i class='fa fa-chevron-right img-circle arr-dest-right'></i>"
                    ]

      });

    $(".oferta-act").owlCarousel({
            //autoplay: 500,
            stopOnHover: true,
            autoplayHoverPause: true,
            slideSpeed: 500,
            items : 3, //10 items above 1000px browser width
            responsive:{
                             0:{
                                items:1,
                                nav:false
                            },
                            600:{
                                items:2,
                                nav:false
                            },
                            1024:{
                                items:3,
                                nav:true
                            }
                        },
           loop:true,
           navigationText: false,
           rewindNav: true,
           nav: true,
           navText: [
                    "<i class='fa fa-chevron-left img-circle arr-dest-left'></i>",
                    "<i class='fa fa-chevron-right img-circle arr-dest-right'></i>"
                    ]

      });

     $("#arr-dest").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            autoplayHoverPause: true,
            slideSpeed: 500,
            items : 3, //10 items above 1000px browser width
            responsive:{
                             0:{
                                items:1,
                                nav:false
                            },
                            600:{
                                items:2,
                                nav:false
                            },
                            1024:{
                                items:3,
                                nav:true
                            }
                        },
           loop:true,
           stopOnHover: true,
           navigationText: false,
           rewindNav: true,
           nav: true,
           navText: [
                    "<i class='fa fa-chevron-left img-circle arr-dest-left'></i>",
                    "<i class='fa fa-chevron-right img-circle arr-dest-right'></i>"
                    ]

      });

      $("#mas-buscado").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            slideSpeed: 500,
            items : 3, //10 items above 1000px browser width
            responsive:{
                             0:{
                                items:1,
                                nav:true
                            },
                            600:{
                                items:2,
                                nav:true
                            },
                            1024:{
                                items:3,
                                nav:true
                            }
                        },
           loop:true,
           navigationText: true,
           rewindNav: true,
           nav: true,
           navText: [
                    "<i class='fa fa-chevron-left'></i>",
                    "<i class='fa fa-chevron-right'></i>"
                    ]
      });

      $("#carousel-example-generic").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            slideSpeed: 500,
            items : 3, //10 items above 1000px browser width
            responsive:{
                             0:{
                                items:1,
                                nav:false
                            },
                            600:{
                                items:2,
                                nav:false
                            },
                            1024:{
                                items:3,
                                nav:true
                            }
                        },
           loop:true,
           navigationText: false,
           rewindNav: true,
           nav: true,
      });
      $("#carousel-example-generic3").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            slideSpeed: 500,
            items : 3, //10 items above 1000px browser width
            responsive:{
                             0:{
                                items:1,
                                nav:false
                            },
                            600:{
                                items:2,
                                nav:false
                            },
                            1024:{
                                items:3,
                                nav:true
                            }
                        },
           loop:true,
           navigationText: false,
           rewindNav: true,
           nav: true,
      });
     
$("#vent-dest").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            autoplayHoverPause: true,
            slideSpeed: 500,
            items : 3, //10 items above 1000px browser width
            responsive:{
                            0:{
                                items:1,
                                nav:false
                            },
                            600:{
                                items:2,
                                nav:false
                            },
                            1024:{
                                items:3,
                                nav:true
                            }
                        },
           loop:true,
           stopOnHover: true,
           navigationText: false,
           rewindNav: true,
           nav: false,
           navText: [
                    "<i class='fa fa-chevron-left img-circle arr-dest-left'></i>",
                    "<i class='fa fa-chevron-right img-circle arr-dest-right'></i>"
                    ]

      });

      $("#regiones-list").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            autoplayHoverPause: true,
            slideSpeed: 500,
            items : 3, //10 items above 1000px browser width
            responsive:{
                            0:{
                                items:1,
                                nav:false
                            },
                            600:{
                                items:2,
                                nav:false
                            },
                            1024:{
                                items:3,
                                nav:true
                            }
                        },
           loop:true,
           stopOnHover: true,
           navigationText: false,
           rewindNav: true,
           nav: false,
           navText: [
                    "<i class='fa fa-chevron-left img-circle arr-dest-left'></i>",
                    "<i class='fa fa-chevron-right img-circle arr-dest-right'></i>"
                    ]

      });

      $("#buscado-dest").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            slideSpeed: 500,
            items : 1, //10 items above 1000px browser width
           loop:true,
           stopOnHover: true,
           navigationText: false,
           rewindNav: true,
           nav: false,
           navText: [
                    "<i class='fa fa-chevron-left img-circle arr-dest-left'></i>",
                    "<i class='fa fa-chevron-right img-circle arr-dest-right'></i>"
                    ]

      });

      $("#propcl-dest").owlCarousel({
            autoplay: 500,
            stopOnHover: true,
            slideSpeed: 500,
            items : 1, //10 items above 1000px browser width
           loop:true,
           stopOnHover: true,
           navigationText: false,
           rewindNav: true,
           nav: false,
           navText: [
                    "<i class='fa fa-chevron-left img-circle arr-dest-left'></i>",
                    "<i class='fa fa-chevron-right img-circle arr-dest-right'></i>"
                    ]

      });

    // Initialize  Owl Carousel block
    $("#owl-demo").owlCarousel({
        items : 4,
        responsive:{
            0:{
                items:1
            },
            600:{
                items:2
            },
            1024:{
                items:3
            }
        }
    });
    
    $("#owl-demo-3").owlCarousel({
        items : 1,
        pagination:true,
        nav:true,
        autoHeight:true,
        itemsCustom: [1600, 1],
        slideSpeed:700,
        loop:true,
        navText: [
        "<i class='fa fa-chevron-left'></i>",
        "<i class='fa fa-chevron-right'></i>"
        ]
    });

	
    if($(".scrolling").exists()){

        var car = [];
        $("div[class='scrolling']").each(function(ee){

            $this = $(this);

            id = $this.attr("id");

            car[id] = $("#"+id+" > ul");

            car[id].itemslide({
                parent_width: true,
                left_sided: true,
                disable_scroll: true

            }); //initialize itemslide

            $("#"+id+" > ul > li").css("width",$("#"+id).parent().width()+"px");

            car[id].reload();

                car[id].on('changeActiveIndex', function(e) {

                    $(this).children().each(function(ee){
                        $this = $(this);
                        

                        if($this.hasClass("itemslide-active")){

                            code = $this.parent().parent().attr("id");
                            number = $this.attr("data-n");

                            if(number == "end"){
                                $(".overlay-"+code).css("display","none");
                                $(".detail-"+code).css("display","block");
                            }else{
                                $(".overlay-"+code).css("display","block");
                                $(".detail-"+code).css("display","none");
                                $(".countimg-"+code).text(number);
                            }

                        }

                    });

                });


        });


        $(".fa-chevron-left").click(function(e){
            car[$(this).attr("id")].previous();
        });

        $(".fa-chevron-right").click(function(e){
            car[$(this).attr("id")].next();
        });
        

        $(window).resize(function () {

            $("div[class='scrolling']").each(function(ee){
                car[$(this).attr("id")].reload();
            });

           
        }); 


    }
    // Initialize  Owl Carousel block Home page v_2
    $("#owl-demo-header").owlCarousel({
        items : 1,
        pagination: true,
        responsiveBaseWidth: ".owl-demo-header",
        nav: true,
        slideSpeed: 700,
        loop:true,
        navText: [
        "<i class='fa fa-chevron-left'></i>",
        "<i class='fa fa-chevron-right'></i>"
        ]
    });

    //  iCheck
    if ($('.switch').length > 0) {
        $('.switch input').iCheck();
    }
    if ($('.radio').length > 0) {
        $('input').iCheck();
    }
    if ($('.checkbox').length > 0) {
        $('input:not(.no-icheck)').iCheck();
    }

    //  Smooth Navigation Scrolling
    $('a[href^="#"].roll').live('click',function (e) {
        e.preventDefault();
        var target = this.hash,
        $target = $(target);
        if ($(window).width() > 768) {
            $('html, body').stop().animate({
                'scrollTop': $target.offset().top - $('.navigation').height()
            }, 2000)
        } else {
            $('html, body').stop().animate({
                'scrollTop': $target.offset().top
            }, 2000)
        }
    }); 
    
    // Menu Button
    $('.navbar a.drop-left, .navbar a.drop-close').live('click', function (e) {
        if ($('.drop-left').hasClass("hidden")) {
            $('.drop-left, .primary>ul').removeClass("hidden");
            $('.drop-close, .secondary>ul').addClass("hidden");
            $('.blog-nv .secondary>ul, .blog-mn .secondary>ul').removeClass("hidden");
        }
        else {
            $('.drop-close, .secondary>ul').removeClass("hidden");
            $('.drop-left, .primary>ul').addClass("hidden");
        }
    });

    $('.wrapper').live('click', function (e) {
        if ($('.secondary').hasClass("open")) { 
            $('.drop-left, .primary>ul').removeClass("hidden");
        }
    });
    
    // Sliding submenu in mobile menu
    $( '.navigation .site-header .mob-menu li.has-child>a' ).live('click', function (e) {
      e.preventDefault();
      var $t=$(this).parent();
      if(!($t).hasClass("opened")) {
            $('.mob-menu .child-navigation').slideUp( "fast" );
            $('.mob-menu .child-navigation').parent().removeClass("opened");
            $($t).addClass("opened");
            $($t).children('.mob-menu .child-navigation').slideToggle( "fast" );
        } else {
            $('.mob-menu .child-navigation').slideUp( "fast" );
            $('.mob-menu .child-navigation').parent().removeClass("opened");
        }
    });
    
    $( '.navigation .container li.has-child>a' ).live('touchstart click', function (e) {
        e.preventDefault();
        var $t=$(this).parent();
        $($t).children('.child-navigation').slideDown( "fast" );
    });
 

    
    // Set Bookmark button attribute
    $( ".bookmark" ).each(function(index) {
        $(this).on("click", function() {
            if ($(this).data('bookmark-state') == 'empty') {
                $(this).removeClass('bookmark-added');
            } else if ($(this).data('bookmark-state') == 'added') {
                $(this).addClass('bookmark-added');
            }
            var is_choose = 0;
            var property_id = $(this).data('propertyid');
            if ($(this).data('bookmark-state') == 'empty') {
                $(this).data('bookmark-state', 'added');
                $(this).addClass('bookmark-added');
                is_choose = 1;
            } else if ($(this).data('bookmark-state') == 'added') {
                $(this).data('bookmark-state', 'empty');
                $(this).removeClass('bookmark-added');
                is_choose = 0;
            }
            var data = { action: 'add_user_bookmark', property_id : property_id, is_choose : is_choose };
            return false;
        });
    });
    
    // Set Compare button attribute
    $( ".compare" ).each(function(index) {
        $(this).on("click", function(){
            if ($(this).data('compare-state') == 'empty') {
                $(this).removeClass('compare-added');
            } else if ($(this).data('compare-state') == 'added') {
                $(this).addClass('compare-added');
            }
            var is_choose = 0;
            var property_id = $(this).data('propertyid');
            if ($(this).data('compare-state') == 'empty') {
                $(this).data('compare-state', 'added');
                $(this).addClass('compare-added');
                is_choose = 1;
            } else if ($(this).data('compare-state') == 'added') {
                $(this).data('compare-state', 'empty');
                $(this).removeClass('compare-added');
                is_choose = 0;
            }
            var data = { action: 'add_user_bookmark', property_id : property_id, is_choose : is_choose };
            return false;
        });
    });
 
});

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// On RESIZE
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

$(window).on('resize', function(){
    equalHeight('.equal-height');
    // Set Owl Carousel width on resize window
    $('.carousel-full-width').css('width', $(window).width());  
});

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// On LOAD
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

$(window).load(function(){
    //  Show counter after appear
    var $number = $('.number');
    var $grid;
    
    if ($number.length > 0 ) {
        $number.waypoint(function() {
            initCounter();
        }, { offset: '100%' });
    }

    //Masonry grid init
    function triggerMasonry() {
        if ( !$grid ) { return; }
        $grid.masonry({
            itemSelector: '.grid-item'
        });
    }

    $grid = $('.grid');
    triggerMasonry();
    
    // Owl Carousel
    // Disable click when dragging
    function disableClick(){
        $('.owl-carousel .property').css('pointer-events', 'none');
    }
    // Enable click after dragging
    function enableClick(){
        $('.owl-carousel .property').css('pointer-events', 'auto');
    }

    if ($('.owl-carousel').length > 0) {
        if ($('.carousel-full-width').length > 0) {
            setCarouselWidth();
        }

        $(".exp-carousel").owlCarousel({
            items: 1,
            singleItem: true,
            itemsScaleUp: true,
            nav:true,
            loop:true,
            navText: [
            "<i class='fa fa-chevron-left' style='color: #f7941e;'></i>",
            "<i class='fa fa-chevron-right' style='color: #f7941e;'></i>"
            ],
        });

        $(".testimonials-carousel").owlCarousel({
            items: 1,
            responsiveBaseWidth: ".testimonial",
            pagination: true,
            nav:true,
            slideSpeed : 10000,
            loop:true,
            //autoplay:true,
            //autoplayTimeout:5000,
            //autoplayHoverPause:true,
            navText: [
            "<i class='fa fa-chevron-left'></i>",
            "<i class='fa fa-chevron-right'></i>"
            ],
        });
    }
    function sliderLoaded(){
        $('#slider').removeClass('loading');
        document.getElementById("loading-icon").remove();
        centerSlider();
    }
    function animateDescription(){
        var $description = $(".slide .overlay .info");
        $description.addClass('animate-description-out');
        $description.removeClass('animate-description-in');
        setTimeout(function() {
            $description.addClass('animate-description-in');
        }, 400);
    }
});

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Functions
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//  Equal heights
function equalHeight(container) {
    var currentTallest = 0,
    currentRowStart = 0,
    rowDivs = new Array(),
    $el,
    topPosition = 0;
    $(container).each(function() {

        $el = $(this);
        $($el).height('auto');
        topPostion = $el.position().top;

        if (currentRowStart != topPostion) {
            for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
                rowDivs[currentDiv].height(currentTallest);
            }
            rowDivs.length = 0; // empty the array
            currentRowStart = topPostion;
            currentTallest = $el.height();
            rowDivs.push($el);
        } else {
            rowDivs.push($el);
            currentTallest = (currentTallest < $el.height()) ? ($el.height()) : (currentTallest);
        }
        for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
            rowDivs[currentDiv].height(currentTallest);
        }
    });
}

//funny numbers counter
function initCounter(){
    $('.number').countTo({
        speed: 3000,
        refreshInterval: 50,
        onComplete: function (value) {
            window.initCounter=function(){return false;};
        }
    });
}

// Set Owl Carousel width
function setCarouselWidth(){
    $('.carousel-full-width').css('width', $(window).width());
}


jQuery.fn.exists = function(){return jQuery(this).length>0;}
$.fn.getType = function(){ return this[0].tagName == "INPUT" ? this[0].type.toLowerCase() : this[0].tagName.toLowerCase(); }

// ATPL 2017
var __JSON = "/json/";
        function setFavoritos(userId,propertyId){
            $('#loading_locale-m').show();
            $('#loading_locale-m'+propertyId).show();
            $('#loading_fav_success').hide();
            
            $.getJSON(__JSON+"?action=set_fav&user_id="+userId+"&property_id="+propertyId, function(response) { 
                $('#loading_locale-m').hide();
                $('#loading_locale-m'+propertyId).hide();
                $('#loading_fav_success').show();
                if(response == 'fav_removed'){
                    $('#loading_fav_success').text('Removed!');
                    $('#addToFavourite').removeClass('bookmark-added');
                    $('#addToFavourite'+propertyId).removeClass('bookmark-added');
                }
                if(response == 'fav_added'){
                    if(window.location.href.indexOf('/search/') == -1){
                         //SAVE SEARCH AFTER FAV
                         if(window.location.href.indexOf('/map-vista/' != -1)){
                            var ssaf_slink = window.location.origin+'/search/?locale='+$('#locale').attr('data-value')+'@@operation='+$('#operation option:selected').val()+'@@types='+$('#tipo_prop option:selected').val();
                            var ssaf_slink_form = window.location.origin+'/search/?locale='+$('#locale').attr('data-value')+'&operation='+$('#operation option:selected').val()+'&types='+$('#tipo_prop option:selected').val();
                            $('#askforsavesearch, #saveSearchForm #button-sign-save').show();
                            $('#searchSaved, saveSearchForm #continueButtonSv').hide();
                            $('#saveSearchForm [name=sarea]').val($('#locale').val());   
                            $('#saveSearchForm [name=slink]').val(ssaf_slink_form);   
                            var ssaf_operation = 'Operación - '+$('#operation option:selected').html()+'; Tipo de propiedad - '+$('#tipo_prop option:selected').html()+''; 
                            $('#saveSearchForm [name=sdata]').val(ssaf_operation);  
                            $('#saveSearchForm [name=id_localidad]').val($('#locale').attr('data-value'));  
                            $('#saveSearchForm [name=id_tipo_operacion]').val($('#operation option:selected').val());  
                            $('#saveSearchForm [name=id_tipo_propiedad]').val($('#tipo_prop option:selected').val());  
                            $.getJSON(__JSON+"?action=check_save_search_exist&user_id="+userId+"&slink="+ssaf_slink, function(response) {
                                //console.log(response);
                                if(response == 'no'){
                                    openPopUpSaveSearch(''+$('#locale').val()+'', 'Operación - '+$('#operation option:selected').html()+'; Tipo de propiedad - '+$('#tipo_prop option:selected').html()+'', ''+window.location.origin+'/search/?locale='+$('#locale').attr('data-value')+'&operation='+$('#operation option:selected').val()+'&types='+$('#tipo_prop option:selected').html()+'', '1', '1');
                                }
                            });
                        }
                         //SAVE SEARCH AFTER FAV
                    }else{
                        if($('#opensavesearch').exists() && $('#showifSaved').css('display') == 'none'){
                            $('#askforsavesearch').show();
                            $( "#opensavesearch" ).trigger( "click" );
                        }else{
                            $('#askforsavesearch').hide();
                        }
                }
                // ask user to save search
                
                    $('#loading_fav_success').text('Success!');
                    $('#addToFavourite').addClass('bookmark-added');
                    $('#addToFavourite'+propertyId).addClass('bookmark-added');
                }
                
                //console.log(response);
            });            
        }
        
        function setFavoritosProjects(userId,projectId){
            $('#loading_locale-m').show();
            $('#loading_locale-m'+projectId).show();
            $('.loading_locale-m'+projectId).show();
            $('#loading_fav_success').hide();
            
            $.getJSON(__JSON+"?action=set_fav_property&user_id="+userId+"&project_id="+projectId, function(response) { 
                $('#loading_locale-m').hide();
                $('#loading_locale-m'+projectId).hide();
                $('.loading_locale-m'+projectId).hide();
                $('#loading_fav_success').show();
                if(response == 'fav_removed'){
                    $('#loading_fav_success').text('Removed!');
                    $('#addToFavourite').removeClass('bookmark-added');
                    $('#addToFavourite'+projectId).removeClass('bookmark-added');
                }
                if(response == 'fav_added'){
                    if(window.location.href.indexOf('/search/') == -1){
                        // SAVE SEARCH AFTER FAV
                        if(window.location.href.indexOf('/map-vista/' != -1)){
                            var ssaf_slink = window.location.origin+'/search/?locale='+$('#locale').attr('data-value')+'@@operation='+$('#operation option:selected').val()+'@@types='+$('#tipo_prop option:selected').val();
                            var ssaf_slink_form = window.location.origin+'/search/?locale='+$('#locale').attr('data-value')+'&operation='+$('#operation option:selected').val()+'&types='+$('#tipo_prop option:selected').val();
                            $('#askforsavesearch, saveSearchForm #button-sign-save').show();
                            $('#searchSaved, saveSearchForm #continueButtonSv').hide();
                            $('#saveSearchForm [name=sarea]').val($('#locale').val());   
                            $('#saveSearchForm [name=slink]').val(ssaf_slink_form);   
                            var ssaf_operation = 'Operación - '+$('#operation option:selected').html()+'; Tipo de propiedad - '+$('#tipo_prop option:selected').html()+''; 
                            $('#saveSearchForm [name=sdata]').val(ssaf_operation);  
                            $('#saveSearchForm [name=id_localidad]').val($('#locale').attr('data-value'));  
                            $('#saveSearchForm [name=id_tipo_operacion]').val($('#operation option:selected').val());  
                            $('#saveSearchForm [name=id_tipo_propiedad]').val($('#tipo_prop option:selected').val()); 
                            $.getJSON(__JSON+"?action=check_save_search_exist&user_id="+userId+"&slink="+ssaf_slink, function(response) {
                                //console.log(response);
                                if(response == 'no'){
                                    openPopUpSaveSearch(''+$('#locale').val()+'', 'Operación - '+$('#operation option:selected').html()+'; Tipo de propiedad - '+$('#tipo_prop option:selected').html()+'', ''+window.location.origin+'/search/?locale='+$('#locale').attr('data-value')+'&operation='+$('#operation option:selected').val()+'&types='+$('#tipo_prop option:selected').html()+'', '1', '1');
                                }
                            });
                        }
                        // SAVE SEARCH AFTER FAV
                }else{
                        if($('#opensavesearch').exists() && $('#showifSaved').css('display') == 'none'){
                            $('#askforsavesearch').show();
                            $( "#opensavesearch" ).trigger( "click" );
                        }else{
                            $('#askforsavesearch').hide();
                        }
                }
                    $('#loading_fav_success').text('Success!');
                    $('#addToFavourite').addClass('bookmark-added');
                    $('#addToFavourite'+projectId).addClass('bookmark-added');
                }
                
                //console.log(response);
            });            
        }
        
        function setFavoritosList(userId,propertyId){
            $('#loading_locale-m'+propertyId).show();
           // $('#loading_fav_success'+propertyId).hide();  
            $.getJSON(__JSON+"?action=set_fav&user_id="+userId+"&property_id="+propertyId, function(response) { 
                $('.removeItem'+propertyId).hide();
                //location.reload();
                //console.log(response);
            });     
        }
        
        function setFavoritosListProjects(userId,projectId){
            $('#loading_locale-m'+projectId).show();
           // $('#loading_fav_success'+projectId).hide();  
            $.getJSON(__JSON+"?action=set_fav_property&user_id="+userId+"&project_id="+projectId, function(response) { 
                //location.reload();
                $('.removeItem'+projectId).hide();
                //console.log(response);
            });     
        }
        
        function cantDescard(destacado){
            if(destacado == 'si'){
                alert('No puedes descartar / ocultar una propiedad que se encuentre destacada promocionalmente'); 
                return false;
            }else{
                return true;
            }
        }
        // for discarded
        function setDiscarded(userId,propertyId, destacado){
            if(destacado == 'si'){
                alert('No puedes descartar / ocultar una propiedad que se encuentre destacada promocionalmente'); 
                return false;
            }else{
                $('#loading_locale-m').show();
                $('#loading_locale-m'+propertyId).show();
                $('#loading_dis_success').hide();

                $.getJSON(__JSON+"?action=set_dis&user_id="+userId+"&property_id="+propertyId, function(response) { 
                    $('#loading_locale-m').hide();
                    $('#loading_locale-m'+propertyId).hide();
                    $('#loading_dis_success').show();
                    if(response == 'dis_added'){
                        $('#'+propertyId).hide();
                       // $('#addToDiscarded').addClass('bookmark-added');
                        $('#addToDiscarded').addClass('bookmark-addedDisD');
                        $('#loading_dis_success').text('Success!');
                    }
                    if(response == 'dis_removed'){
                        $('#'+propertyId).hide();
                       // $('#addToDiscarded').removeClass('bookmark-added');
                        $('#addToDiscarded').removeClass('bookmark-addedDisD');
                        $('#loading_dis_success').text('Removed!');
                    }
                    //console.log(response);
                }); 
            }
        }
        
        function setDiscardedProjects(userId,projectId, destacado){
            if(destacado == 'si'){
                alert('No puedes descartar / ocultar una propiedad que se encuentre destacada promocionalmente'); 
                return false;
            }else{
                $('#loading_locale-m').show();
                $('#loading_locale-m'+projectId).show();
                $('.loading_locale-m'+projectId).show();
                $('#loading_fav_success').hide();

                $.getJSON(__JSON+"?action=set_dis_property&user_id="+userId+"&project_id="+projectId, function(response) { 
                    $('#loading_locale-m').hide();
                    $('#loading_locale-m'+projectId).hide();
                    $('.loading_locale-m'+projectId).hide();
                    $('#loading_dis_success').show();
                    if(response == 'dis_added'){
                        $('.'+projectId).hide();
                        $('#addToDiscarded').addClass('bookmark-addedDisD');
                        $('#loading_dis_success').text('Success!');
                    }
                    if(response == 'dis_removed'){
                        $('.'+projectId).hide();
                        $('#addToDiscarded').removeClass('bookmark-addedDisD');
                        $('#loading_dis_success').text('Removed!');
                    }

                    //console.log(response);
                });  
           }
        }
        
        function setDiscardedList(userId,propertyId){
            $('#loading_locale-m'+propertyId).show();
           // $('#loading_fav_success'+propertyId).hide();  
            $.getJSON(__JSON+"?action=set_dis&user_id="+userId+"&property_id="+propertyId, function(response) { 
                $('.removeItem'+propertyId).hide();
                //location.reload();
                //console.log(response);
            });     
        }
        function setDiscardedListProjects(userId,projectId){
            $('#loading_locale-m'+projectId).show();
           // $('#loading_fav_success'+projectId).hide();  
            $.getJSON(__JSON+"?action=set_dis_property&user_id="+userId+"&project_id="+projectId, function(response) { 
                //location.reload();
                $('.removeItem'+projectId).hide();
                //console.log(response);
            });     
        }
        
        // login pop
        $(function () {
        $("#dialog").dialog({
            modal: true,
            autoOpen: false,
            title: "Registrate o inicia sesión",
            width: 420,
            height: 380
        });
//        $(".FvLoginShow").click(function () {
//            $('#dialog').dialog('open');
//            $(".FvLoginShow").addClass('remove-bookmark');
//            $('.ui-dialog-titlebar-close').text('x');
//        });
        
    });
//    $('.ui-dialog-titlebar-close').click(function(){
//        alert();
//        $('#dialog').hide();
//    });
    
    var randomString = function(length) {
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        for(var i = 0; i < length; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return text;
    }
    var randomStringSimple = function(length) {
    var text_s = "";
    var possible_s = "abcdefghijklmnopqrstuvwxyz";
        for(var i = 0; i < length; i++) {
            text_s += possible_s.charAt(Math.floor(Math.random() * possible_s.length));
        }
        return text_s;
    }
    
    function openPopUp(itemId,itemType,fs, destacado) {
        
        if(destacado == 'si' && fs == 'dis'){
                alert('No puedes descartar / ocultar una propiedad que se encuentre destacada promocionalmente'); 
                return false;
            }else{
            
            $('#dialog').dialog('open');
            $(".FvLoginShow").addClass('remove-bookmark');
            $('.ui-dialog-titlebar-close').text('x');
            $('#itemId').val(itemId);
            $('#itemType').val(itemType);
            $('#itemId2').val(itemId);
            $('#itemType2').val(itemType);
            $('#itemProcess').val(fs);
            $('#itemProcess2').val(fs);
            $('#loginformF').show();   
            $('#loginformF2').hide();  
            $("#loginformF #button-sign").css("display", "block");
            $("#loginformF #loading").css("display", "none");
            $("#loginformF #instruction").css("display", "none");
            $("#loginformF #instructionDis").css("display", "none");
            $('#needActivation').hide();
            $('#continueButtonF1').hide();
            
            // pass
            var pass = randomString(10);
            var uname = 'doomos_user_'+randomStringSimple(5);
            $('#pass-one').val(pass);
            $('#pass-two').val(pass);
            $('#username_auto').val(uname);
            
            var ItemDataType = {id: itemId, type: itemType, operation: fs};
            sessionStorage.setItem('ItemDataTypeData', JSON.stringify(ItemDataType));
        }
    }
    function openPopUp(itemId,itemType,fs, destacado) {
        
        if(destacado == 'si' && fs == 'dis'){
                alert('No puedes descartar / ocultar una propiedad que se encuentre destacada promocionalmente'); 
                return false;
            }else{
            
//            $('#dialogn').dialog('open');
            $('#dialogn').modal('show');
            $(".FvLoginShow").addClass('remove-bookmark');
            $('.ui-dialog-titlebar-close').text('x');
            $('#itemId').val(itemId);
            $('#itemType').val(itemType);
            $('#itemId2').val(itemId);
            $('#itemType2').val(itemType);
            $('#itemProcess').val(fs);
            $('#itemProcess2').val(fs);
            $('#loginformF').show();   
            $('#loginformF2').hide();  
            $("#loginformF #button-sign").css("display", "block");
            $("#loginformF #loading").css("display", "none");
            $("#loginformF #instruction").css("display", "none");
            $("#loginformF #instructionDis").css("display", "none");
            $('#needActivation').hide();
            $('#continueButtonF1').hide();
            
            // pass
            var pass = randomString(10);
            var uname = 'doomos_user_'+randomStringSimple(5);
            $('#pass-one').val(pass);
            $('#pass-two').val(pass);
            $('#username_auto').val(uname);
            
            var ItemDataType = {id: itemId, type: itemType, operation: fs};
            sessionStorage.setItem('ItemDataTypeData', JSON.stringify(ItemDataType));
        }
    }
    
    // Process for fcebook login
    
    var userData = JSON.parse(sessionStorage.getItem('userId'));
    if(userData !== null){
        //alert('user id generated');
        // alert('userdata->'+userData);
        var dataS = JSON.parse(sessionStorage.getItem('ItemDataTypeData'));
        var searchDataS = JSON.parse(sessionStorage.getItem('searchAllData'));
        if(dataS !== null){
            //alert('item data found');
                var httpReferer = document.referrer;
            //    alert('refer'+httpReferer);
//                if(httpReferer.indexOf('/user') != '-1'){
               //     alert('proces will done');
                    var ajax_link;
                    if(dataS.type == 'property'){
                        if(dataS.operation == 'fav'){
                            ajax_link = __JSON+"?action=set_fav_fb&user_id="+userData+"&property_id="+dataS.id;
                        }
                        if(dataS.operation == 'dis'){
                            ajax_link = __JSON+"?action=set_dis_fb&user_id="+userData+"&property_id="+dataS.id;
                        }
                    } else {
                        if(dataS.operation == 'fav'){
                            ajax_link = __JSON+"?action=set_fav_property_fb&user_id="+userData+"&project_id="+dataS.id;
                        }
                        if(dataS.operation == 'dis'){
                            ajax_link = __JSON+"?action=set_dis_property_fb&user_id="+userData+"&project_id="+dataS.id;
                        }
                    }
                   // alert('link-'+ajax_link);
                $.getJSON(ajax_link, function(response) {
                                    //console.log(response);
                                        if(response){
                                            sessionStorage.removeItem('ItemDataTypeData');
                                            sessionStorage.removeItem('userId');
                                            location.reload();
                                        }
                                    });
//                                }
                            }
        if(searchDataS !== null){
           // alert('item data found');
                var httpReferer = document.referrer;
              //  alert('refer'+httpReferer);
//                if(httpReferer.indexOf('/user') != '-1'){
                  //  alert('proces will done');
                    var ajax_link;
                    var sarea = searchDataS.sarea;
                    var slink = searchDataS.link.replace(/\&/g, '--');
                    var sdata = searchDataS.details;
                    var items = searchDataS.items;
                    var email_alert = searchDataS.email_alert;
                    
                            ajax_link = __JSON+"?action=save_search_data&userId="+userData+"&sarea="+sarea+"&slink="+slink+"&items="+items+"&email_alert="+email_alert+"&sdata="+sdata+"&page=slist";
                    
                  //  alert('link-'+ajax_link);
                $.getJSON(ajax_link, function(response) {
                   //console.log(response);
                                    sessionStorage.removeItem('searchAllData');
                                            sessionStorage.removeItem('userId');
                                            location.reload();
                                    });
//                                }
                            }
                        }else{
                           // alert('user id not generated');
                            //consoloe.log('userdata not found');
                        }
    
    //ATPL Login
    
    
    
     if($("#loginformF").exists()){
        $("#loginformF").submit(function(e){
            $("#loginformF #button-sign").css("display", "none");
            $("#loginformF #loading").css("display", "block");
            $("#loginformF #login-alert-fail").css("display", "none");
            $("#loginformF #login-alert-success").css("display", "none");
//alert(__JSON+"?action=user-login-check&"+$(this).serialize().split("#").join("%23"));

               $.getJSON(__JSON+"?action=user-email-check&"+$(this).serialize().split("#").join("%23"), function(response) { 
               
                if(response == 'no'){
                   /* POPUP LOGIN/REGISTER */
                   $.getJSON(__JSON+"?action=registro_particular_popup&"+$("#loginformF").serialize(), function(response) {
                       $("#loginformF #loading").css("display", "none");
                       $("#loginformF #button-sign").css("display", "none");
                       //console.log(response); return false;
                       if(response.confirm_user_id){
                       var userId = response.confirm_user_id;
                        }else{
                          var userId = '';  
                        }
                       if(response.status == 'needActivation'){
                          $('#needActivation').show();
                       }else{
                            var userArray = $('#loginformF').serializeArray();
                            var userData = {};
                            $(userArray).each(function(i, field){
                            userData[field.name] = field.value;
                            });
                            //console.log(userData);
                            var propertyId = userData['itemId'];
                            //alert("?action=set_fav_popup&user_id="+userId+"&property_id="+propertyId); 
                            // inser into fav/dis
                           // { itemId: "519192", itemType: "property", itemProcess: "fav", email: "parth@amarinfotech.com", name: "doomos_user_2590", "pass-1": "doomos_pass_2590", "pass-2": "doomos_pass_2590", "g-recaptcha-response": "-" }
                           if(userData['itemProcess'] == 'fav'){
                              if(userData['itemType'] == 'property'){ 
                                $.getJSON(__JSON+"?action=set_fav_popup&user_id="+userId+"&property_id="+propertyId, function(response) {
                                //console.log(response);
                                    if(response){
                                        $('#instruction').show();
                                        $('#continueButtonF1').show();
                                    }
                                });
                              }
                              if(userData['itemType'] == 'project'){ 
                                $.getJSON(__JSON+"?action=set_fav_property_popup&user_id="+userId+"&project_id="+propertyId, function(response) {
                                //console.log(response);
                                    if(response){
                                        $('#instruction').show();
                                        $('#continueButtonF1').show();
                                    }
                                });
                              }
                            }
                            else{
                              if(userData['itemType'] == 'property'){ 
                                $.getJSON(__JSON+"?action=set_dis_popup&user_id="+userId+"&property_id="+propertyId, function(response) {
                                //console.log(response);
                                    if(response){
                                        $('#instructionDis').show();
                                        $('#continueButtonF1').show();
                                    }
                                });
                              }
                              if(userData['itemType'] == 'project'){ 
                                $.getJSON(__JSON+"?action=set_dis_property_popup&user_id="+userId+"&project_id="+propertyId, function(response) {
                                //console.log(response);
                                    if(response){
                                        $('#instructionDis').show();
                                        $('#continueButtonF1').show();
                                    }
                                });
                              }
                            }
                            // inser into fav/dis                         
                           
                       }
                   });
                   /* POPUP LOGIN/REGISTER */
               }
               else{
                   $('#loginformF').hide();
                   $('#loginformF2').show();
                   $('#loginformF2 #userId2').val(response);
                   $('#loginformF2 #usernameF2').val($('#usernameF').val());
                   
               }  
            });
     
            return false;
        });
    }
     if($("#loginformF2").exists()){
        $("#loginformF2").submit(function(e){
            $("#loginformF2 #button-sign").css("display", "none");
            $("#loginformF2 #loading").css("display", "block");
            $("#loginformF2 #login-alert-fail").css("display", "none");
            $("#loginformF2 #login-alert-success").css("display", "none");

            $.getJSON(__JSON+"?action=user-login&"+$(this).serialize().split("#").join("%23"), function(response) { 
                
                if(response["status"] == 200){
                    $('#showPassword').hide();
                    var userArray = $('#loginformF2').serializeArray();
                    var userData = {};
                    $(userArray).each(function(i, field){
                        userData[field.name] = field.value;
                      });
                     if(userData['itemProcess'] == 'fav'){
                        if(userData['itemType'] == 'property'){
                           $.getJSON(__JSON+"?action=set_fav_fb&user_id="+userData['userId']+"&property_id="+userData['itemId'], function(response) { 
                               $("#loginformF2 #button-sign").css("display", "none");
                               $("#loginformF2 #continueButton").css("display", "block");
                           });   
                        }
                        if(userData['itemType'] == 'project'){
                           $.getJSON(__JSON+"?action=set_fav_property_fb&user_id="+userData['userId']+"&project_id="+userData['itemId'], function(response) { 
                               $("#loginformF2 #button-sign").css("display", "none");
                               $("#loginformF2 #continueButton").css("display", "block");
                           });   
                        }
                     }
                     if(userData['itemProcess'] == 'dis'){
                        if(userData['itemType'] == 'property'){
                           $.getJSON(__JSON+"?action=set_dis_fb&user_id="+userData['userId']+"&property_id="+userData['itemId'], function(response) { 
                               $("#loginformF2 #button-sign").css("display", "none");
                               $("#loginformF2 #continueButton").css("display", "block");
                           });   
                        }
                        if(userData['itemType'] == 'project'){
                           $.getJSON(__JSON+"?action=set_dis_property_fb&user_id="+userData['userId']+"&project_id="+userData['itemId'], function(response) { 
                               $("#loginformF2 #button-sign").css("display", "none");
                               $("#loginformF2 #continueButton").css("display", "block");
                           });   
                        }
                     }
                    //location.reload();
                    $("#loginformF2 #loading").css("display", "none");
                    $("#loginformF2 #login-alert-success").css("display", "block");
                }else{
                    $("#loginformF2 #loading").css("display", "none");
                    $("#loginformF2 #login-alert-fail").css("display", "block");
                    $("#loginformF2 #button-sign").css("display", "block");
                }
            });

            return false;
        });
    }
    $("#loginformF2 #continueButton").click(function(e){
        e.preventDefault();
        $(this).hide();
        $("#loginformF2 #login-alert-success").css("display", "block");
        $("#loginformF2 #loading").css("display", "block");
         location.reload();
    });
    $("#loginformF #continueButtonF1").click(function(e){
        e.preventDefault();
        $('#dialog').dialog('close');
        
        
    });
    
    // save search
     $(function () {
         var SaveSearchPopupTitle = 'Guardar búsqueda';
         if(window.location.href.includes("map-vista")){                                                                                                                                                                                                   
             var SaveSearchPopupTitle = 'Recibir alertas de esta zona por email';
         }
         
         
        $("#dialogSaveSearch").dialog({
            modal: true,
            autoOpen: false,
            title: SaveSearchPopupTitle,
            width: 600,
            height: 380
        });
    });
    $('#opensavesearch').hover(function(){
        $('#askforsavesearch').hide();
    });
    function openPopUpSaveSearch(sarea, details, link, items, email_alert) {
        $("#dialogSaveSearchn").modal('show');
        var pass = randomString(10);
            var uname = 'doomos_user_'+randomStringSimple(5);
            $('#saveSearchFormLogin2').hide();
            $('#saveSearchFormLogin').show();
            $('#loadingS').hide();
            $('#button-signS').show();
            $('#pass-oneS').val(pass);
            $('#pass-twoS').val(pass);
            $('#username_autoS').val(uname);
            $('#continueButtonF1S').hide();
            $("#saveSearchFormLogin #instructionS").css("display", "none");
            $('#needActivationS').hide();
            $('#continueButtonF1S').hide();
            var isemailalert = $('#save_search_ealertDmsInput1').val();
            var searchData = {sarea: sarea, details: details, link: link, items: items, email_alert: isemailalert};
            sessionStorage.setItem('searchAllData', JSON.stringify(searchData));
    }
    
    function popup_rnd(){
        $("#popup_rnd").modal('show');
    }
    
    $("#saveSearchForm").submit(function(e){
            $("#loadingSaveSearch").show(); 
            $("#button-sign-save").hide();
            $.getJSON(__JSON+"?action=save_search_data&"+$(this).serialize(), function(response) { 
                    $("#saveSearchForm").hide();
                    $("#showifSaved").show();
                    $("#showifSavedRes").show();
                    $("#strickySavedSearch").hide();
                    $("#opensavesearch").hide();
                    $(".guardSearchatRes").hide();
                    $("#searchSaved").show();
                    $("#saveSearchForm").hide();
                    $("#continueButtonSv").show();
            });
            return false;
        });
    $("#saveSearchFormU").submit(function(e){
            $("#loadingU").show(); 
            $("#button-sign-saveU").hide();
            $.getJSON(__JSON+"?action=save_search_data&"+$(this).serialize(), function(response) {
                location.reload();
            });
            return false;
        });    
        
    $("#continueButtonSv, #continueButtonF1S").click(function(e){
        e.preventDefault();
        //$('#dialogSaveSearch').dialog('close');
    });
    
    $('#continueButton2S').click(function(e){
        e.preventDefault();
        $('#dialogSaveSearch').dialog('close');
        if($("#listParamsForSearch").exists()){
            window.location = $('#listParamsForSearch').attr('href').replace('search', 'map-vista');
        }else{
            location.reload();
        }
         //location.reload();
    });
   
       
    if($("#saveSearchFormLogin").exists()){
        $("#saveSearchFormLogin").submit(function(e){
            $("#saveSearchFormLogin #button-signS").css("display", "none");
            $("#saveSearchFormLogin #loadingS").css("display", "block");
            $("#saveSearchFormLogin #login-alert-failS").css("display", "none");
            $("#saveSearchFormLogin #login-alert-successS").css("display", "none");
//alert(__JSON+"?action=user-login-check&"+$(this).serialize().split("#").join("%23"));

               $.getJSON(__JSON+"?action=user-email-check&"+$(this).serialize().split("#").join("%23"), function(response) { 
               
                if(response == 'no'){
                     $.getJSON(__JSON+"?action=user-confirmr-email-check&"+"email="+$('#saveSearchFormLogin #usernameFS').val(), function(response) {
                       if(response == 'no'){ // create new user
                   /* POPUP LOGIN/REGISTER */
                   $.getJSON(__JSON+"?action=registro_particular_popup&"+$("#saveSearchFormLogin").serialize(), function(response) {
                       $("#saveSearchFormLogin #loadingS").css("display", "none");
                       $("#saveSearchFormLogin #button-signS").css("display", "none");
                       //console.log(response); return false;
                       if(response.confirm_user_id){
                       var userId = response.confirm_user_id;
                        }else{
                          var userId = '';  
                        }
                       if(response.status == 'needActivation'){
                          $('#needActivationS').show();
                       }else{
                           
                           $('#userIdSf').val(userId);
                            var userArray = $('#saveSearchFormLogin').serializeArray();
                            var userData = {};
                            $(userArray).each(function(i, field){
                            userData[field.name] = field.value;
                            });
                            var propertyId = userData['itemId'];
                            //alert("?action=set_fav_popup&user_id="+userId+"&property_id="+propertyId); 
                            // inser into fav/dis
                           // { itemId: "519192", itemType: "property", itemProcess: "fav", email: "parth@amarinfotech.com", name: "doomos_user_2590", "pass-1": "doomos_pass_2590", "pass-2": "doomos_pass_2590", "g-recaptcha-response": "-" }
                           
                                
                                $.getJSON(__JSON+"?action=save_search_data&"+$('#saveSearchFormLogin').serialize(), function(response) {
                                    if(response){
                                        $('#saveSearchFormLogin #instructionS').show();
                                        $('#saveSearchFormLogin #continueButtonF1S').show();
                                    }
                                });
                           
                           
                            // inser into fav/dis                         
                           
                       }
                   });
                   /* POPUP LOGIN/REGISTER */
                        }else{ // save search for confirm usr id
                         $('#userIdSf').val(response);
                            var userArray = $('#saveSearchFormLogin').serializeArray();
                            var userData = {};
                            $(userArray).each(function(i, field){
                            userData[field.name] = field.value;
                            });
                            var propertyId = userData['itemId'];
                                $.getJSON(__JSON+"?action=save_search_data&"+$('#saveSearchFormLogin').serialize(), function(response) {
                                    if(response){
                                        $('#instructionS').show();
                                        $('#continueButtonF1S').show();
                                        $("#saveSearchFormLogin #loadingS").css("display", "none");
                                    }
                                });
                         
                         }
                     });
               }
               else{
                   $('#saveSearchFormLogin').hide();
                   $('#saveSearchFormLogin2').show();
                   $('#saveSearchFormLogin2 #userId2S').val(response);
                   $('#saveSearchFormLogin2 #usernameF2S').val($('#usernameFS').val());
                   
               }  
            });
     
            return false;
        });
    }
    
    if($("#saveSearchFormLogin2").exists()){
        $("#saveSearchFormLogin2").submit(function(e){
            $("#saveSearchFormLogin2 #button-sign2S").css("display", "none");
            $("#saveSearchFormLogin2 #loading2S").css("display", "block");
            $("#saveSearchFormLogin2 #login-alert-failS2").css("display", "none");
            $("#saveSearchFormLogin2 #login-alert-successS2").css("display", "none");

            $.getJSON(__JSON+"?action=user-login&"+$(this).serialize().split("#").join("%23"), function(response) { 
                
                if(response["status"] == 200){
                    $('#showPassword2S').hide();
                    var userArray = $('#saveSearchFormLogin2').serializeArray();
                    var userData = {};
                    $(userArray).each(function(i, field){
                        userData[field.name] = field.value;
                      });
                     
                    $.getJSON(__JSON+"?action=save_search_data&"+$('#saveSearchFormLogin2').serialize(), function(response) { 
                               $("#saveSearchFormLogin2 #button-sign2S").css("display", "none");
                               $("#saveSearchFormLogin2 #continueButton2S").css("display", "block");
                           });  
                    
                    //location.reload();
                    $("#saveSearchFormLogin2 #loading2S").css("display", "none");
                    $("#saveSearchFormLogin2 #login-alert-successS2").css("display", "block");
                    $("#saveSearchFormLogin2 > div:nth-child(5)").hide();
                    $("#saveSearchFormLogin2 #passworField").hide();
                    $("#saveSearchFormLogin2 > div:nth-child(7)").hide();
                }else{
                    $("#saveSearchFormLogin2 #loading2S").css("display", "none");
                    $("#saveSearchFormLogin2 #login-alert-failS2").css("display", "block");
                    $("#saveSearchFormLogin2 #button-sign2S").css("display", "block");
                }
            });

            return false;
        });
    }
    // edit search
     $(function () {
        $("#dialogEditSearch").dialog({
            modal: true,
            autoOpen: false,
            title: "Poner nombre a tu búsqueda",
            width: 400,
            height: 200
        });
    });
    function openPopUpEditSearch(ssid, sarea, slink, sdata) {
        $('#button-contd-saveUEdit').hide();
        $('#button-sign-saveUEdit').show();
        $("#loadingUEdit").hide(); 
        var areaData = $('#areaname'+ssid).text();
        
        $('#dialogEditSearchn').modal('show');
        $('.ui-dialog-titlebar-close').text('x');
        $('#saveSearchId').val(ssid);
        $('#sareaSE').val(areaData);
        $('#slinkSE').val(slink);
        $('#sdataSE').val(sdata);
    }
 
    
    if($("#saveSearchFormUEdit").exists()){
        $("#saveSearchFormUEdit").submit(function(e){
                $("#loadingUEdit").show(); 
                $("#button-sign-saveUEdit").hide();
                $.getJSON(__JSON+"?action=update_search_data&"+$(this).serialize(), function(response) {
                    //console.log(response);
                    var updatedArea = response;
                    var areadata = $('#saveSearchId').val();
                    //console.log(updatedArea);
                    //console.log(areadata);
                    $('#areaname'+areadata).text('');
                    $('#areaname'+areadata).text(updatedArea);
                    $('#button-contd-saveUEdit').show();
                    $("#loadingUEdit").hide(); 
                });
                return false;
            });
    }
    $('#button-contd-saveUEdit').click(function(e){
        e.preventDefault();
        
        $('')
        $('#dialogEditSearch').dialog('close');
       //  location.reload();
    });
    
    // delete search
    $(function () {
        $("#dialogDeleteSearch").dialog({
            modal: true,
            autoOpen: false,
            title: "Confirma que quieres borrar la búsqueda",
            width: 400,
            height: 200
        });
    });
    
    function openPopUpDeleteSearch(ssid) {
        $('#button-sign-saveUDelete').show();
        $("#loadingUDelete").hide();   
        $('#dialogDeleteSearchn').modal('show');
        $('.ui-dialog-titlebar-close').text('x');
        $('#saveSearchIdD').val(ssid);
        $("#deleteFormClose").show();
    }
     if($("#saveSearchFormUDelete").exists()){
        $("#saveSearchFormUDelete").submit(function(e){
                $("#loadingUDelete").show(); 
                $("#button-sign-saveUDelete").hide();
                $("#deleteFormClose").hide();
                $.getJSON(__JSON+"?action=delete_search_data&"+$(this).serialize(), function(response) {
                    //console.log(response);
                    $("#loadingUDelete").hide(); 
                    $('#dialogDeleteSearchn').modal('hide');
                    var areadata = $('#saveSearchIdD').val();
                    $('#searchItemId'+areadata).hide();
                });
                return false;
            });
    }
    
    $('#deleteFormClose').click(function(e){
        $('#dialogDeleteSearch').dialog('close');
        e.preventDefault();
    });
    
    
    $(document).on('ifChecked','#save_search_ealertDms', function(e){
                        $('#save_search_ealertDmsInput1').val('1');
                        $('#save_search_ealertDmsInput2').val('1');
                        $('#save_search_ealertDmsInput3').val('1');
		});
    $(document).on('ifUnchecked','#save_search_ealertDms', function(e){
                        $('#save_search_ealertDmsInput1').val('0');
                        $('#save_search_ealertDmsInput2').val('0');
                        $('#save_search_ealertDmsInput3').val('0');
		});
    
   $('.dropdown-menu').on('click', function(e) {
            if($(this).hasClass('dropdown-menu-form')) {
              e.stopPropagation();
            }
          });
          
   if($('#mapDiv').exists()){
       setTimeout(function() {
       $("#map_popup").modal('show');
   },3000); 
   }
   
   
   // home subscribe
   function openPopUpSaveSearchSb() {
       if($('#email').val() == '' || $('#location').attr("data-value") == '-1'){
           alert('Por favor ingrese todos los datos');
           return false;
       }
       $("#dialogSaveSearchn").modal('show');
        //$('#dialogSaveSearch').dialog('open');
        $('.ui-dialog-titlebar-close').text('x');
        //asign data 
        $('#usernameFS').val($('#email').val());
        $('#sarea1,#sarea2,#sarea3').val($('#location').val());
        $('#slink1,#slink2,#slink3').val(window.location.origin+'/search/?locale='+$('#location').attr("data-value")+'&operation='+$('#tipo').val()+'&types='+$('#tipo_property').val());
        
        $('#id_localidad1, #id_localidad2, #id_localidad3').val($('#location').attr("data-value"));
        
        $('#id_tipo_operacion1, #id_tipo_operacion2, #id_tipo_operacion3').val($('#tipo').val());
        
        $('#id_tipo_propiedad1, #id_tipo_propiedad2, #id_tipo_propiedad3').val($('#tipo_property').val());
        
       var pass = randomString(10);
            var uname = 'doomos_user_'+randomStringSimple(5);
            $('#saveSearchFormLogin2').hide();
            $('#saveSearchFormLogin').show();
            $('#loadingS').hide();
            $('#button-signS').show();
            $('#pass-oneS').val(pass);
            $('#pass-twoS').val(pass);
            $('#username_autoS').val(uname);
            $('#continueButtonF1S').hide();
            $("#saveSearchFormLogin #instructionS").css("display", "none");
            $('#needActivationS').hide();
            $('#continueButtonF1S').hide();
          //  var isemailalert = $('#save_search_ealertDmsInput1').val();
           // var searchData = {sarea: sarea, details: details, link: link, items: items, email_alert: isemailalert};
           // sessionStorage.setItem('searchAllData', JSON.stringify(searchData));
    }
    
    // ATPL 2018 - UNSUBSCRIBE
var __JSON_USER = "/user/json/";
var error = 0;

$(document).on('ifChecked','.saved-search-alert', function(e){
    var savedSeachLimitAlert = $('#savedSeachLimitAlert').val();
			if(error == 0){
				$this = $(this);
				$.getJSON(__JSON_USER+"?action=saved_search_alert&id="+$this.attr("data-value")+"&process=add", function(response) { 
                                    if(response['status'] == 200) {
					setTimeout(function(){ $("#chk_save_search_"+$this.attr("data-value")).iCheck('check');}, 1);
                                    }
                                    else if(response['status'] == 401) {
					alert('Has alcanzado el límite máximo de servicios de alertas por email ('+savedSeachLimitAlert+'). Para activar las alertas por email para la búsqueda que acabas de añadir debes desactivar alguna de las que tienes actualmente activas.');
                                        setTimeout(function(){ $("#chk_save_search_"+$this.attr("data-value")).iCheck('uncheck');}, 1);
                                    }
                                    else{
                                        alert('400');
                                        setTimeout(function(){ $("#chk_save_search_"+$this.attr("data-value")).iCheck('uncheck');}, 1);
                                    }
				});
			}
			error = 0;
		});
$(document).on('ifUnchecked','.saved-search-alert', function(e){
			if(error == 0){
				$this = $(this);
				$.getJSON(__JSON_USER+"?action=saved_search_alert&id="+$this.attr("data-value")+"&process=remove", function(response) { 
                                    if(response['status'] == 200) {
					setTimeout(function(){ $("#chk_save_search_"+$this.attr("data-value")).iCheck('uncheck');}, 1);
                                    }else{
                                        alert('400');
                                        setTimeout(function(){ $("#chk_save_search_"+$this.attr("data-value")).iCheck('check');}, 1);
                                    }
				});
			}
			error = 0;
		});
// REMOVE DUPLICATES FROM URL
function unique(list) {
    var result = [];
    $.each(list, function (i, e) {
        if ($.inArray(e, result) == -1)
            result.push(e);
    });
    return result;
}
function removeDuplicatesFromUrl(link) {


    var url = link;

    var urlsep = url.split("/");
    var lurl = urlsep[urlsep.length-1];

    if(lurl == "" || lurl == "search" || lurl == "map-vista"){
        return url;
    }

    var data = url.split('?'); // splitting url
    var data2 = data[1]; // main url
    var data22 = data[0]; // url params

    if(typeof data2 != 'undefined'){
        var data3 = data2.split('&'); // params array
    }else{
        return url;
    }
    

    var data4 = []; // param array splitted
    var data5 = []; // param values only
    for (var i = 0; i < data3.length; i++) {
        data5.push(data3[i].split('=')[0]);
        data4.push(data3[i].split('='));
    }
    var data6 = unique(data5); // unique values
    //console.log(data4);
    //console.log(data6);

    function getvalue(array, element) { //get value of param
        var array = array.reverse();
        for (var i = 0; i < array.length; i++) {
            if (array[i][0] == element) {
                return array[i][1];
            }
        }
    }
    //var data7 = getvalue(data4, 'operation');
//console.log(data7);
    var newstring = '';
    for (var i = 0; i < data6.length; i++) { // construct url with removed duplicates and with latest values
        if (i == (data6.length - 1)) {
            newstring += data6[i] + '=' + getvalue(data4, data6[i]);
        } else {
            newstring += data6[i] + '=' + getvalue(data4, data6[i]) + '&';
        }
    }
    return data22 + '?' + newstring;
}
    
    //alert(removeDuplicatesFromUrl("http://dev.doomos.cl/map-vista/?locale=150&operation=2&types=2&operation=3&types=2"));
  // alert(data22+'?'+newstring);
// EXIT POPUP DEMANDS
if($("#contact_emp_rel_d").exists()){


        $("#contact_emp_rel_d #region").change(function(e){
            show_locale_parent("contact_emp_rel_d", "comuna", $(this).val());
        });

        $("#contact_emp_rel_d #comuna").change(function(e){
            if($("#contact_emp_rel_d #txtsub").val() == "1"){
                $("#contact_emp_rel_d #message").val("Buenos días. \nEstoy buscando una propiedad para pago con subsidio en "+$("#contact_emp_rel_locale #comuna option:selected").text()+" "+$("#contact_emp_rel_locale #region option:selected").text());
            }
        });

        var errores_emp_rel = [];
        $("#contact_emp_rel_d").submit(function(e){
            $('#contact_emp_rel_d #dimands_content').hide();
            $("#contact_emp_rel_d #form_content").css("display","none");
            $("#contact_emp_rel_d #form-contact-emp-rel").css("display","none");
            $("#contact_emp_rel_d #loading-form").css("display","block");
            $("#contact_emp_rel_d #send-ok").css("display","none");
            $("#contact_emp_rel_d #send-ok-cerrar").css("display","none");
            //$("#emp_loc_popup #send-fail").css("display","none");

            if(errores_emp_rel.length > 0){
                for(i=0;i<errores_emp_rel.length;i++){
                    $("#contact_emp_rel_d #"+errores_emp_rel[i]).parent().removeClass("has-error");
                }
            }
           
     var d_email = $('#d_email').val();
     var d_phone = $('#d_phone').val();
     var d_userid = '';
     if(d_email == '' || d_phone == ''){
         alert('Por favor inserte todos los campos');
         return false;
     }
     if($('#d_userid').val() != ''){ // USER LOGGED IN
         $.getJSON(__JSON+"?action=contact-emp-rel-locale_d&"+$(this).serialize(), function(response) {
                //console.log(response);
                if(response["status"] == 200){
                    $("#contact_emp_rel_d #form_content").css("display","none");
                    $("#contact_emp_rel_d #form_content2").css("display","none");
                    $("#demandsTitle").css("display","none");
                    $("#contact_emp_rel_d #send-ok").css("display","block");
                    $("#contact_emp_rel_d #send-ok-cerrar").css("display","block");
                    $("#contact_emp_rel_d #send-fail").css("display","none");
                    ga('send', 'pageview', "/contactoexitpopup");
                    ga('send', 'pageview', "/contactosTotales");

//                    setTimeout(function() {
//                            $("#emp_loc_popup").modal('hide');
//                        }, 5000);
                }else{
                    $("#contact_emp_rel_d #form_content").css("display","none");
                    $("#contact_emp_rel_d #form_content2").css("display","none");
                    $("#contact_emp_rel_d #send-ok").css("display","none");
                    $("#contact_emp_rel_d #send-ok-cerrar").css("display","none");
                    $("#contact_emp_rel_d #send-fail").css("display","block");
                    ga('send', 'pageview', "/contactoexitpopup");
                    ga('send', 'pageview', "/contactosTotales");

                    setTimeout(function() {
                            $("#emp_loc_popup").modal('hide');
                        }, 5000);
                }
            });
            return false;
         
     }else{ // USER NOT LOGGED
         /* CHECK EMAIL EXIST S*/
            $.getJSON(__JSON+"?action=user-email-check&email="+d_email, function(response) {  
                if(response == 'no'){
                   $.getJSON(__JSON+"?action=contact-emp-rel-locale_d&"+$("#contact_emp_rel_d").serialize(), function(response) {
                       
                        if(response["status"] == 200){
                            $("#contact_emp_rel_d #form_content").css("display","none");
                            $("#contact_emp_rel_d #form_content2").css("display","none");
                            $("#demandsTitle").css("display","none");
                            $("#contact_emp_rel_d #send-ok").css("display","block");
                            $("#contact_emp_rel_d #send-ok-cerrar").css("display","block");
                            $("#contact_emp_rel_d #send-fail").css("display","nono");
                            ga('send', 'pageview', "/contactoexitpopup");
                            ga('send', 'pageview', "/contactosTotales");

//                            setTimeout(function() {
//                                    $("#emp_loc_popup").modal('hide');
//                                }, 5000);
                        }else{
                            $("#contact_emp_rel_d #form_content").css("display","none");
                            $("#contact_emp_rel_d #form_content2").css("display","none");
                            $("#contact_emp_rel_d #send-ok").css("display","none");
                            $("#contact_emp_rel_d #send-ok-cerrar").css("display","none");
                            $("#contact_emp_rel_d #send-fail").css("display","block");
                            ga('send', 'pageview', "/contactoexitpopup");
                            ga('send', 'pageview', "/contactosTotales");

                            setTimeout(function() {
                                    $("#emp_loc_popup").modal('hide');
                                }, 5000);
                        }
                        });
                   
                }
                else{ //Exists
                       $('#contact_emp_rel_d #d_userid').val(response);
                       $.getJSON(__JSON+"?action=contact-emp-rel-locale_d&"+$("#contact_emp_rel_d").serialize(), function(response) {
                        if(response["status"] == 200){
                            $("#contact_emp_rel_d #form_content").css("display","none");
                            $("#contact_emp_rel_d #form_content2").css("display","none");
                            $("#demandsTitle").css("display","none");
                            $("#contact_emp_rel_d #send-ok").css("display","block");
                            $("#contact_emp_rel_d #send-ok-cerrar").css("display","block");
                            $("#contact_emp_rel_d #send-fail").css("display","nono");
                            ga('send', 'pageview', "/contactoexitpopup");
                            ga('send', 'pageview', "/contactosTotales");

//                            setTimeout(function() {
//                                    $("#emp_loc_popup").modal('hide');
//                                }, 5000);
                        }else{
                            $("#contact_emp_rel_d #form_content").css("display","none");
                            $("#contact_emp_rel_d #form_content2").css("display","none");
                            $("#contact_emp_rel_d #send-ok").css("display","none");
                            $("#contact_emp_rel_d #send-ok-cerrar").css("display","none");
                            $("#contact_emp_rel_d #send-fail").css("display","block");
                            ga('send', 'pageview', "/contactoexitpopup");
                            ga('send', 'pageview', "/contactosTotales");

                            setTimeout(function() {
                                    $("#emp_loc_popup").modal('hide');
                                }, 5000);
                        }
                });
                return false;
                }
               
           });
           return false;
            /* CHECK EMAIL EXIST E*/
     }
            
            
            //console.log($(this).serialize()); return false;
            
        });

    }

// $('#showDemands').on('ifChecked', function(event){
//     var d_email = $('#contact_emp_rel #email').val();
//     var d_phone = $('#contact_emp_rel #phone').val();
//     
//     
//     var d_userid = '';
//     if(d_email == '' || d_phone == ''){
//         var cual= this;
//            setTimeout(function(){ $(cual).iCheck('uncheck');}, 1);
//     }
//     if(d_email == ''){
//         $('#contact_emp_rel #email').parent().addClass('has-error');
//         return false;
//     }else{$('#contact_emp_rel #email').parent().removeClass('has-error');}
//     
//     if(d_phone == ''){
//         $('#contact_emp_rel #phone').parent().addClass('has-error');
//         return false;
//     }else{$('#contact_emp_rel #phone').parent().removeClass('has-error');}
//     
//     
//         
//     
//     $('#contact_emp_rel_d #d_email').val(d_email);
//     $('#contact_emp_rel_d #d_phone').val(d_phone);
//     $('#contact_emp_rel').hide();
//     $('#contact_emp_rel_d').show();
//     
//     if($('#d_userid').val() != ''){ // logged in
//         $('#demandsTitle').html('También es importante que complete la siguiente información que nos ayudará a ayudarlo de manera más efectiva.');
//     }else{ // not logged in
//         $.getJSON(__JSON+"?action=user-email-check&email="+d_email, function(response) {  
//                if(response == 'no'){ // register new
//                        /* REGISTER NEW USER */
//                         var pass = randomString(10);
//                         var uname = 'doomos_user_'+randomStringSimple(5);
//                    $.getJSON(__JSON+"?action=registro_particular_popup&"+"name="+uname+"&pass-1="+pass+"&pass-2="+pass+"&email="+d_email, function(response) {
//                       console.log(response);
//                       if(response['confirm_user_id'] !== null){
//                        $('#contact_emp_rel_d #d_user_confirm_id').val(response['confirm_user_id']);
//                       }
//                        /* REGISTER NEW USER */   
//                    });
//                    $('#demandsTitle').html('Felicitaciones: ha sido registrado en nuestro sistema con su correo electrónico, acceda a su bandeja de entrada para activar su cuenta; También es importante que complete la siguiente información que nos ayudará a ayudarlo de manera más efectiva.');
//                }
//                else{ // exists
//                    $('#demandsTitle').html('Hemos encontrado su email en nuestro sistema y hemos asociado su demanda; También es importante que complete la siguiente información que nos ayudará a ayudarlo de manera más efectiva.');
//                }
//         });
//    }
//     var d_operation = $('#d_operation').val();
//                   //$('#form_content').hide();
//                   if(d_operation == 1 || d_operation == 3 || d_operation == 4 || d_operation == 7){
//                       $('#dimands_content').show();
//                       $('#demands_rent').show();
//                   }else{
//                       $('#dimands_content ').show();
//                       $('#demands_rent').hide();
//                   }
//});
//                
// $('#showDemands').on('ifUnchecked', function(event){
//                 $('#dimands_content').hide();
//                 $('#form_content').show();
//                });

function openPopUpDeleteDemand(ssid) {
        $('#button-sign-saveUDelete').show();
        $("#loadingUDelete").hide();   
        $('#dialogDeleteDemand').modal('show');
        $('.ui-dialog-titlebar-close').text('x');
        $('#demandId').val(ssid);
        $("#deleteFormClose").show();
    }
     if($("#DemandFormUDelete").exists()){
        $("#DemandFormUDelete").submit(function(e){
                $("#loadingUDelete").show(); 
                $("#button-sign-saveUDelete").hide();
                $("#deleteFormClose").hide();
                $.getJSON(__JSON+"?action=delete_demanda_data&"+$(this).serialize(), function(response) {
                    //console.log(response);
                    $("#loadingUDelete").hide(); 
                     $('#dialogDeleteDemand').modal('hide');
                    var dmndId = $('#demandId').val();
                    $('#demand'+dmndId).hide();
                });
                return false;
            });
    }
    
    // demands buscar
    $('#strickySavedSearch').click(function(){
        $( "#opensavesearch" ).trigger( "click" );
    });
    
    
    function buscard_demand(uemail, demand){
        $("#buscard-demand").modal("show");   
        $('#demand_user_email').val(uemail);
        var demandTxt = "Hola he visto tu demanda de "+'"'+demand+'"'+" en doomos, y puedo ayudarte.";
        $('#demand_message').val(demandTxt);
        $("#contact-buscar-demand #send-fail, #contact-buscar-demand #send-ok, #contact-buscar-demand #loading-form").css("display","none");
        $("#contact-buscar-demand #form-contact-reply-submit-project").css("display","block");
        return false;
    }
    
    $("#contact-buscar-demand").submit(function(e){
        $this = $(this);
        $("#contact-buscar-demand #send-fail").css("display","none");
        $("#contact-buscar-demand #form-contact-reply-submit-project").css("display","none");
        $("#contact-buscar-demand #loading-form").css("display","block");

        $.getJSON(__JSON+"?action=contact_buscar_demand&"+$this.serialize(), function(response) { 
            if(response["status"] == 200){
                $("#contact-buscar-demand #send-ok").css("display","block");
                $("#contact-buscar-demand #form-content").css("display","none");
            }else{
                $("#contact-buscar-demand #send-fail").css("display","block");
                $("#contact-buscar-demand #form-contact-reply-submit-project").css("display","block");
                $("#contact-buscar-demand #loading-form").css("display","none");
            }
        });
        return false;
    });